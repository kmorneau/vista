<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>T</title><style>*{box-sizing:border-box;}:root{--arturo-primary:#f2c230;--arturo-ink:#141414;--arturo-muted:#4b4b4b;--arturo-bg:#f7f6f1;--arturo-panel:#ffffff;--arturo-border:#ded6c2;--arturo-focus:#1f1f1f;}body{font-family:'IBM Plex Sans','Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;margin:0;background:var(--arturo-bg);color:var(--arturo-ink);}button,input,select,textarea{font:inherit;}button{cursor:pointer;}.vista-button-icon{vertical-align:middle;margin-right:6px;height:1.2em;width:1.2em;display:inline-flex;align-items:center;justify-content:center;}.vista-button-icon img{height:100%;width:100%;display:block;}.vista-button-icon svg{height:100%;width:100%;display:block;}.vista-button-icon svg *{fill:currentColor !important;stroke:currentColor !important;}a{color:inherit;}.vista-app-header{position:sticky;top:0;z-index:1000;background:var(--arturo-primary);color:var(--arturo-ink);border-bottom:2px solid var(--arturo-ink);}.vista-app-header-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;}.vista-app-logo{height:28px;width:auto;display:block;}.vista-app-mark{font-weight:700;font-size:15px;letter-spacing:0.5px;}.vista-app-title{font-weight:700;font-size:18px;}.vista-app-footer{position:relative;z-index:1000;background:var(--arturo-primary);color:var(--arturo-ink);border-top:1px solid var(--arturo-ink);padding:8px 16px;font-size:12px;opacity:0.85;}.vista-app-footer-inner{max-width:1100px;margin:0 auto;text-align:center;}.vista-app-author{font-weight:600;}.vista-app-date{opacity:0.8;}.vista-auth-header-controls{display:flex;align-items:center;gap:8px;margin-left:auto;}.vista-auth-header-btn{background:transparent;border:1px solid var(--arturo-ink);color:var(--arturo-ink);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:13px;transition:all 0.2s ease;}.vista-auth-header-btn:hover{background:var(--arturo-ink);color:var(--arturo-primary);}.vista-auth-header-btn-primary{background:transparent;border:1px solid var(--arturo-ink);color:var(--arturo-ink);}.vista-auth-header-btn-primary:hover{background:var(--arturo-ink);color:var(--arturo-primary);opacity:1;}.vista-auth-header-user{font-size:13px;opacity:0.9;}.vista-auth-container{max-width:400px;margin:40px auto;}.vista-app-mark{font-weight:800;letter-spacing:0.2em;text-transform:uppercase;}.vista-app-title{font-size:18px;font-weight:700;}.vista-app-body{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:60px;}.vista-row,.vista-layout-across{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}.vista-col,.vista-layout-below{display:flex;flex-direction:column;gap:8px;}.vista-layout-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}.vista-box{border:1px solid var(--arturo-border);background:var(--arturo-panel);border-radius:10px;padding:12px;}.vista-panel{border:1px solid var(--arturo-border);background:var(--arturo-panel);border-radius:12px;overflow:hidden;}.vista-panel-title{padding:8px 10px;font-weight:700;background:var(--arturo-primary);border-bottom:1px solid var(--arturo-ink);}.vista-panel-body{padding:12px;}.vista-details{border:1px solid var(--arturo-border);background:var(--arturo-panel);border-radius:10px;padding:8px 10px;}.vista-summary{cursor:pointer;font-weight:700;}.vista-details-body{padding-top:8px;}.vista-dialog{border:1px solid var(--arturo-border);border-radius:12px;background:var(--arturo-panel);padding:16px;max-width:min(92vw,560px);}.vista-grid{gap:8px;}.vista-spacer{min-height:8px;min-width:8px;}.vista-table{width:100%;border-collapse:collapse;background:var(--arturo-panel);}.vista-table th,.vista-table td{border:1px solid var(--arturo-border);padding:8px 10px;text-align:left;}.vista-table tbody tr:hover{background:#fbf0c2;}.vista-table tr.is-selected{background:#f7e199;}.vista-toolbar,.vista-menubar{display:flex;gap:6px;align-items:center;padding:6px 8px;background:var(--arturo-primary);border:1px solid var(--arturo-ink);border-radius:10px;}.vista-menubar{position:relative;}.vista-menu-panel{position:absolute;top:calc(100% + 4px);min-width:160px;background:var(--arturo-panel);border:1px solid var(--arturo-border);border-radius:8px;padding:6px;box-shadow:0 8px 20px rgba(0,0,0,0.12);display:none;z-index:1000;}.vista-menu-panel.is-open{display:block;}.vista-menu-item{display:block;width:100%;text-align:left;}.vista-tool-group{display:flex;gap:6px;align-items:center;}.vista-divider{border:none;border-top:1px solid var(--arturo-border);margin:8px 0;}.vista-canvas{border:1px solid var(--arturo-border);border-radius:8px;}.vista-split{display:flex;gap:8px;}.vista-split-pane{flex:1;}.vista-text-list{padding-left:18px;margin:0;}.vista-list{list-style:none;padding:0;margin:0;border:1px solid var(--arturo-border);border-radius:10px;background:var(--arturo-panel);max-height:220px;overflow:auto;}.vista-list li{padding:6px 8px;border-bottom:1px solid var(--arturo-border);cursor:pointer;}.vista-list li:last-child{border-bottom:none;}.vista-list li.is-selected{background:#0b5fff;color:#ffffff;font-weight:700;box-shadow:inset 0 0 0 2px #0a2f9a;}.vista-list li.is-active{outline:2px solid #8fb5ff;outline-offset:-2px;}ul[data-list-bind='selected_mission'] li::after{display:block;font-size:11px;opacity:0.9;margin-top:2px;font-weight:500;}ul[data-list-bind='selected_mission'] li[data-value='Mission 1']::after{content:'The Awakening of Awareness';}ul[data-list-bind='selected_mission'] li[data-value='Mission 2']::after{content:'The Hall of Pretexts';}ul[data-list-bind='selected_mission'] li[data-value='Mission 3']::after{content:'The Workshop of Human Factors';}ul[data-list-bind='selected_mission'] li[data-value='Mission 4']::after{content:'The Hall of Syndicates';}ul[data-list-bind='selected_mission'] li[data-value='Mission 5']::after{content:'The Labyrinth of Channels';}ul[data-list-bind='selected_mission'] li[data-value='Mission 6']::after{content:'The Vault of Credentials';}ul[data-list-bind='selected_mission'] li[data-value='Mission 7']::after{content:'The Citadel of Teams';}ul[data-list-bind='selected_mission'] li[data-value='Mission 8']::after{content:'The Theater of Adversaries';}ul[data-list-bind='selected_mission'] li[data-value='Mission 9']::after{content:'The Mirror of the Self';}ul[data-list-bind='selected_mission'] li[data-value='Mission 10']::after{content:'The Constellation of Defenders';}.vista-tabs{display:flex;flex-direction:column;gap:6px;}.vista-tabs-header{display:flex;gap:6px;flex-wrap:wrap;}.vista-tab-btn{padding:6px 10px;border:1px solid var(--arturo-border);border-radius:8px;background:var(--arturo-panel);}.vista-tab-btn.is-active{background:var(--arturo-primary);border-color:var(--arturo-ink);}.vista-tab-panel{display:none;padding:10px;border:1px solid var(--arturo-border);border-radius:10px;background:var(--arturo-panel);}.vista-tab-panel.is-active{display:block;}.vista-key{min-width:120px;}.vista-radio-group{display:flex;flex-direction:column;gap:6px;}.vista-radio-item{display:flex;align-items:center;gap:6px;}.vista-auth-splash{min-height:60vh;display:flex;align-items:center;justify-content:center;padding:24px;}.vista-auth-splash-card{max-width:680px;width:100%;text-align:center;padding:28px;border:2px solid var(--arturo-ink);border-radius:16px;background:var(--arturo-primary);box-shadow:0 24px 60px rgba(2,6,23,0.35);}.vista-auth-splash-logo{width:96px;height:96px;object-fit:contain;margin:0 auto 10px;display:block;}.vista-auth-title{font-size:34px;font-weight:800;margin:0;color:var(--arturo-ink) !important;background:transparent !important;padding:0;display:block;}.vista-auth-subtitle{color:var(--arturo-muted);margin:0;}.vista-auth-card{max-width:520px;margin:0 auto;}.vista-auth-meta{display:block;color:var(--arturo-muted);margin-bottom:6px;}html{-webkit-text-size-adjust:100%;}img,video,canvas{max-width:100%;height:auto;}textarea{max-width:100%;}@media (max-width:900px){.vista-app-header-inner,.vista-app-body{padding-left:12px;padding-right:12px;}.vista-app-title{font-size:16px;}.vista-split{flex-direction:column;}.vista-split-pane{flex-basis:auto !important;}.vista-grid{grid-template-columns:1fr !important;}.vista-row,.vista-layout-across,.vista-layout-row{flex-direction:column;align-items:stretch;}.vista-toolbar,.vista-menubar,.vista-tool-group{flex-wrap:wrap;}.vista-panel-body,.vista-box{padding:10px;}.vista-auth-splash{padding:14px;}.vista-auth-splash-card{padding:16px;}}@media (max-width:640px){.vista-app-header-inner,.vista-app-body{padding-left:10px;padding-right:10px;}.vista-app-logo{height:22px;}.vista-app-title{font-size:15px;}.vista-table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}.vista-tab-btn{width:100%;text-align:left;}}@media (pointer:coarse){button,input,select,textarea{min-height:40px;}}:root{--arturo-primary:#f2c230;--arturo-bg:#f7f6f1;--arturo-ink:#141414;}.vista-app-title{color:#141414;}</style></head><body><header class='vista-app-header'><div class='vista-app-header-inner'><img class='vista-app-logo' src='logo_path' alt='T'><div class='vista-app-title'>T</div><div class='vista-auth-header-controls'><button class='vista-auth-header-btn' data-vista-action='auth_show_login'><span class='vista-button-icon'><svg
  xmlns="http://www.w3.org/2000/svg"
  width="24"
  height="24"
  viewBox="0 0 24 24"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
>
  <path d="m10 17 5-5-5-5" />
  <path d="M15 12H3" />
  <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
</svg>
</span>Sign In</button><button class='vista-auth-header-btn' data-vista-action='auth_show_signup'><span class='vista-button-icon'><svg
  xmlns="http://www.w3.org/2000/svg"
  width="24"
  height="24"
  viewBox="0 0 24 24"
  fill="none"
  stroke="currentColor"
  stroke-width="2"
  stroke-linecap="round"
  stroke-linejoin="round"
>
  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
  <circle cx="9" cy="7" r="4" />
  <line x1="19" x2="19" y1="8" y2="14" />
  <line x1="22" x2="16" y1="11" y2="11" />
</svg>
</span>Sign Up</button></div></div></header><main class='vista-app-body'><div><span data-face-id='face-2'>x</span></div></main><script>window.__vistaAllowDynamicEval=(window.__vistaAllowDynamicEval===true);function _vistaParsePx(v){const n=parseFloat(v);return isNaN(n)?0:n;}function _vistaMeasureText(text,font){const c=_vistaMeasureText._c||(_vistaMeasureText._c=document.createElement('canvas'));const ctx=c.getContext('2d');ctx.font=font||'16px sans-serif';const lines=String(text||'').split('\n');let maxW=0;lines.forEach(line=>{const w=ctx.measureText(line).width;if(w>maxW){maxW=w;}});let lineHeight=0;const m=ctx.measureText('M');if((m.actualBoundingBoxAscent||0)+(m.actualBoundingBoxDescent||0)>0){lineHeight=m.actualBoundingBoxAscent+m.actualBoundingBoxDescent;}if(!lineHeight){const fontSize=_vistaParsePx((font||'').match(/\d+px/)?(font.match(/\d+px/)[0]):'16px');lineHeight=fontSize*1.2;}let height=lineHeight*lines.length;return {width:maxW,height:height};}function autoSize(){document.querySelectorAll('[data-auto-size]').forEach(el=>{const hasInlineWidth=!!el.style.width;const hasInlineHeight=!!el.style.height;const managed=el.dataset.autoSizeManaged==='1';if((hasInlineWidth||hasInlineHeight) && !managed){return;}const style=getComputedStyle(el);const text=el.textContent||'';const m=_vistaMeasureText(text,style.font);const padX=_vistaParsePx(style.paddingLeft)+_vistaParsePx(style.paddingRight);const padY=_vistaParsePx(style.paddingTop)+_vistaParsePx(style.paddingBottom);const borderX=_vistaParsePx(style.borderLeftWidth)+_vistaParsePx(style.borderRightWidth);const borderY=_vistaParsePx(style.borderTopWidth)+_vistaParsePx(style.borderBottomWidth);const lineHeight=(style.lineHeight&&style.lineHeight!=='normal')?_vistaParsePx(style.lineHeight):0;const lines=Math.max(1,String(text||'').split('\n').length);if(lineHeight>0){m.height=Math.max(m.height,lineHeight*lines);}const w=Math.ceil(m.width+padX+borderX);const h=Math.ceil(m.height+padY+borderY);if(w>0){el.style.width=w+'px';}if(h>0){el.style.height=h+'px';}el.dataset.autoSizeManaged='1';});}function _vistaAiNorm(s){return String(s||'').replace(/\\n/g,'\n').replace(/\\r/g,'\r');}function _vistaAiClientId(cfg){const key=cfg.clientIdKey||'client_id';let clientId=String(state[key]||'').trim();if(!clientId){clientId='vista-'+Date.now()+'-'+Math.floor(Math.random()*1000000);state[key]=clientId;render();}return clientId;}function _vistaAiV2(cfg,method,path,body){const apiBase=String(state[cfg.apiBaseKey||'api_base']||'http://localhost:18969').trim();const enc=encodeURIComponent;const clientId=_vistaAiClientId(cfg);const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();return fetch(apiBase+'/api/v2/security/csrf/'+enc(clientId),{headers:{'x-auth-token':token||''}}).then(_vistaAiParseResponse).then((csrfPayload)=>{if(!csrfPayload||csrfPayload.ok===false||!csrfPayload.data||!csrfPayload.data.token){throw new Error('csrf token fetch failed');}const csrf=String(csrfPayload.data.token||'');const jsonStr=JSON.stringify(body||{});const payload=btoa(unescape(encodeURIComponent(jsonStr)));const url=apiBase+path+'/'+enc(clientId)+'/'+enc(csrf)+'/'+enc(payload);const headers={'Content-Type':'application/json','x-client-id':clientId,'x-csrf-token':csrf};if(token){headers['x-auth-token']=token;}return fetch(url,{method:method,headers:headers}).then(_vistaAiParseResponse);});}function _vistaAiParseResponse(r){if(!r||typeof r.text!=='function'){return Promise.reject(new Error('invalid response'));}return r.text().then((body)=>{let payload=null;try{payload=JSON.parse(body||'{}');}catch(_e){}if(payload){return payload;}const status=(typeof r.status==='number')?r.status:0;const brief=String(body||'').slice(0,200).trim();throw new Error(status?('HTTP '+status+(brief?(': '+brief):'')):(brief||'request failed'));});}function _vistaAiJsonp(buildUrl){return new Promise((resolve,reject)=>{const reqId='r'+Date.now()+'_'+Math.floor(Math.random()*1000000);const script=document.createElement('script');const cleanup=()=>{if(script&&script.parentNode){script.parentNode.removeChild(script);}if(window.__vistaAiJsonpMap){delete window.__vistaAiJsonpMap[reqId];}};const timer=setTimeout(()=>{cleanup();reject(new Error('script timeout'));},20000);if(!window.__vistaAiJsonpMap){window.__vistaAiJsonpMap={};}if(!window.__vistaAiJsonp){window.__vistaAiJsonp=(id,payload)=>{if(window.__vistaAiJsonpMap&&window.__vistaAiJsonpMap[id]){window.__vistaAiJsonpMap[id](payload);}};}window.__vistaAiJsonpMap[reqId]=(payload)=>{clearTimeout(timer);cleanup();resolve(payload);};script.onerror=()=>{clearTimeout(timer);cleanup();reject(new Error('script load failed'));};script.src=buildUrl(reqId);document.head.appendChild(script);});}window.__vistaAiCatalog=window.__vistaAiCatalog||{};function _vistaAiSel(key){return document.querySelector('select[data-bind="'+key+'"]');}function _vistaAiSetSelectOptions(key,options,selected){const el=_vistaAiSel(key);if(!el){return;}const list=Array.isArray(options)?options:[];const want=String(selected==null?'':selected);el.innerHTML=list.map(v=>{const s=String(v);const sel=(s===want)?' selected':'';return '<option value="'+s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')+'"'+sel+'>'+s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>';}).join('');if(want!==''&&list.indexOf(want)>=0){el.value=want;}else if(list.length>0){el.value=String(list[0]);}}function _vistaAiCatalogProviderNames(catalog){if(!catalog||typeof catalog!=='object'){return [];}return Object.keys(catalog).filter(k=>catalog[k]&&typeof catalog[k]==='object'&&Array.isArray(catalog[k].models));}function _vistaAiApplyCatalogToState(cfg){const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const providers=_vistaAiCatalogProviderNames(window.__vistaAiCatalog);if(providers.length===0){return;}let provider=String(state[providerKey]||'');if(providers.indexOf(provider)<0){provider=providers[0];state[providerKey]=provider;}const providerCfg=window.__vistaAiCatalog[provider]||{};const models=Array.isArray(providerCfg.models)?providerCfg.models:[];if(models.length>0&&models.indexOf(String(state[modelKey]||''))<0){state[modelKey]=String(providerCfg.default_model||models[0]);}const tOpts=Array.isArray(providerCfg.temperature_options)?providerCfg.temperature_options:['0.0','0.2','0.4','0.7','1.0'];const pOpts=Array.isArray(providerCfg.top_p_options)?providerCfg.top_p_options:['0.7','0.9','1.0'];const mOpts=Array.isArray(providerCfg.max_tokens_options)?providerCfg.max_tokens_options:['64','128','256','512'];if(tOpts.indexOf(String(state[temperatureKey]||''))<0){state[temperatureKey]=String(tOpts[0]);}if(pOpts.indexOf(String(state[topPKey]||''))<0){state[topPKey]=String(pOpts[0]);}if(mOpts.indexOf(String(state[maxTokensKey]||''))<0){state[maxTokensKey]=String(mOpts[0]);}render();_vistaAiSetSelectOptions(providerKey,providers,state[providerKey]);_vistaAiSetSelectOptions(modelKey,models,state[modelKey]);_vistaAiSetSelectOptions(temperatureKey,tOpts,state[temperatureKey]);_vistaAiSetSelectOptions(topPKey,pOpts,state[topPKey]);_vistaAiSetSelectOptions(maxTokensKey,mOpts,state[maxTokensKey]);}function _vistaAiBindProviderWatch(cfg){const providerKey=cfg.providerKey||'provider';const el=_vistaAiSel(providerKey);if(!el||el.dataset.vistaAiProviderBound==='1'){return;}el.addEventListener('change',()=>{state[providerKey]=el.value;_vistaAiApplyCatalogToState(cfg);});el.dataset.vistaAiProviderBound='1';}function _vistaAiLoadProviders(cfg){cfg=cfg||{};const enc=encodeURIComponent;const apiBaseKey=cfg.apiBaseKey||'api_base';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const callFetch=()=>fetch(apiBase+'/api/ai/providers',{method:'GET'}).then(_vistaAiParseResponse);const callScript=()=>_vistaAiJsonp((reqId)=>apiBase+'/api/ai/providers-script/'+enc(reqId));return callFetch().catch(()=>callScript()).then((payload)=>{if(payload&&payload.ok&&payload.data){window.__vistaAiCatalog=payload.data||{};_vistaAiApplyCatalogToState(cfg);_vistaAiBindProviderWatch(cfg);return true;}return false;}).catch(()=>false);}function _vistaAiApplySettings(cfg,payload){if(!payload||!payload.ok||!payload.data){return false;}const d=payload.data;const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';if(d.provider!=null){state[providerKey]=String(d.provider);}if(d.model!=null){state[modelKey]=String(d.model);}if(d.temperature!=null){state[temperatureKey]=String(d.temperature);}if(d.top_p!=null){state[topPKey]=String(d.top_p);}if(d.max_tokens!=null){state[maxTokensKey]=String(d.max_tokens);}render();_vistaAiApplyCatalogToState(cfg);return true;}function _vistaAiSetStatus(cfg,text){const statusKey=cfg.statusKey||'status';if(statusKey){state[statusKey]=text;render();}}window._vistaAiSend=function(cfg){cfg=cfg||{};const enc=encodeURIComponent;const apiBaseKey=cfg.apiBaseKey||'api_base';const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const promptKey=cfg.promptKey||'message';const systemKey=cfg.systemKey||'system_prompt';const logKey=cfg.logKey||'chat_log';const statusKey=cfg.statusKey||'status';const clearPrompt=(cfg.clearPrompt!==false);const prompt=String(state[promptKey]||'').trim();if(!prompt){if(statusKey){state[statusKey]='Type a prompt first';render();}return;}const provider=String(state[providerKey]||'openai');const model=String(state[modelKey]||'gpt-4o-mini');const temperature=String(state[temperatureKey]||'0.2');const topP=String(state[topPKey]||'0.9');const maxTokens=String(state[maxTokensKey]||'128');const systemPrompt=String(state[systemKey]||'').trim();const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const appendTurn=(userText,aiText)=>{const block='you: '+_vistaAiNorm(userText)+'\nai: '+_vistaAiNorm(aiText);const prev=String(state[logKey]||'');state[logKey]=(prev?(prev+'\n\n'):'')+block;render();setTimeout(()=>{const el=document.querySelector('textarea[data-bind="'+logKey+'"]');if(el){el.scrollTop=el.scrollHeight;}},0);};if(statusKey){state[statusKey]='Sending...';render();}const path='/api/v2/ai/chat';const body={provider:provider,model:model,prompt:prompt,temperature:parseFloat(temperature),top_p:parseFloat(topP),max_tokens:parseInt(maxTokens,10)};if(systemPrompt){body.system=systemPrompt;}_vistaAiV2(cfg,'POST',path,body).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'request failed';throw new Error(msg);}const text=(payload&&payload.data&&payload.data.text)?String(payload.data.text).trim():'';appendTurn(prompt,text||'[empty response]');if(clearPrompt){state[promptKey]='';render();}if(statusKey){state[statusKey]='Ready';render();}}).catch((err)=>{const msg=(err&&err.message)?err.message:'request failed';appendTurn(prompt,'[error] '+msg);if(statusKey){state[statusKey]='Error';render();}});};window._vistaAiSaveSettings=function(cfg){cfg=cfg||{};const apiBaseKey=cfg.apiBaseKey||'api_base';const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const tokenKey=cfg.tokenKey||'auth_token';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const token=String(state[tokenKey]||'').trim();if(!token){_vistaAiSetStatus(cfg,'[error] Sign in to save settings');return;}const provider=encodeURIComponent(String(state[providerKey]||'openai'));const model=encodeURIComponent(String(state[modelKey]||'gpt-4o-mini'));const temperature=encodeURIComponent(String(state[temperatureKey]||'0.2'));const topP=encodeURIComponent(String(state[topPKey]||'0.9'));const maxTokens=encodeURIComponent(String(state[maxTokensKey]||'128'));_vistaAiSetStatus(cfg,'Saving settings...');const path='/api/v2/ai/settings'+provider+'/'+model+'/'+temperature+'/'+topP+'/'+maxTokens;fetch(apiBase+path,{method:'POST',headers:{'x-auth-token':token}}).then(_vistaAiParseResponse).then((payload)=>{if(!_vistaAiApplySettings(cfg,payload)){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'settings save failed';throw new Error(msg);} _vistaAiSetStatus(cfg,'Settings saved');}).catch((err)=>{const msg=(err&&err.message)?err.message:'settings save failed';_vistaAiSetStatus(cfg,'[error] '+msg);});};window._vistaAiLoadSettings=function(cfg){cfg=cfg||{};const apiBaseKey=cfg.apiBaseKey||'api_base';const tokenKey=cfg.tokenKey||'auth_token';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const token=String(state[tokenKey]||'').trim();if(!token){_vistaAiSetStatus(cfg,'Sign in to load settings');return;}_vistaAiSetStatus(cfg,'Loading settings...');fetch(apiBase+'/api/ai/settings',{method:'GET',headers:{'x-auth-token':token}}).then(_vistaAiParseResponse).then((payload)=>{if(!_vistaAiApplySettings(cfg,payload)){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'settings load failed';throw new Error(msg);} _vistaAiSetStatus(cfg,'Settings loaded');}).catch((err)=>{const msg=(err&&err.message)?err.message:'settings load failed';_vistaAiSetStatus(cfg,'[error] '+msg);});};function _vistaUiEscHtml(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}window._vistaUiAlert=function(cfg){cfg=cfg||{};const key=cfg.messageKey||'ui_message';const txt=(cfg.text!=null&&String(cfg.text)!=='')?cfg.text:state[key];window.alert(String(txt==null?'':txt));};window._vistaDialogFind=function(id){const s=String(id||'').trim();if(!s){return null;}const byId=document.getElementById(s);if(byId&&byId.tagName==='DIALOG'){return byId;}const byFace=document.querySelector('dialog[data-face-id="'+s+'"]');if(byFace){return byFace;}const byName=document.querySelector('dialog[name="'+s.replace(/"/g,'\\"')+'"]');if(byName){return byName;}return null;};window._vistaDialogFocusable=function(el){if(!el){return [];}return [...el.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')].filter(n=>!n.hasAttribute('disabled')&&n.getAttribute('aria-hidden')!=='true');};window._vistaDialogFocus=function(el){if(!el){return;}const target=el.querySelector('[autofocus]')||window._vistaDialogFocusable(el)[0];if(target&&typeof target.focus==='function'){target.focus();return;}if(typeof el.focus==='function'){el.focus();}};window._vistaDialogBind=function(el,cfg){if(!el||el.dataset.vistaDialogBound==='1'){return;}cfg=cfg||{};const statusKey=cfg.statusKey||'status';const closeReasonKey=cfg.closeReasonKey||'dialog_close_reason';el.dataset.vistaDialogBound='1';el.addEventListener('close',()=>{if(closeReasonKey){state[closeReasonKey]=String(el.returnValue||'');}if(statusKey){state[statusKey]='Dialog closed';}const openerId=el.dataset.vistaDialogOpener;if(openerId){const opener=document.getElementById(openerId);if(opener&&typeof opener.focus==='function'){opener.focus();}}render();});el.addEventListener('cancel',()=>{if(closeReasonKey){state[closeReasonKey]='cancel';}if(statusKey){state[statusKey]='Dialog cancelled';}render();});el.addEventListener('keydown',(e)=>{if(e.key!=='Tab'){return;}const nodes=window._vistaDialogFocusable(el);if(nodes.length===0){return;}const first=nodes[0];const last=nodes[nodes.length-1];if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus();}else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus();}});};window._vistaDialogOpen=function(cfg){cfg=cfg||{};const statusKey=cfg.statusKey||'status';const closeReasonKey=cfg.closeReasonKey||'dialog_close_reason';let id='';if(cfg.dialogId!=null&&String(cfg.dialogId).trim()!==''){id=String(cfg.dialogId).trim();}else if(cfg.dialogIdKey){id=String(state[cfg.dialogIdKey]||'').trim();}if(!id){const first=document.querySelector('dialog');if(first){id=first.id||first.getAttribute('data-face-id')||'';}}const el=window._vistaDialogFind(id);if(!el){if(statusKey){state[statusKey]='[error] dialog not found';render();}return false;}if(!el.id){el.id='vista-dialog-'+Math.floor(Math.random()*1000000);}const active=document.activeElement;if(active&&active.id){el.dataset.vistaDialogOpener=active.id;}window._vistaDialogBind(el,cfg);try{if(typeof el.showModal==='function'){if(!el.open){el.showModal();}}else{el.setAttribute('open','true');}}catch(_e){el.setAttribute('open','true');}window._vistaDialogFocus(el);if(statusKey){state[statusKey]='Dialog opened';render();}return true;};window._vistaDialogClose=function(cfg){cfg=cfg||{};const statusKey=cfg.statusKey||'status';const closeReasonKey=cfg.closeReasonKey||'dialog_close_reason';let id='';if(cfg.dialogId!=null&&String(cfg.dialogId).trim()!==''){id=String(cfg.dialogId).trim();}else if(cfg.dialogIdKey){id=String(state[cfg.dialogIdKey]||'').trim();}const reason=(cfg.reason!=null)?String(cfg.reason):'';const el=window._vistaDialogFind(id)||document.querySelector('dialog[open]');if(!el){if(statusKey){state[statusKey]='[error] dialog not found';render();}return false;}if(reason){el.returnValue=reason;}try{if(typeof el.close==='function'){el.close(reason);}else{el.removeAttribute('open');}}catch(_e){el.removeAttribute('open');}if(closeReasonKey&&reason){state[closeReasonKey]=reason;}if(statusKey){state[statusKey]='Dialog closed';render();}return true;};window._vistaUiDialog=function(cfg){cfg=cfg||{};const hasDialogId=(cfg.dialogId!=null&&String(cfg.dialogId).trim()!=='')||(cfg.dialogIdKey&&String(state[cfg.dialogIdKey]||'').trim()!=='')||document.querySelector('dialog');if(hasDialogId){return window._vistaDialogOpen(cfg);}const msg=String(state[cfg.messageKey||'ui_message']||'');const title=String(state[cfg.titleKey||'ui_title']||'Dialog');let host=document.getElementById('__vistaRuntimeDialog');if(host){host.remove();}host=document.createElement('div');host.id='__vistaRuntimeDialog';host.setAttribute('role','dialog');host.setAttribute('aria-modal','true');host.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.38);display:flex;align-items:center;justify-content:center;z-index:99999;padding:18px;';const card=document.createElement('div');card.style.cssText='background:#fff;border:1px solid #ded6c2;border-radius:12px;min-width:320px;max-width:860px;max-height:86vh;overflow:auto;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.22);';card.innerHTML='<h3 id="__vistaRuntimeDialogTitle" style="margin:0 0 8px 0;">'+_vistaUiEscHtml(title)+'</h3><pre style="white-space:pre-wrap;background:#fff;border:1px solid #ded6c2;border-radius:10px;padding:12px;">'+_vistaUiEscHtml(msg)+'</pre><div style="display:flex;justify-content:flex-end;"><button id="__vistaRuntimeDialogClose" style="padding:8px 12px;border:1px solid #ded6c2;background:#fff;border-radius:8px;cursor:pointer;">Close</button></div>';host.setAttribute('aria-labelledby','__vistaRuntimeDialogTitle');host.appendChild(card);const remove=()=>{host.remove();};host.addEventListener('click',function(e){if(e.target===host){remove();}});host.addEventListener('keydown',function(e){if(e.key==='Escape'){e.preventDefault();remove();}});document.body.appendChild(host);const b=document.getElementById('__vistaRuntimeDialogClose');if(b){b.addEventListener('click',remove);b.focus();}return true;};window._vistaUiClip=function(cfg){cfg=cfg||{};const textKey=cfg.textKey||'ui_message';const statusKey=cfg.statusKey||'status';const txt=(cfg.text!=null&&String(cfg.text)!=='')?String(cfg.text):String(state[textKey]||'');const set=(m)=>{if(statusKey){state[statusKey]=m;render();}};const fallback=()=>{try{const ta=document.createElement('textarea');ta.value=txt;ta.style.position='fixed';ta.style.left='-9999px';document.body.appendChild(ta);ta.focus();ta.select();const ok=document.execCommand('copy');document.body.removeChild(ta);set(ok?'Copied to clipboard':'[error] Clipboard copy failed');}catch(_e){set('[error] Clipboard copy failed');}};if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(txt).then(()=>set('Copied to clipboard')).catch(()=>fallback());}else{fallback();}};window._vistaUiUnclip=function(cfg){cfg=cfg||{};const targetKey=cfg.targetKey||'ui_message';const statusKey=cfg.statusKey||'status';const set=(m)=>{if(statusKey){state[statusKey]=m;render();}};const apply=(t)=>{state[targetKey]=String(t==null?'':t);render();set('Pasted from clipboard');};if(navigator.clipboard&&navigator.clipboard.readText){navigator.clipboard.readText().then(apply).catch(()=>{const t=window.prompt('Paste text:','');if(t!=null){apply(t);}else{set('[error] Clipboard read cancelled');}});}else{const t=window.prompt('Paste text:','');if(t!=null){apply(t);}else{set('[error] Clipboard read unavailable');}}};function _vistaAuthSetStatus(cfg,text){const statusKey=cfg.statusKey||'auth_status';if(statusKey){state[statusKey]=text;render();}}function _vistaAuthProfileLabel(user){const u=user||{};return 'Signed in as '+String(u.email||'')+' (role: '+String(u.role||'')+')';}function _vistaAuthClientId(cfg){const key=cfg.clientIdKey||'client_id';let clientId=String(state[key]||'').trim();if(!clientId){clientId='vista-'+Date.now()+'-'+Math.floor(Math.random()*1000000);state[key]=clientId;render();}return clientId;}function _vistaAuthV2(cfg,method,path,body){const apiBase=String(state[cfg.apiBaseKey||'api_base']||'http://localhost:18969').trim();const enc=encodeURIComponent;const clientId=_vistaAuthClientId(cfg);const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();return fetch(apiBase+'/api/v2/security/csrf/'+enc(clientId),{method:'GET'}).then(_vistaAiParseResponse).then((csrfPayload)=>{if(!csrfPayload||csrfPayload.ok===false||!csrfPayload.data||!csrfPayload.data.token){throw new Error('csrf token fetch failed');}const csrf=String(csrfPayload.data.token||'');const jsonStr=JSON.stringify(body||{});const payload=btoa(unescape(encodeURIComponent(jsonStr)));const url=apiBase+path+'/'+enc(clientId)+'/'+enc(csrf)+'/'+enc(payload);const headers={'Content-Type':'application/json','x-client-id':clientId,'x-csrf-token':csrf};if(token){headers['x-auth-token']=token;}return fetch(url,{method:method,headers:headers}).then(_vistaAiParseResponse);});}window._vistaAuthLogin=function(cfg){cfg=cfg||{};const emailKey=cfg.emailKey||'email';const passwordKey=cfg.passwordKey||'password';const mfaCodeKey=cfg.mfaCodeKey||'mfa_code';const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const tokenKey=cfg.tokenKey||'auth_token';const profileKey=cfg.profileKey||'profile_label';const showLoginKey=cfg.showLoginKey||'show_login';const showSignupKey=cfg.showSignupKey||'show_signup';const showAccountKey=cfg.showAccountKey||'show_account';const email=String(state[emailKey]||'').trim();const password=String(state[passwordKey]||'');if(!email||!password){_vistaAuthSetStatus(cfg,'Provide email and password');return;}state[tokenKey]='';_vistaAuthSetStatus(cfg,'Signing in...');_vistaAuthV2(cfg,'POST','/api/v2/auth/login',{email:email,password:password}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Login failed';throw new Error(msg);}if(payload.mfa_required){state[mfaChallengeKey]=String((payload.data&&payload.data.challenge_id)||'');state[profileKey]='Signed out';state[showLoginKey]=true;state[showSignupKey]=false;state[showAccountKey]=false;_vistaAuthSetStatus(cfg,'MFA required');render();return;}const data=(payload&&payload.data)||{};state[tokenKey]=String(data.token||'');state[mfaChallengeKey]='';state[profileKey]=_vistaAuthProfileLabel(data.user||{});state[showLoginKey]=false;state[showSignupKey]=false;state[showAccountKey]=true;_vistaAuthSetStatus(cfg,'Signed in');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Login failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthSignup=function(cfg){cfg=cfg||{};const showLoginKey=cfg.showLoginKey||'show_login';const showSignupKey=cfg.showSignupKey||'show_signup';const showAccountKey=cfg.showAccountKey||'show_account';const email=String(state[cfg.emailKey||'email']||'').trim();const password=String(state[cfg.passwordKey||'password']||'');if(!email||!password){_vistaAuthSetStatus(cfg,'Provide email and password');return;}_vistaAuthSetStatus(cfg,'Creating account...');_vistaAuthV2(cfg,'POST','/api/v2/auth/signup',{email:email,password:password}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Signup failed';throw new Error(msg);}state[showLoginKey]=true;state[showSignupKey]=false;state[showAccountKey]=false;_vistaAuthSetStatus(cfg,'Account created. Please sign in.');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Signup failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthMfaVerify=function(cfg){cfg=cfg||{};const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const mfaCodeKey=cfg.mfaCodeKey||'mfa_code';const tokenKey=cfg.tokenKey||'auth_token';const profileKey=cfg.profileKey||'profile_label';const showLoginKey=cfg.showLoginKey||'show_login';const showSignupKey=cfg.showSignupKey||'show_signup';const showAccountKey=cfg.showAccountKey||'show_account';const challenge=String(state[mfaChallengeKey]||'').trim();const code=String(state[mfaCodeKey]||'').trim();if(!challenge||!code){_vistaAuthSetStatus(cfg,'Provide MFA challenge and code');return;}_vistaAuthSetStatus(cfg,'Verifying MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/verify',{challenge_id:challenge,code:code}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA verification failed';throw new Error(msg);}const data=(payload&&payload.data)||{};state[tokenKey]=String(data.token||'');state[mfaChallengeKey]='';state[profileKey]=_vistaAuthProfileLabel(data.user||{});state[showLoginKey]=false;state[showSignupKey]=false;state[showAccountKey]=true;_vistaAuthSetStatus(cfg,'Signed in (MFA)');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA verification failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthUpdateEmail=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();const email=String(state[cfg.newEmailKey||'new_email']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}if(!email){_vistaAuthSetStatus(cfg,'Provide new email');return;}_vistaAuthSetStatus(cfg,'Updating email...');_vistaAuthV2(cfg,'PUT','/api/v2/auth/email',{token:token,email:email}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Email update failed';throw new Error(msg);}const data=(payload&&payload.data)||{};if(data.token){state[tokenKey]=String(data.token);}state[profileKey]=_vistaAuthProfileLabel(data.user||{});_vistaAuthSetStatus(cfg,'Email updated');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Email update failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthUpdatePassword=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();const oldPass=String(state[cfg.oldPasswordKey||'old_password']||'');const newPass=String(state[cfg.newPasswordKey||'new_password']||'');if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}if(!oldPass||!newPass){_vistaAuthSetStatus(cfg,'Provide current and new password');return;}_vistaAuthSetStatus(cfg,'Updating password...');_vistaAuthV2(cfg,'PUT','/api/v2/auth/password',{token:token,old_password:oldPass,new_password:newPass}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Password update failed';throw new Error(msg);}const data=(payload&&payload.data)||{};if(data.token){state[tokenKey]=String(data.token);} _vistaAuthSetStatus(cfg,'Password updated');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Password update failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthEnableMfa=function(cfg){cfg=cfg||{};const token=String(state[cfg.tokenKey||'auth_token']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}_vistaAuthSetStatus(cfg,'Enabling MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/enable',{}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA enable failed';throw new Error(msg);}if(payload.data){state[profileKey]=_vistaAuthProfileLabel(payload.data);} _vistaAuthSetStatus(cfg,'MFA enabled');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA enable failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthDisableMfa=function(cfg){cfg=cfg||{};const token=String(state[cfg.tokenKey||'auth_token']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}_vistaAuthSetStatus(cfg,'Disabling MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/disable',{}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA disable failed';throw new Error(msg);}if(payload.data){state[profileKey]=_vistaAuthProfileLabel(payload.data);} _vistaAuthSetStatus(cfg,'MFA disabled');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA disable failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthLogout=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const statusKey=cfg.statusKey||'auth_status';const profileKey=cfg.profileKey||'profile_label';const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const showLoginKey=cfg.showLoginKey||'show_login';const showSignupKey=cfg.showSignupKey||'show_signup';const showAccountKey=cfg.showAccountKey||'show_account';const applyLocalSignout=(statusText)=>{state[tokenKey]='';state[mfaChallengeKey]='';state[profileKey]='Signed out';state[showLoginKey]=true;state[showSignupKey]=false;state[showAccountKey]=false;if(statusKey){state[statusKey]=statusText;}render();};const token=String(state[tokenKey]||'').trim();if(!token){applyLocalSignout('Already signed out');return;}_vistaAuthV2(cfg,'POST','/api/v2/auth/logout',{token:token}).then((_payload)=>{applyLocalSignout('Signed out');}).catch((_err)=>{applyLocalSignout('Signed out (offline)');});};function bindInputs(){document.querySelectorAll('[data-bind]').forEach(el=>{if(el.dataset.vistaBound==='1'){return;}el.dataset.vistaBound='1';const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.addEventListener('change',()=>{state[key]=el.checked;render();if(window.vistaPushState){vistaPushState();}});}else if(el.type==='radio'){el.addEventListener('change',()=>{if(el.checked){state[key]=el.value;}render();if(window.vistaPushState){vistaPushState();}});}else{el.addEventListener('input',()=>{state[key]=el.value;const action=el.dataset.oninputAction;if(window.__vistaAllowDynamicEval&&action){try{eval(action);}catch(e){}}render();if(window.vistaPushState){vistaPushState();}});}}else if(el.tagName==='TEXTAREA'){el.addEventListener('input',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}else if(el.tagName==='SELECT'){el.addEventListener('change',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}});}function bindActions(){document.querySelectorAll('[data-vista-action]').forEach(el=>{if(el.dataset.vistaActionBound==='1'){return;}el.dataset.vistaActionBound='1';el.addEventListener('click',(e)=>{const action=el.dataset.vistaAction;if(!action){return;}e.preventDefault();switch(action){case 'auth_show_splash':state['show_splash']=true;state['show_login']=false;state['show_signup']=false;state['show_account']=false;if('show_ai_settings' in state){state['show_ai_settings']=false;}state['auth_prev_panel']='splash';render();break;case 'auth_show_login':state['show_splash']=false;state['show_login']=true;state['show_signup']=false;state['show_account']=false;if('show_ai_settings' in state){state['show_ai_settings']=false;}state['auth_prev_panel']='login';render();break;case 'auth_show_signup':state['show_splash']=false;state['show_login']=false;state['show_signup']=true;state['show_account']=false;if('show_ai_settings' in state){state['show_ai_settings']=false;}state['auth_prev_panel']='signup';render();break;case 'auth_show_ai_settings':{let prev='splash';if(state['show_account']){prev='account';}else if(state['show_login']){prev='login';}else if(state['show_signup']){prev='signup';}else if(state['show_splash']){prev='splash';}state['auth_prev_panel']=prev;state['show_splash']=false;state['show_login']=false;state['show_signup']=false;state['show_account']=false;if('show_ai_settings' in state){state['show_ai_settings']=true;}render();break;}case 'auth_close_ai_settings':{const prev=String(state['auth_prev_panel']||'splash');if('show_ai_settings' in state){state['show_ai_settings']=false;}state['show_splash']=prev==='splash';state['show_login']=prev==='login';state['show_signup']=prev==='signup';state['show_account']=prev==='account';render();break;}case 'auth_show_account':state['show_splash']=false;state['show_login']=false;state['show_signup']=false;state['show_account']=true;if('show_ai_settings' in state){state['show_ai_settings']=false;}state['auth_prev_panel']='account';render();break;case 'auth_logout':state['auth_token']='';state['show_splash']=true;state['show_login']=false;state['show_signup']=false;state['show_account']=false;if('show_ai_settings' in state){state['show_ai_settings']=false;}state['auth_prev_panel']='splash';state['profile_label']='Signed out';state['auth_status']='Signed out';render();break;case 'toggle_ai_settings':state['show_ai_settings']=!state['show_ai_settings'];render();break;case 'load_selected_mission':{const applyMission=(name)=>{state['selected_mission']=name;switch(name){case 'Mission 1':state['mission_subtitle']='The Awakening of Awareness';state['mission_description']='Foundations of Social Engineering Defense';state['objective_lines']='- The Signal Repair\n- The Trigger Mirror\n- The Awareness Compass';break;case 'Mission 2':state['mission_subtitle']='Hall of Pretexts';state['mission_description']='Attack Patterns and Context Analysis';state['objective_lines']='- The Pretext Codex\n- The Chainbreaker Path\n- The Context Sentinel';break;case 'Mission 3':state['mission_subtitle']='Workshop of Human Factors';state['mission_description']='Biases and Response Protocols';state['objective_lines']='- The Defensive Plan Spell\n- The Role Inversion Circle\n- The Protocol Seal';break;case 'Mission 4':state['mission_subtitle']='Hall of Syndicates';state['mission_description']='Multi-Stage Campaigns and Evidence Habits';state['objective_lines']='- The Architect\'s Shield\n- The Red Thread Map\n- The Signal Archive';break;case 'Mission 5':state['mission_subtitle']='Labyrinth of Channels';state['mission_description']='Email, SMS, Voice, and Chat Attack Surfaces';state['objective_lines']='- The Phishing Gallery\n- The Voice Veil\n- The Surface Map';break;case 'Mission 6':state['mission_subtitle']='Vault of Credentials';state['mission_description']='Identity and Authentication Defense';state['objective_lines']='- The Keymaker\'s Dilemma\n- The Token Ward\n- The Access Ledger';break;case 'Mission 7':state['mission_subtitle']='Citadel of Teams';state['mission_description']='Culture, Escalation, and Reporting';state['objective_lines']='- The Beacon Protocol\n- The Whisper Network Audit\n- The Ritual of Drills';break;case 'Mission 8':state['mission_subtitle']='Theater of Adversaries';state['mission_description']='Attacker Personas and TTP Patterns';state['objective_lines']='- The Mask Gallery\n- The Playbook Scribe\n- The Shadow Forecast';break;case 'Mission 9':state['mission_subtitle']='Mirror of the Self';state['mission_description']='Personal Threat Modeling and Boundaries';state['objective_lines']='- The Footprint Cartographer\n- The Boundary Ward\n- The Habit Weave';break;case 'Mission 10':state['mission_subtitle']='Constellation of Defenders';state['mission_description']='Capstone and Teaching Others';state['objective_lines']='- The Narrative Codex\n- The Dual Path Trial\n- The Legacy Circuit';break;}};applyMission(String(state['selected_mission']||'Mission 1'));if('train_status' in state){state['train_status']='LIVE_CONNECTION';}if(state['chat_log']!=null){state['chat_log']=String(state['chat_log'])+'\nRHO::SYSTEM> Loaded '+String(state['selected_mission'])+': '+String(state['mission_subtitle']||'');}render();break;}case 'next_mission':{const cur=String(state['selected_mission']||'Mission 1');const m=cur.match(/^Mission\s+(\d+)$/i);let n=1;if(m){const parsed=parseInt(m[1],10);if(!isNaN(parsed)){n=parsed;}}n=Math.min(10,n+1);state['selected_mission']='Mission '+n;const applyMission=(name)=>{switch(name){case 'Mission 1':state['mission_subtitle']='The Awakening of Awareness';state['mission_description']='Foundations of Social Engineering Defense';state['objective_lines']='- The Signal Repair\n- The Trigger Mirror\n- The Awareness Compass';break;case 'Mission 2':state['mission_subtitle']='Hall of Pretexts';state['mission_description']='Attack Patterns and Context Analysis';state['objective_lines']='- The Pretext Codex\n- The Chainbreaker Path\n- The Context Sentinel';break;case 'Mission 3':state['mission_subtitle']='Workshop of Human Factors';state['mission_description']='Biases and Response Protocols';state['objective_lines']='- The Defensive Plan Spell\n- The Role Inversion Circle\n- The Protocol Seal';break;case 'Mission 4':state['mission_subtitle']='Hall of Syndicates';state['mission_description']='Multi-Stage Campaigns and Evidence Habits';state['objective_lines']='- The Architect\'s Shield\n- The Red Thread Map\n- The Signal Archive';break;case 'Mission 5':state['mission_subtitle']='Labyrinth of Channels';state['mission_description']='Email, SMS, Voice, and Chat Attack Surfaces';state['objective_lines']='- The Phishing Gallery\n- The Voice Veil\n- The Surface Map';break;case 'Mission 6':state['mission_subtitle']='Vault of Credentials';state['mission_description']='Identity and Authentication Defense';state['objective_lines']='- The Keymaker\'s Dilemma\n- The Token Ward\n- The Access Ledger';break;case 'Mission 7':state['mission_subtitle']='Citadel of Teams';state['mission_description']='Culture, Escalation, and Reporting';state['objective_lines']='- The Beacon Protocol\n- The Whisper Network Audit\n- The Ritual of Drills';break;case 'Mission 8':state['mission_subtitle']='Theater of Adversaries';state['mission_description']='Attacker Personas and TTP Patterns';state['objective_lines']='- The Mask Gallery\n- The Playbook Scribe\n- The Shadow Forecast';break;case 'Mission 9':state['mission_subtitle']='Mirror of the Self';state['mission_description']='Personal Threat Modeling and Boundaries';state['objective_lines']='- The Footprint Cartographer\n- The Boundary Ward\n- The Habit Weave';break;case 'Mission 10':state['mission_subtitle']='Constellation of Defenders';state['mission_description']='Capstone and Teaching Others';state['objective_lines']='- The Narrative Codex\n- The Dual Path Trial\n- The Legacy Circuit';break;}};applyMission(String(state['selected_mission']));if('train_status' in state){state['train_status']='LIVE_CONNECTION';}render();break;}}});});}function render(){document.querySelectorAll('[data-bind]').forEach(el=>{const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.checked=!!state[key];}else if(el.type==='radio'){el.checked=(state[key]==null?'':state[key])==el.value;}else{el.value=(state[key]==null?'':state[key]);}}else if(el.tagName==='TEXTAREA'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='SELECT'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='PROGRESS'){el.value=(state[key]==null?0:state[key]);}else if(el.tagName==='IMG'||el.tagName==='AUDIO'||el.tagName==='VIDEO'){if(state[key]!=null){el.src=state[key];if(el.tagName==='AUDIO'||el.tagName==='VIDEO'){try{el.load();}catch(_e5){}}}}else{el.textContent=(state[key]==null?'':state[key]);}});document.querySelectorAll('[data-show-bind]').forEach(el=>{const key=el.dataset.showBind;const expected=el.dataset.showValue;const cur=state[key];let show=false;if(expected==null||expected===''){show=!!cur;}else{show=String(cur)===expected;}el.style.display=show?'':'none';});document.querySelectorAll('ul[data-list-bind]').forEach(ul=>{const key=ul.dataset.listBind;const multi=ul.dataset.multi==='true';const items=[...ul.querySelectorAll('li[data-value]')];const setActive=(idx)=>{if(idx<0||idx>=items.length){return;}ul.dataset.activeIndex=String(idx);items.forEach((li,i)=>{li.classList.toggle('is-active',i===idx);});};const applyRange=(a,b,additive)=>{let start=Math.min(a,b);let end=Math.max(a,b);let values=items.slice(start,end+1).map(li=>li.dataset.value);let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(!additive){cur=[];}values.forEach(v=>{if(!cur.includes(v)){cur.push(v);}});state[key]=cur;};const toggleValue=(v)=>{let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(cur.includes(v)){cur=cur.filter(x=>x!==v);}else{cur=[...cur,v];}state[key]=cur;};const selectIndex=(idx,evt)=>{if(idx<0||idx>=items.length){return;}setActive(idx);const v=items[idx].dataset.value;if(!multi){state[key]=v;render();if(window.vistaPushState){vistaPushState();}return;}const shift=evt&&evt.shiftKey;const additive=evt&&(evt.ctrlKey||evt.metaKey);if(shift){const anchor=parseInt(ul.dataset.anchorIndex||String(idx),10);applyRange(anchor,idx,additive);}else if(additive){toggleValue(v);}else{state[key]=[v];}if(!shift){ul.dataset.anchorIndex=String(idx);}render();if(window.vistaPushState){vistaPushState();}};items.forEach((li,idx)=>{li.addEventListener('click',e=>{selectIndex(idx,e);});});ul.addEventListener('keydown',e=>{if(!items.length){return;}const selectedIndex=items.findIndex(li=>li.classList.contains('is-selected'));let idx=selectedIndex>=0?selectedIndex:0;if(e.key==='ArrowDown'){e.preventDefault();idx=Math.min(items.length-1,idx+1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='ArrowUp'){e.preventDefault();idx=Math.max(0,idx-1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='Home'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(0);return;}selectIndex(0,e);}else if(e.key==='End'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(items.length-1);return;}selectIndex(items.length-1,e);}else if(e.key===' '||e.key==='Enter'){e.preventDefault();selectIndex(idx,e);}else if(e.key.length===1 && !e.ctrlKey && !e.metaKey){const ch=e.key.toLowerCase();const buf=(ul._vistaTypeBuf||'')+ch;ul._vistaTypeBuf=buf;clearTimeout(ul._vistaTypeTimer);ul._vistaTypeTimer=setTimeout(()=>{ul._vistaTypeBuf='';},500);const found=items.findIndex(li=>li.textContent.trim().toLowerCase().startsWith(buf));if(found>=0){selectIndex(found,e);}} });});const handleKey=(el,e)=>{const bind=el.dataset.keyBind;const mode=el.dataset.keyMode||'keydown';if((mode==='keyup'&&e.type!=='keyup')||(mode!=='keyup'&&e.type!=='keydown')){return;}let value='';const modifiersOnly=el.dataset.keyModifiers==='true';if(modifiersOnly){const mods=[];if(e.shiftKey){mods.push('Shift');}if(e.ctrlKey){mods.push('Ctrl');}if(e.altKey){mods.push('Alt');}if(e.metaKey){mods.push('Meta');}value=mods.join('+');}else{value=e.key;}const filter=(el.dataset.keyFilter||'').split(',').map(s=>s.trim()).filter(Boolean);if(filter.length>0 && value!=='' && !filter.includes(value)){return;}state[bind]=value;render();if(window.__vistaAllowDynamicEval&&el.dataset.keyAction){try{eval(el.dataset.keyAction);}catch(e){}}if(window.vistaPushState){vistaPushState();}};document.querySelectorAll('[data-key-bind]').forEach(el=>{el.addEventListener('keydown',e=>handleKey(el,e));el.addEventListener('keyup',e=>handleKey(el,e));});autoSize();}setTimeout(()=>{render();bindInputs();bindActions();const aiCfg={apiBaseKey:'api_base',providerKey:'provider',modelKey:'model',temperatureKey:'temperature',topPKey:'top_p',maxTokensKey:'max_tokens',statusKey:'status'};_vistaAiLoadProviders(aiCfg).then(()=>_vistaAiLoadSettings(aiCfg));},0);window.vistaShow=function(id,html){const el=document.querySelector('[data-face-id="'+id+'"]');if(!el){return false;}el.outerHTML=html;render();bindInputs();bindActions();return true;};document.addEventListener('DOMContentLoaded', ()=>{render();bindInputs();bindActions();});document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('[data-tabs]').forEach(container=>{const buttons=[...container.querySelectorAll('.vista-tab-btn')];const panels=[...container.querySelectorAll('.vista-tab-panel')];const activate=id=>{buttons.forEach(btn=>{btn.classList.toggle('is-active',btn.dataset.tab===id);});panels.forEach(panel=>{panel.classList.toggle('is-active',panel.dataset.tab===id);});};let selectedIndex=parseInt(container.dataset.tabsSelected||'0',10);if(isNaN(selectedIndex)){selectedIndex=0;}if(buttons.length>0){const idx=Math.max(0,Math.min(selectedIndex,buttons.length-1));activate(buttons[idx].dataset.tab);}buttons.forEach((btn,idx)=>{btn.addEventListener('click',()=>activate(btn.dataset.tab));btn.addEventListener('keydown',e=>{if(e.key==='ArrowRight'){e.preventDefault();const next=(idx+1)%buttons.length;buttons[next].click();buttons[next].focus();}else if(e.key==='ArrowLeft'){e.preventDefault();const prev=(idx-1+buttons.length)%buttons.length;buttons[prev].click();buttons[prev].focus();}else if(e.key==='Home'){e.preventDefault();buttons[0].click();buttons[0].focus();}else if(e.key==='End'){e.preventDefault();buttons[buttons.length-1].click();buttons[buttons.length-1].focus();}});});});});document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.vista-menubar').forEach(bar=>{const buttons=[...bar.querySelectorAll('[data-menu]')];const panels=[...bar.querySelectorAll('[data-menu-panel]')];let openKey=null;const closeAll=()=>{panels.forEach(p=>p.classList.remove('is-open'));buttons.forEach(b=>b.classList.remove('is-active'));openKey=null;};const openMenu=(key,btn)=>{const panel=panels.find(p=>p.dataset.menuPanel===key);if(!panel){return;}panels.forEach(p=>p.classList.toggle('is-open',p===panel));buttons.forEach(b=>b.classList.toggle('is-active',b===btn));const barRect=bar.getBoundingClientRect();const btnRect=btn.getBoundingClientRect();panel.style.left=(btnRect.left-barRect.left)+'px';panel.style.top=(barRect.height+4)+'px';openKey=key;};buttons.forEach(btn=>{btn.addEventListener('click',e=>{e.stopPropagation();const key=btn.dataset.menu;if(openKey===key){closeAll();}else{openMenu(key,btn);}});btn.addEventListener('mouseenter',()=>{if(openKey){openMenu(btn.dataset.menu,btn);}});});document.addEventListener('click',()=>{if(openKey){closeAll();}});document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeAll();}});panels.forEach(panel=>{panel.addEventListener('click',e=>e.stopPropagation());});});});document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('table[data-row-select]').forEach(table=>{table.querySelectorAll('tbody tr').forEach(row=>{row.addEventListener('click',()=>{table.querySelectorAll('tbody tr').forEach(r=>r.classList.remove('is-selected'));row.classList.add('is-selected');table.dataset.selectedText=row.textContent.trim();});});});});document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('[data-rate]').forEach(el=>{const ms=parseInt(el.getAttribute('data-rate')||'0',10);if(!(ms>0)){return;}const tickCode=el.getAttribute('data-rate-on-tick')||'';setInterval(()=>{try{if(window.__vistaAllowDynamicEval&&tickCode){(new Function('event','value',tickCode)).call(el,null,('value' in el)?el.value:el.textContent);}}catch(_e){}try{el.dispatchEvent(new CustomEvent('vista-rate-tick'));}catch(_e2){}},ms);});document.querySelectorAll('*').forEach(el=>{const hasPrefix=(prefix)=>{const attrs=el.attributes||[];for(let i=0;i<attrs.length;i++){const name=attrs[i]&&attrs[i].name?attrs[i].name:'';if(name.indexOf(prefix)===0){return true;}}return false;};const engageCode=el.getAttribute('data-feel-engage')||'';const detectCode=el.getAttribute('data-feel-detect')||'';const redrawCode=el.getAttribute('data-feel-redraw')||'';const hasEngagePhases=hasPrefix('data-feel-engage-phase-');const hasDetectPhases=hasPrefix('data-feel-detect-phase-');const hasRedrawPhases=hasPrefix('data-feel-redraw-phase-');if(!(engageCode||detectCode||redrawCode||hasEngagePhases||hasDetectPhases||hasRedrawPhases)){return;}if(el.dataset.vistaFeelCompatBound==='1'){return;}el.dataset.vistaFeelCompatBound='1';const run=(code,event,value)=>{if(!code){return;}try{if(window.__vistaAllowDynamicEval){(new Function('event','value',code)).call(el,event,value);}}catch(_e){}};const phaseCode=(prefix,phase)=>el.getAttribute(prefix+phase)||'';const resolvePhase=(prefix,phase,aliases)=>{if(phaseCode(prefix,phase)){return phase;}const list=Array.isArray(aliases)?aliases:[];for(let i=0;i<list.length;i++){if(phaseCode(prefix,list[i])){return list[i];}}return phase;};const pointOf=(evt)=>{if(!evt){return {x:null,y:null,pageX:null,pageY:null,screenX:null,screenY:null};}const t=(evt.touches&&evt.touches[0])||(evt.changedTouches&&evt.changedTouches[0])||evt;const x=(t&&typeof t.clientX==='number')?t.clientX:null;const y=(t&&typeof t.clientY==='number')?t.clientY:null;const pageX=(t&&typeof t.pageX==='number')?t.pageX:null;const pageY=(t&&typeof t.pageY==='number')?t.pageY:null;const screenX=(t&&typeof t.screenX==='number')?t.screenX:null;const screenY=(t&&typeof t.screenY==='number')?t.screenY:null;return {x:x,y:y,pageX:pageX,pageY:pageY,screenX:screenX,screenY:screenY};};const normalize=(action,phase,evt)=>{const pt=pointOf(evt);const target=(evt&&evt.target)?evt.target:el;const value=(target&&'value' in target)?target.value:((target&&target.textContent!=null)?String(target.textContent):'');const timestamp=(evt&&typeof evt.timeStamp==='number')?evt.timeStamp:Date.now();const payload={action:action,type:action,phase:phase,eventType:evt&&evt.type?String(evt.type):'',faceId:el.getAttribute('data-face-id')||el.id||'',targetId:(target&&target.id)?target.id:'',targetName:(target&&target.name)?target.name:'',targetTag:(target&&target.tagName)?String(target.tagName).toLowerCase():'',timestamp:timestamp,x:pt.x,y:pt.y,pageX:pt.pageX,pageY:pt.pageY,screenX:pt.screenX,screenY:pt.screenY,dx:(evt&&typeof evt.movementX==='number')?evt.movementX:0,dy:(evt&&typeof evt.movementY==='number')?evt.movementY:0,button:(evt&&typeof evt.button==='number')?evt.button:null,buttons:(evt&&typeof evt.buttons==='number')?evt.buttons:null,key:evt&&evt.key?String(evt.key):'',code:evt&&evt.code?String(evt.code):'',keyCode:(evt&&typeof evt.keyCode==='number')?evt.keyCode:null,which:(evt&&typeof evt.which==='number')?evt.which:null,detail:(evt&&typeof evt.detail==='number')?evt.detail:null,pointerType:evt&&evt.pointerType?String(evt.pointerType):'',pointerId:(evt&&typeof evt.pointerId==='number')?evt.pointerId:null,pressure:(evt&&typeof evt.pressure==='number')?evt.pressure:null,tiltX:(evt&&typeof evt.tiltX==='number')?evt.tiltX:null,tiltY:(evt&&typeof evt.tiltY==='number')?evt.tiltY:null,twist:(evt&&typeof evt.twist==='number')?evt.twist:null,wheelX:(evt&&typeof evt.deltaX==='number')?evt.deltaX:0,wheelY:(evt&&typeof evt.deltaY==='number')?evt.deltaY:0,wheelZ:(evt&&typeof evt.deltaZ==='number')?evt.deltaZ:0,deltaMode:(evt&&typeof evt.deltaMode==='number')?evt.deltaMode:null,alt:!!(evt&&evt.altKey),ctrl:!!(evt&&evt.ctrlKey),shift:!!(evt&&evt.shiftKey),meta:!!(evt&&evt.metaKey),modifiers:{alt:!!(evt&&evt.altKey),ctrl:!!(evt&&evt.ctrlKey),shift:!!(evt&&evt.shiftKey),meta:!!(evt&&evt.metaKey)},value:value,checked:!!(target&&target.checked),selectedIndex:(target&&typeof target.selectedIndex==='number')?target.selectedIndex:null};return payload;};const dispatch=(kind,prefix,baseCode,phase,aliases,evt)=>{const resolved=resolvePhase(prefix,phase,aliases);const payload=normalize(kind,resolved,evt);payload.requestedPhase=phase;const pCode=phaseCode(prefix,resolved);if(pCode){run(pCode,evt,payload);return;}run(baseCode,evt,payload);};const engage=(phase,evt,aliases)=>dispatch('engage','data-feel-engage-phase-',engageCode,phase,aliases,evt);const detect=(phase,evt,aliases)=>dispatch('detect','data-feel-detect-phase-',detectCode,phase,aliases,evt);const redraw=(phase,evt,aliases)=>dispatch('redraw','data-feel-redraw-phase-',redrawCode,phase,aliases,evt);if(engageCode||hasEngagePhases){el.addEventListener('mousedown',e=>{if(e&&typeof e.button==='number'){if(e.button===1){engage('aux-down',e,['alt-down','down']);return;}if(e.button===2){engage('alt-down',e,['menu','down']);return;}}engage('down',e,['pointer-down','press']);});el.addEventListener('mouseup',e=>{if(e&&typeof e.button==='number'){if(e.button===1){engage('aux-up',e,['alt-up','up']);return;}if(e.button===2){engage('alt-up',e,['up']);return;}}engage('up',e,['pointer-up','release']);});el.addEventListener('click',e=>engage('click',e,['tap']));el.addEventListener('dblclick',e=>engage('double-click',e,['dbl-click']));el.addEventListener('contextmenu',e=>engage('menu',e,['context-menu']));el.addEventListener('mouseenter',e=>engage('over',e,['enter','hover']));el.addEventListener('mouseleave',e=>engage('away',e,['out','leave']));el.addEventListener('focus',e=>engage('focus',e,[]));el.addEventListener('blur',e=>engage('blur',e,[]));el.addEventListener('keydown',e=>engage('key',e,['key-down']));el.addEventListener('keyup',e=>engage('key-up',e,['key']));el.addEventListener('change',e=>engage('change',e,[]));el.addEventListener('input',e=>engage('input',e,[]));el.addEventListener('submit',e=>engage('submit',e,[]));el.addEventListener('wheel',e=>engage('wheel',e,['scroll-wheel']));if(window.PointerEvent){el.addEventListener('pointerdown',e=>engage('pointer-down',e,['down']));el.addEventListener('pointerup',e=>engage('pointer-up',e,['up']));el.addEventListener('pointercancel',e=>engage('pointer-cancel',e,['cancel']));el.addEventListener('pointerenter',e=>engage('enter',e,['over']));el.addEventListener('pointerleave',e=>engage('leave',e,['away']));}el.addEventListener('touchstart',e=>engage('touch-start',e,['down']));el.addEventListener('touchend',e=>engage('touch-end',e,['up','tap']));el.addEventListener('touchcancel',e=>engage('touch-cancel',e,['cancel']));}if(detectCode||hasDetectPhases){el.addEventListener('mousemove',e=>detect('move',e,[]));el.addEventListener('mouseenter',e=>detect('over',e,['enter']));el.addEventListener('mouseleave',e=>detect('away',e,['leave','out']));el.addEventListener('wheel',e=>detect('wheel',e,['scroll']));el.addEventListener('scroll',e=>detect('scroll',e,['wheel']));if(window.PointerEvent){el.addEventListener('pointermove',e=>detect('move',e,['pointer-move']));}el.addEventListener('touchmove',e=>detect('move',e,['touch-move']));}if(redrawCode||hasRedrawPhases){el.addEventListener('vista-rate-tick',e=>redraw('tick',e,[]));el.addEventListener('change',e=>redraw('change',e,[]));el.addEventListener('input',e=>redraw('input',e,[]));el.addEventListener('scroll',e=>redraw('scroll',e,['move']));if(window.addEventListener){window.addEventListener('resize',e=>redraw('resize',e,['show']));document.addEventListener('visibilitychange',e=>redraw(document.hidden?'hide':'show',e,['show']));}setTimeout(()=>redraw('show',null,[]),0);}});document.querySelectorAll('[data-feel-drag],[data-feel-pointer-down],[data-feel-pointer-move],[data-feel-pointer-up],[data-feel-pointer-cancel],[data-feel-tap],[data-feel-long-press]').forEach(el=>{const run=(code,event,value)=>{if(!code){return;}try{if(window.__vistaAllowDynamicEval){(new Function('event','value',code)).call(el,event,value);}}catch(_e){}};const dragCode=el.getAttribute('data-feel-drag')||'';const ptrDown=el.getAttribute('data-feel-pointer-down')||'';const ptrMove=el.getAttribute('data-feel-pointer-move')||'';const ptrUp=el.getAttribute('data-feel-pointer-up')||'';const ptrCancel=el.getAttribute('data-feel-pointer-cancel')||'';const tapCode=el.getAttribute('data-feel-tap')||'';const longCode=el.getAttribute('data-feel-long-press')||'';const longMs=Math.max(0,parseInt(el.getAttribute('data-feel-long-press-ms')||'500',10)||500);const pointOf=(evt)=>{if(!evt){return {x:null,y:null,pageX:null,pageY:null,screenX:null,screenY:null};}const t=(evt.touches&&evt.touches[0])||(evt.changedTouches&&evt.changedTouches[0])||evt;const x=(t&&typeof t.clientX==='number')?t.clientX:null;const y=(t&&typeof t.clientY==='number')?t.clientY:null;const pageX=(t&&typeof t.pageX==='number')?t.pageX:null;const pageY=(t&&typeof t.pageY==='number')?t.pageY:null;const screenX=(t&&typeof t.screenX==='number')?t.screenX:null;const screenY=(t&&typeof t.screenY==='number')?t.screenY:null;return {x:x,y:y,pageX:pageX,pageY:pageY,screenX:screenX,screenY:screenY};};const normalized=(action,phase,evt,extra)=>{const pt=pointOf(evt);const target=(evt&&evt.target)?evt.target:el;const value=(target&&'value' in target)?target.value:((target&&target.textContent!=null)?String(target.textContent):'');const payload={action:action,type:action,phase:phase,eventType:evt&&evt.type?String(evt.type):'',faceId:el.getAttribute('data-face-id')||el.id||'',targetId:(target&&target.id)?target.id:'',targetName:(target&&target.name)?target.name:'',targetTag:(target&&target.tagName)?String(target.tagName).toLowerCase():'',timestamp:(evt&&typeof evt.timeStamp==='number')?evt.timeStamp:Date.now(),x:pt.x,y:pt.y,pageX:pt.pageX,pageY:pt.pageY,screenX:pt.screenX,screenY:pt.screenY,dx:(evt&&typeof evt.movementX==='number')?evt.movementX:0,dy:(evt&&typeof evt.movementY==='number')?evt.movementY:0,button:(evt&&typeof evt.button==='number')?evt.button:null,buttons:(evt&&typeof evt.buttons==='number')?evt.buttons:null,key:evt&&evt.key?String(evt.key):'',code:evt&&evt.code?String(evt.code):'',keyCode:(evt&&typeof evt.keyCode==='number')?evt.keyCode:null,which:(evt&&typeof evt.which==='number')?evt.which:null,detail:(evt&&typeof evt.detail==='number')?evt.detail:null,pointerType:evt&&evt.pointerType?String(evt.pointerType):'',pointerId:(evt&&typeof evt.pointerId==='number')?evt.pointerId:null,pressure:(evt&&typeof evt.pressure==='number')?evt.pressure:null,tiltX:(evt&&typeof evt.tiltX==='number')?evt.tiltX:null,tiltY:(evt&&typeof evt.tiltY==='number')?evt.tiltY:null,twist:(evt&&typeof evt.twist==='number')?evt.twist:null,wheelX:(evt&&typeof evt.deltaX==='number')?evt.deltaX:0,wheelY:(evt&&typeof evt.deltaY==='number')?evt.deltaY:0,wheelZ:(evt&&typeof evt.deltaZ==='number')?evt.deltaZ:0,deltaMode:(evt&&typeof evt.deltaMode==='number')?evt.deltaMode:null,alt:!!(evt&&evt.altKey),ctrl:!!(evt&&evt.ctrlKey),shift:!!(evt&&evt.shiftKey),meta:!!(evt&&evt.metaKey),modifiers:{alt:!!(evt&&evt.altKey),ctrl:!!(evt&&evt.ctrlKey),shift:!!(evt&&evt.shiftKey),meta:!!(evt&&evt.metaKey)},value:value,checked:!!(target&&target.checked),selectedIndex:(target&&typeof target.selectedIndex==='number')?target.selectedIndex:null};if(extra&&typeof extra==='object'){Object.keys(extra).forEach(k=>{payload[k]=extra[k];});}return payload;};let down=false,sx=0,sy=0,pressedAt=0,longTimer=null,longFired=false,moved=false;const clearLong=()=>{if(longTimer){clearTimeout(longTimer);longTimer=null;}};const start=(x,y,e)=>{down=true;sx=x;sy=y;pressedAt=Date.now();longFired=false;moved=false;clearLong();run(ptrDown,e,normalized('engage','pointer-down',e,{x:x,y:y,startX:x,startY:y}));if(longCode){longTimer=setTimeout(()=>{if(down&&!moved){longFired=true;run(longCode,e,normalized('engage','long-press',e,{x:x,y:y,startX:sx,startY:sy,duration:Date.now()-pressedAt}));}},longMs);}};const move=(x,y,e)=>{run(ptrMove,e,normalized('detect','pointer-move',e,{x:x,y:y,startX:sx,startY:sy,dx:x-sx,dy:y-sy}));if(!down){return;}const dx=x-sx;const dy=y-sy;if(Math.abs(dx)>8||Math.abs(dy)>8){moved=true;clearLong();}if(dragCode){run(dragCode,e,normalized('engage','drag',e,{x:x,y:y,startX:sx,startY:sy,dx:dx,dy:dy,duration:Date.now()-pressedAt}));}};const finish=(x,y,e,cancelled)=>{if(!down){if(cancelled){run(ptrCancel,e,normalized('engage','pointer-cancel',e,{x:x,y:y,startX:sx,startY:sy}));}return;}down=false;const dx=x-sx;const dy=y-sy;const dur=Date.now()-pressedAt;clearLong();if(cancelled){run(ptrCancel,e,normalized('engage','pointer-cancel',e,{x:x,y:y,startX:sx,startY:sy,dx:dx,dy:dy,duration:dur}));return;}run(ptrUp,e,normalized('engage','pointer-up',e,{x:x,y:y,startX:sx,startY:sy,dx:dx,dy:dy,duration:dur}));if(tapCode&&!longFired&&!moved&&dur<longMs){run(tapCode,e,normalized('engage','tap',e,{x:x,y:y,startX:sx,startY:sy,duration:dur}));}};if(window.PointerEvent){el.addEventListener('pointerdown',e=>{if(e.pointerType==='mouse'&&e.button!==0){return;}start(e.clientX,e.clientY,e);});window.addEventListener('pointermove',e=>{move(e.clientX,e.clientY,e);});window.addEventListener('pointerup',e=>{finish(e.clientX,e.clientY,e,false);});window.addEventListener('pointercancel',e=>{finish(e.clientX,e.clientY,e,true);});}else{el.addEventListener('mousedown',e=>{if(e.button!==0){return;}start(e.clientX,e.clientY,e);});window.addEventListener('mousemove',e=>{move(e.clientX,e.clientY,e);});window.addEventListener('mouseup',e=>{finish(e.clientX,e.clientY,e,false);});el.addEventListener('touchstart',e=>{if(!e.touches||e.touches.length===0){return;}const t=e.touches[0];start(t.clientX,t.clientY,e);},{passive:true});window.addEventListener('touchmove',e=>{if(!e.touches||e.touches.length===0){return;}const t=e.touches[0];move(t.clientX,t.clientY,e);if(down){e.preventDefault();}},{passive:false});window.addEventListener('touchend',e=>{const t=e.changedTouches&&e.changedTouches[0];if(t){finish(t.clientX,t.clientY,e,false);}else{finish(sx,sy,e,false);}});window.addEventListener('touchcancel',e=>{const t=e.changedTouches&&e.changedTouches[0];if(t){finish(t.clientX,t.clientY,e,true);}else{finish(sx,sy,e,true);}});}});document.querySelectorAll('[data-dnd-dragstart],[data-dnd-dragover],[data-dnd-drop],[data-dnd-dragenter],[data-dnd-dragleave],[data-dnd-dragend]').forEach(el=>{const run=(code,event,payload)=>{if(!code){return;}try{if(window.__vistaAllowDynamicEval){(new Function('event','value',code)).call(el,event,payload);}}catch(_e){}};const payloadAttr=el.getAttribute('data-dnd-payload')||'';const dragStartCode=el.getAttribute('data-dnd-dragstart')||'';const dragOverCode=el.getAttribute('data-dnd-dragover')||'';const dropCode=el.getAttribute('data-dnd-drop')||'';const dragEnterCode=el.getAttribute('data-dnd-dragenter')||'';const dragLeaveCode=el.getAttribute('data-dnd-dragleave')||'';const dragEndCode=el.getAttribute('data-dnd-dragend')||'';const dropEffect=el.getAttribute('data-dnd-drop-effect')||'';if(dragStartCode&&!el.hasAttribute('draggable')){el.setAttribute('draggable','true');}el.addEventListener('dragstart',e=>{const payload=payloadAttr!==''?payloadAttr:(el.getAttribute('data-value')||el.textContent||'');if(e.dataTransfer){try{e.dataTransfer.setData('text/plain',payload);}catch(_e1){}e.dataTransfer.effectAllowed='copyMove';}run(dragStartCode,e,payload);});el.addEventListener('dragover',e=>{e.preventDefault();if(e.dataTransfer&&dropEffect!==''){e.dataTransfer.dropEffect=dropEffect;}run(dragOverCode,e,null);});el.addEventListener('drop',e=>{e.preventDefault();let payload='';if(e.dataTransfer){try{payload=e.dataTransfer.getData('text/plain')||'';}catch(_e2){}}el.setAttribute('data-dnd-last-payload',payload);run(dropCode,e,payload);});el.addEventListener('dragenter',e=>{e.preventDefault();run(dragEnterCode,e,null);});el.addEventListener('dragleave',e=>{run(dragLeaveCode,e,null);});el.addEventListener('dragend',e=>{run(dragEndCode,e,null);});});});</script></body></html>