const state = {selected_nav: 'Chat', chat_log: 'ai: Hello. Send a prompt to start chatting.', message: '', status: 'Ready', api_base: 'http://localhost:18969', provider: 'openai', model: 'gpt-4o-mini', temperature: '0.2', top_p: '0.9', max_tokens: '128'};window.__vistaAllowDynamicEval=(window.__vistaAllowDynamicEval===true);function _vistaParsePx(v){const n=parseFloat(v);return isNaN(n)?0:n;}function _vistaMeasureText(text,font){const c=_vistaMeasureText._c||(_vistaMeasureText._c=document.createElement('canvas'));const ctx=c.getContext('2d');ctx.font=font||'16px sans-serif';const lines=String(text||'').split('\n');let maxW=0;lines.forEach(line=>{const w=ctx.measureText(line).width;if(w>maxW){maxW=w;}});let lineHeight=0;const m=ctx.measureText('M');if((m.actualBoundingBoxAscent||0)+(m.actualBoundingBoxDescent||0)>0){lineHeight=m.actualBoundingBoxAscent+m.actualBoundingBoxDescent;}if(!lineHeight){const fontSize=_vistaParsePx((font||'').match(/\d+px/)?(font.match(/\d+px/)[0]):'16px');lineHeight=fontSize*1.2;}let height=lineHeight*lines.length;return {width:maxW,height:height};}function autoSize(){document.querySelectorAll('[data-auto-size]').forEach(el=>{const hasInlineWidth=!!el.style.width;const hasInlineHeight=!!el.style.height;const managed=el.dataset.autoSizeManaged==='1';if((hasInlineWidth||hasInlineHeight) && !managed){return;}const style=getComputedStyle(el);const text=el.textContent||'';const m=_vistaMeasureText(text,style.font);const padX=_vistaParsePx(style.paddingLeft)+_vistaParsePx(style.paddingRight);const padY=_vistaParsePx(style.paddingTop)+_vistaParsePx(style.paddingBottom);const borderX=_vistaParsePx(style.borderLeftWidth)+_vistaParsePx(style.borderRightWidth);const borderY=_vistaParsePx(style.borderTopWidth)+_vistaParsePx(style.borderBottomWidth);const lineHeight=(style.lineHeight&&style.lineHeight!=='normal')?_vistaParsePx(style.lineHeight):0;const lines=Math.max(1,String(text||'').split('\n').length);if(lineHeight>0){m.height=Math.max(m.height,lineHeight*lines);}const w=Math.ceil(m.width+padX+borderX);const h=Math.ceil(m.height+padY+borderY);if(w>0){el.style.width=w+'px';}if(h>0){el.style.height=h+'px';}el.dataset.autoSizeManaged='1';});}function _vistaAiNorm(s){return String(s||'').replace(/\\n/g,'\n').replace(/\\r/g,'\r');}function _vistaAiParseResponse(r){if(!r||typeof r.text!=='function'){return Promise.reject(new Error('invalid response'));}return r.text().then((body)=>{let payload=null;try{payload=JSON.parse(body||'{}');}catch(_e){}if(payload){return payload;}const status=(typeof r.status==='number')?r.status:0;const brief=String(body||'').slice(0,200).trim();throw new Error(status?('HTTP '+status+(brief?(': '+brief):'')):(brief||'request failed'));});}function _vistaAiJsonp(buildUrl){return new Promise((resolve,reject)=>{const reqId='r'+Date.now()+'_'+Math.floor(Math.random()*1000000);const script=document.createElement('script');const cleanup=()=>{if(script&&script.parentNode){script.parentNode.removeChild(script);}if(window.__vistaAiJsonpMap){delete window.__vistaAiJsonpMap[reqId];}};const timer=setTimeout(()=>{cleanup();reject(new Error('script timeout'));},20000);if(!window.__vistaAiJsonpMap){window.__vistaAiJsonpMap={};}if(!window.__vistaAiJsonp){window.__vistaAiJsonp=(id,payload)=>{if(window.__vistaAiJsonpMap&&window.__vistaAiJsonpMap[id]){window.__vistaAiJsonpMap[id](payload);}};}window.__vistaAiJsonpMap[reqId]=(payload)=>{clearTimeout(timer);cleanup();resolve(payload);};script.onerror=()=>{clearTimeout(timer);cleanup();reject(new Error('script load failed'));};script.src=buildUrl(reqId);document.head.appendChild(script);});}window.__vistaAiCatalog=window.__vistaAiCatalog||{};function _vistaAiSel(key){return document.querySelector('select[data-bind="'+key+'"]');}function _vistaAiSetSelectOptions(key,options,selected){const el=_vistaAiSel(key);if(!el){return;}const list=Array.isArray(options)?options:[];const want=String(selected==null?'':selected);el.innerHTML=list.map(v=>{const s=String(v);const sel=(s===want)?' selected':'';return '<option value="'+s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')+'"'+sel+'>'+s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</option>';}).join('');if(want!==''&&list.indexOf(want)>=0){el.value=want;}else if(list.length>0){el.value=String(list[0]);}}function _vistaAiCatalogProviderNames(catalog){if(!catalog||typeof catalog!=='object'){return [];}return Object.keys(catalog).filter(k=>catalog[k]&&typeof catalog[k]==='object'&&Array.isArray(catalog[k].models));}function _vistaAiApplyCatalogToState(cfg){const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const providers=_vistaAiCatalogProviderNames(window.__vistaAiCatalog);if(providers.length===0){return;}let provider=String(state[providerKey]||'');if(providers.indexOf(provider)<0){provider=providers[0];state[providerKey]=provider;}const providerCfg=window.__vistaAiCatalog[provider]||{};const models=Array.isArray(providerCfg.models)?providerCfg.models:[];if(models.length>0&&models.indexOf(String(state[modelKey]||''))<0){state[modelKey]=String(providerCfg.default_model||models[0]);}const tOpts=Array.isArray(providerCfg.temperature_options)?providerCfg.temperature_options:['0.0','0.2','0.4','0.7','1.0'];const pOpts=Array.isArray(providerCfg.top_p_options)?providerCfg.top_p_options:['0.7','0.9','1.0'];const mOpts=Array.isArray(providerCfg.max_tokens_options)?providerCfg.max_tokens_options:['64','128','256','512'];if(tOpts.indexOf(String(state[temperatureKey]||''))<0){state[temperatureKey]=String(tOpts[0]);}if(pOpts.indexOf(String(state[topPKey]||''))<0){state[topPKey]=String(pOpts[0]);}if(mOpts.indexOf(String(state[maxTokensKey]||''))<0){state[maxTokensKey]=String(mOpts[0]);}render();_vistaAiSetSelectOptions(providerKey,providers,state[providerKey]);_vistaAiSetSelectOptions(modelKey,models,state[modelKey]);_vistaAiSetSelectOptions(temperatureKey,tOpts,state[temperatureKey]);_vistaAiSetSelectOptions(topPKey,pOpts,state[topPKey]);_vistaAiSetSelectOptions(maxTokensKey,mOpts,state[maxTokensKey]);}function _vistaAiBindProviderWatch(cfg){const providerKey=cfg.providerKey||'provider';const el=_vistaAiSel(providerKey);if(!el||el.dataset.vistaAiProviderBound==='1'){return;}el.addEventListener('change',()=>{state[providerKey]=el.value;_vistaAiApplyCatalogToState(cfg);});el.dataset.vistaAiProviderBound='1';}function _vistaAiLoadProviders(cfg){cfg=cfg||{};const enc=encodeURIComponent;const apiBaseKey=cfg.apiBaseKey||'api_base';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const callFetch=()=>fetch(apiBase+'/api/ai/providers',{method:'GET'}).then(_vistaAiParseResponse);const callScript=()=>_vistaAiJsonp((reqId)=>apiBase+'/api/ai/providers-script/'+enc(reqId));return callFetch().catch(()=>callScript()).then((payload)=>{if(payload&&payload.ok&&payload.data){window.__vistaAiCatalog=payload.data||{};_vistaAiApplyCatalogToState(cfg);_vistaAiBindProviderWatch(cfg);return true;}return false;}).catch(()=>false);}function _vistaAiApplySettings(cfg,payload){if(!payload||!payload.ok||!payload.data){return false;}const d=payload.data;const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';if(d.provider!=null){state[providerKey]=String(d.provider);}if(d.model!=null){state[modelKey]=String(d.model);}if(d.temperature!=null){state[temperatureKey]=String(d.temperature);}if(d.top_p!=null){state[topPKey]=String(d.top_p);}if(d.max_tokens!=null){state[maxTokensKey]=String(d.max_tokens);}render();_vistaAiApplyCatalogToState(cfg);return true;}function _vistaAiSetStatus(cfg,text){const statusKey=cfg.statusKey||'status';if(statusKey){state[statusKey]=text;render();}}window._vistaAiSend=function(cfg){cfg=cfg||{};const enc=encodeURIComponent;const apiBaseKey=cfg.apiBaseKey||'api_base';const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const promptKey=cfg.promptKey||'message';const logKey=cfg.logKey||'chat_log';const statusKey=cfg.statusKey||'status';const clearPrompt=(cfg.clearPrompt!==false);const prompt=String(state[promptKey]||'').trim();if(!prompt){if(statusKey){state[statusKey]='Type a prompt first';render();}return;}const provider=String(state[providerKey]||'openai');const model=String(state[modelKey]||'gpt-4o-mini');const temperature=String(state[temperatureKey]||'0.2');const topP=String(state[topPKey]||'0.9');const maxTokens=String(state[maxTokensKey]||'128');const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const appendTurn=(userText,aiText)=>{const block='you: '+_vistaAiNorm(userText)+'\nai: '+_vistaAiNorm(aiText);const prev=String(state[logKey]||'');state[logKey]=(prev?(prev+'\n\n'):'')+block;render();setTimeout(()=>{const el=document.querySelector('textarea[data-bind="'+logKey+'"]');if(el){el.scrollTop=el.scrollHeight;}},0);};if(statusKey){state[statusKey]='Sending...';render();}const path='/api/ai/chat/'+enc(provider)+'/'+enc(model)+'/'+enc(temperature)+'/'+enc(topP)+'/'+enc(maxTokens)+'/'+enc(prompt);const url=apiBase+path;const callFetch=()=>fetch(url,{method:'POST'}).then(_vistaAiParseResponse);const callScript=()=>_vistaAiJsonp((reqId)=>apiBase+'/api/ai/chat-script/'+enc(reqId)+'/'+enc(provider)+'/'+enc(model)+'/'+enc(temperature)+'/'+enc(topP)+'/'+enc(maxTokens)+'/'+enc(prompt));callFetch().catch(()=>callScript()).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'request failed';throw new Error(msg);}const text=(payload&&payload.data&&payload.data.text)?String(payload.data.text).trim():'';appendTurn(prompt,text||'[empty response]');if(clearPrompt){state[promptKey]='';render();}if(statusKey){state[statusKey]='Ready';render();}}).catch((err)=>{const msg=(err&&err.message)?err.message:'request failed';appendTurn(prompt,'[error] '+msg);if(statusKey){state[statusKey]='Error';render();}});};window._vistaAiSaveSettings=function(cfg){cfg=cfg||{};const apiBaseKey=cfg.apiBaseKey||'api_base';const providerKey=cfg.providerKey||'provider';const modelKey=cfg.modelKey||'model';const temperatureKey=cfg.temperatureKey||'temperature';const topPKey=cfg.topPKey||'top_p';const maxTokensKey=cfg.maxTokensKey||'max_tokens';const tokenKey=cfg.tokenKey||'auth_token';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const token=String(state[tokenKey]||'').trim();if(!token){_vistaAiSetStatus(cfg,'[error] Sign in to save settings');return;}const provider=encodeURIComponent(String(state[providerKey]||'openai'));const model=encodeURIComponent(String(state[modelKey]||'gpt-4o-mini'));const temperature=encodeURIComponent(String(state[temperatureKey]||'0.2'));const topP=encodeURIComponent(String(state[topPKey]||'0.9'));const maxTokens=encodeURIComponent(String(state[maxTokensKey]||'128'));_vistaAiSetStatus(cfg,'Saving settings...');const path='/api/ai/settings/'+provider+'/'+model+'/'+temperature+'/'+topP+'/'+maxTokens;fetch(apiBase+path,{method:'POST',headers:{'x-auth-token':token}}).then(_vistaAiParseResponse).then((payload)=>{if(!_vistaAiApplySettings(cfg,payload)){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'settings save failed';throw new Error(msg);} _vistaAiSetStatus(cfg,'Settings saved');}).catch((err)=>{const msg=(err&&err.message)?err.message:'settings save failed';_vistaAiSetStatus(cfg,'[error] '+msg);});};window._vistaAiLoadSettings=function(cfg){cfg=cfg||{};const apiBaseKey=cfg.apiBaseKey||'api_base';const tokenKey=cfg.tokenKey||'auth_token';const apiBase=String(state[apiBaseKey]||'http://localhost:18969').trim();const token=String(state[tokenKey]||'').trim();if(!token){_vistaAiSetStatus(cfg,'Sign in to load settings');return;}_vistaAiSetStatus(cfg,'Loading settings...');fetch(apiBase+'/api/ai/settings',{method:'GET',headers:{'x-auth-token':token}}).then(_vistaAiParseResponse).then((payload)=>{if(!_vistaAiApplySettings(cfg,payload)){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'settings load failed';throw new Error(msg);} _vistaAiSetStatus(cfg,'Settings loaded');}).catch((err)=>{const msg=(err&&err.message)?err.message:'settings load failed';_vistaAiSetStatus(cfg,'[error] '+msg);});}function _vistaUiEscHtml(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}window._vistaUiAlert=function(cfg){cfg=cfg||{};const key=cfg.messageKey||'ui_message';const txt=(cfg.text!=null&&String(cfg.text)!=='')?cfg.text:state[key];window.alert(String(txt==null?'':txt));};window._vistaUiDialog=function(cfg){cfg=cfg||{};const msg=String(state[cfg.messageKey||'ui_message']||'');const title=String(state[cfg.titleKey||'ui_title']||'Dialog');let host=document.getElementById('__vistaRuntimeDialog');if(host){host.remove();}host=document.createElement('div');host.id='__vistaRuntimeDialog';host.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.38);display:flex;align-items:center;justify-content:center;z-index:99999;padding:18px;';const card=document.createElement('div');card.style.cssText='background:#fff;border:1px solid #ded6c2;border-radius:12px;min-width:320px;max-width:860px;max-height:86vh;overflow:auto;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.22);';card.innerHTML='<h3 style="margin:0 0 8px 0;">'+_vistaUiEscHtml(title)+'</h3><pre style="white-space:pre-wrap;background:#fff;border:1px solid #ded6c2;border-radius:10px;padding:12px;">'+_vistaUiEscHtml(msg)+'</pre><div style="display:flex;justify-content:flex-end;"><button id="__vistaRuntimeDialogClose" style="padding:8px 12px;border:1px solid #ded6c2;background:#fff;border-radius:8px;cursor:pointer;">Close</button></div>';host.appendChild(card);host.addEventListener('click',function(e){if(e.target===host){host.remove();}});document.body.appendChild(host);const b=document.getElementById('__vistaRuntimeDialogClose');if(b){b.addEventListener('click',function(){host.remove();});}};window._vistaUiClip=function(cfg){cfg=cfg||{};const textKey=cfg.textKey||'ui_message';const statusKey=cfg.statusKey||'status';const txt=(cfg.text!=null&&String(cfg.text)!=='')?String(cfg.text):String(state[textKey]||'');const set=(m)=>{if(statusKey){state[statusKey]=m;render();}};const fallback=()=>{try{const ta=document.createElement('textarea');ta.value=txt;ta.style.position='fixed';ta.style.left='-9999px';document.body.appendChild(ta);ta.focus();ta.select();const ok=document.execCommand('copy');document.body.removeChild(ta);set(ok?'Copied to clipboard':'[error] Clipboard copy failed');}catch(_e){set('[error] Clipboard copy failed');}};if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(txt).then(()=>set('Copied to clipboard')).catch(()=>fallback());}else{fallback();}};window._vistaUiUnclip=function(cfg){cfg=cfg||{};const targetKey=cfg.targetKey||'ui_message';const statusKey=cfg.statusKey||'status';const set=(m)=>{if(statusKey){state[statusKey]=m;render();}};const apply=(t)=>{state[targetKey]=String(t==null?'':t);render();set('Pasted from clipboard');};if(navigator.clipboard&&navigator.clipboard.readText){navigator.clipboard.readText().then(apply).catch(()=>{const t=window.prompt('Paste text:','');if(t!=null){apply(t);}else{set('[error] Clipboard read cancelled');}});}else{const t=window.prompt('Paste text:','');if(t!=null){apply(t);}else{set('[error] Clipboard read unavailable');}}};function _vistaAuthSetStatus(cfg,text){const statusKey=cfg.statusKey||'auth_status';if(statusKey){state[statusKey]=text;render();}}function _vistaAuthProfileLabel(user){const u=user||{};return 'Signed in as '+String(u.email||'')+' (role: '+String(u.role||'')+')';}function _vistaAuthClientId(cfg){const key=cfg.clientIdKey||'client_id';let clientId=String(state[key]||'').trim();if(!clientId){clientId='vista-'+Date.now()+'-'+Math.floor(Math.random()*1000000);state[key]=clientId;render();}return clientId;}function _vistaAuthV2(cfg,method,path,body){const apiBase=String(state[cfg.apiBaseKey||'api_base']||'http://localhost:18969').trim();const enc=encodeURIComponent;const clientId=_vistaAuthClientId(cfg);const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();return fetch(apiBase+'/api/v2/security/csrf/'+enc(clientId),{method:'GET'}).then(_vistaAiParseResponse).then((csrfPayload)=>{if(!csrfPayload||csrfPayload.ok===false||!csrfPayload.data||!csrfPayload.data.token){throw new Error('csrf token fetch failed');}const csrf=String(csrfPayload.data.token||'');const headers={'Content-Type':'application/json','x-client-id':clientId,'x-csrf-token':csrf};if(token){headers['x-auth-token']=token;}return fetch(apiBase+path,{method:method,headers:headers,body:JSON.stringify(body||{})}).then(_vistaAiParseResponse);});}window._vistaAuthLogin=function(cfg){cfg=cfg||{};const emailKey=cfg.emailKey||'email';const passwordKey=cfg.passwordKey||'password';const mfaCodeKey=cfg.mfaCodeKey||'mfa_code';const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const tokenKey=cfg.tokenKey||'auth_token';const profileKey=cfg.profileKey||'profile_label';const email=String(state[emailKey]||'').trim();const password=String(state[passwordKey]||'');if(!email||!password){_vistaAuthSetStatus(cfg,'Provide email and password');return;}state[tokenKey]='';_vistaAuthSetStatus(cfg,'Signing in...');_vistaAuthV2(cfg,'POST','/api/v2/auth/login',{email:email,password:password}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Login failed';throw new Error(msg);}if(payload.mfa_required){state[mfaChallengeKey]=String((payload.data&&payload.data.challenge_id)||'');state[profileKey]='Signed out';_vistaAuthSetStatus(cfg,'MFA required');render();return;}const data=(payload&&payload.data)||{};state[tokenKey]=String(data.token||'');state[mfaChallengeKey]='';state[profileKey]=_vistaAuthProfileLabel(data.user||{});_vistaAuthSetStatus(cfg,'Signed in');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Login failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthSignup=function(cfg){cfg=cfg||{};const email=String(state[cfg.emailKey||'email']||'').trim();const password=String(state[cfg.passwordKey||'password']||'');if(!email||!password){_vistaAuthSetStatus(cfg,'Provide email and password');return;}_vistaAuthSetStatus(cfg,'Creating account...');_vistaAuthV2(cfg,'POST','/api/v2/auth/signup',{email:email,password:password}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Signup failed';throw new Error(msg);} _vistaAuthSetStatus(cfg,'Account created');}).catch((err)=>{const msg=(err&&err.message)?err.message:'Signup failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthMfaVerify=function(cfg){cfg=cfg||{};const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const mfaCodeKey=cfg.mfaCodeKey||'mfa_code';const tokenKey=cfg.tokenKey||'auth_token';const profileKey=cfg.profileKey||'profile_label';const challenge=String(state[mfaChallengeKey]||'').trim();const code=String(state[mfaCodeKey]||'').trim();if(!challenge||!code){_vistaAuthSetStatus(cfg,'Provide MFA challenge and code');return;}_vistaAuthSetStatus(cfg,'Verifying MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/verify',{challenge_id:challenge,code:code}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA verification failed';throw new Error(msg);}const data=(payload&&payload.data)||{};state[tokenKey]=String(data.token||'');state[mfaChallengeKey]='';state[profileKey]=_vistaAuthProfileLabel(data.user||{});_vistaAuthSetStatus(cfg,'Signed in (MFA)');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA verification failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthUpdateEmail=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();const email=String(state[cfg.newEmailKey||'new_email']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}if(!email){_vistaAuthSetStatus(cfg,'Provide new email');return;}_vistaAuthSetStatus(cfg,'Updating email...');_vistaAuthV2(cfg,'PUT','/api/v2/auth/email',{token:token,email:email}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Email update failed';throw new Error(msg);}const data=(payload&&payload.data)||{};if(data.token){state[tokenKey]=String(data.token);}state[profileKey]=_vistaAuthProfileLabel(data.user||{});_vistaAuthSetStatus(cfg,'Email updated');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Email update failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthUpdatePassword=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const token=String(state[tokenKey]||'').trim();const oldPass=String(state[cfg.oldPasswordKey||'old_password']||'');const newPass=String(state[cfg.newPasswordKey||'new_password']||'');if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}if(!oldPass||!newPass){_vistaAuthSetStatus(cfg,'Provide current and new password');return;}_vistaAuthSetStatus(cfg,'Updating password...');_vistaAuthV2(cfg,'PUT','/api/v2/auth/password',{token:token,old_password:oldPass,new_password:newPass}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'Password update failed';throw new Error(msg);}const data=(payload&&payload.data)||{};if(data.token){state[tokenKey]=String(data.token);} _vistaAuthSetStatus(cfg,'Password updated');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Password update failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthEnableMfa=function(cfg){cfg=cfg||{};const token=String(state[cfg.tokenKey||'auth_token']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}_vistaAuthSetStatus(cfg,'Enabling MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/enable',{}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA enable failed';throw new Error(msg);}if(payload.data){state[profileKey]=_vistaAuthProfileLabel(payload.data);} _vistaAuthSetStatus(cfg,'MFA enabled');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA enable failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthDisableMfa=function(cfg){cfg=cfg||{};const token=String(state[cfg.tokenKey||'auth_token']||'').trim();const profileKey=cfg.profileKey||'profile_label';if(!token){_vistaAuthSetStatus(cfg,'Sign in first');return;}_vistaAuthSetStatus(cfg,'Disabling MFA...');_vistaAuthV2(cfg,'POST','/api/v2/auth/mfa/disable',{}).then((payload)=>{if(!payload||payload.ok===false){const msg=(payload&&payload.error&&payload.error.message)?payload.error.message:'MFA disable failed';throw new Error(msg);}if(payload.data){state[profileKey]=_vistaAuthProfileLabel(payload.data);} _vistaAuthSetStatus(cfg,'MFA disabled');render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'MFA disable failed';_vistaAuthSetStatus(cfg,msg);});};window._vistaAuthLogout=function(cfg){cfg=cfg||{};const tokenKey=cfg.tokenKey||'auth_token';const statusKey=cfg.statusKey||'auth_status';const profileKey=cfg.profileKey||'profile_label';const mfaChallengeKey=cfg.mfaChallengeKey||'mfa_challenge';const token=String(state[tokenKey]||'').trim();if(!token){state[tokenKey]='';state[mfaChallengeKey]='';state[profileKey]='Signed out';if(statusKey){state[statusKey]='Already signed out';}render();return;}_vistaAuthV2(cfg,'POST','/api/v2/auth/logout',{token:token}).then((_payload)=>{state[tokenKey]='';state[mfaChallengeKey]='';state[profileKey]='Signed out';if(statusKey){state[statusKey]='Signed out';}render();}).catch((err)=>{const msg=(err&&err.message)?err.message:'Sign out failed';if(statusKey){state[statusKey]=msg;render();}});};function bindInputs(){document.querySelectorAll('[data-bind]').forEach(el=>{if(el.dataset.vistaBound==='1'){return;}el.dataset.vistaBound='1';const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.addEventListener('change',()=>{state[key]=el.checked;render();if(window.vistaPushState){vistaPushState();}});}else if(el.type==='radio'){el.addEventListener('change',()=>{if(el.checked){state[key]=el.value;}render();if(window.vistaPushState){vistaPushState();}});}else{el.addEventListener('input',()=>{state[key]=el.value;const action=el.dataset.oninputAction;if(window.__vistaAllowDynamicEval&&action){try{eval(action);}catch(e){}}render();if(window.vistaPushState){vistaPushState();}});}}else if(el.tagName==='TEXTAREA'){el.addEventListener('input',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}else if(el.tagName==='SELECT'){el.addEventListener('change',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}});}function render(){document.querySelectorAll('[data-bind]').forEach(el=>{const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.checked=!!state[key];}else if(el.type==='radio'){el.checked=(state[key]==null?'':state[key])==el.value;}else{el.value=(state[key]==null?'':state[key]);}}else if(el.tagName==='TEXTAREA'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='SELECT'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='PROGRESS'){el.value=(state[key]==null?0:state[key]);}else if(el.tagName==='IMG'||el.tagName==='AUDIO'||el.tagName==='VIDEO'){if(state[key]!=null){el.src=state[key];if(el.tagName==='AUDIO'||el.tagName==='VIDEO'){try{el.load();}catch(_e5){}}}}else{el.textContent=(state[key]==null?'':state[key]);}});document.querySelectorAll('[data-show-bind]').forEach(el=>{const key=el.dataset.showBind;const expected=el.dataset.showValue;const cur=state[key];let show=false;if(expected==null||expected===''){show=!!cur;}else{show=String(cur)===expected;}el.style.display=show?'':'none';});document.querySelectorAll('ul[data-list-bind]').forEach(ul=>{const key=ul.dataset.listBind;const multi=ul.dataset.multi==='true';const items=[...ul.querySelectorAll('li[data-value]')];const setActive=(idx)=>{if(idx<0||idx>=items.length){return;}ul.dataset.activeIndex=String(idx);items.forEach((li,i)=>{li.classList.toggle('is-active',i===idx);});};const applyRange=(a,b,additive)=>{let start=Math.min(a,b);let end=Math.max(a,b);let values=items.slice(start,end+1).map(li=>li.dataset.value);let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(!additive){cur=[];}values.forEach(v=>{if(!cur.includes(v)){cur.push(v);}});state[key]=cur;};const toggleValue=(v)=>{let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(cur.includes(v)){cur=cur.filter(x=>x!==v);}else{cur=[...cur,v];}state[key]=cur;};const selectIndex=(idx,evt)=>{if(idx<0||idx>=items.length){return;}setActive(idx);const v=items[idx].dataset.value;if(!multi){state[key]=v;render();if(window.vistaPushState){vistaPushState();}return;}const shift=evt&&evt.shiftKey;const additive=evt&&(evt.ctrlKey||evt.metaKey);if(shift){const anchor=parseInt(ul.dataset.anchorIndex||String(idx),10);applyRange(anchor,idx,additive);}else if(additive){toggleValue(v);}else{state[key]=[v];}if(!shift){ul.dataset.anchorIndex=String(idx);}render();if(window.vistaPushState){vistaPushState();}};items.forEach((li,idx)=>{li.addEventListener('click',e=>{selectIndex(idx,e);});});ul.addEventListener('keydown',e=>{if(!items.length){return;}const selectedIndex=items.findIndex(li=>li.classList.contains('is-selected'));let idx=selectedIndex>=0?selectedIndex:0;if(e.key==='ArrowDown'){e.preventDefault();idx=Math.min(items.length-1,idx+1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='ArrowUp'){e.preventDefault();idx=Math.max(0,idx-1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='Home'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(0);return;}selectIndex(0,e);}else if(e.key==='End'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(items.length-1);return;}selectIndex(items.length-1,e);}else if(e.key===' '||e.key==='Enter'){e.preventDefault();selectIndex(idx,e);}else if(e.key.length===1 && !e.ctrlKey && !e.metaKey){const ch=e.key.toLowerCase();const buf=(ul._vistaTypeBuf||'')+ch;ul._vistaTypeBuf=buf;clearTimeout(ul._vistaTypeTimer);ul._vistaTypeTimer=setTimeout(()=>{ul._vistaTypeBuf='';},500);const found=items.findIndex(li=>li.textContent.trim().toLowerCase().startsWith(buf));if(found>=0){selectIndex(found,e);}} });});const handleKey=(el,e)=>{const bind=el.dataset.keyBind;const mode=el.dataset.keyMode||'keydown';if((mode==='keyup'&&e.type!=='keyup')||(mode!=='keyup'&&e.type!=='keydown')){return;}let value='';const modifiersOnly=el.dataset.keyModifiers==='true';if(modifiersOnly){const mods=[];if(e.shiftKey){mods.push('Shift');}if(e.ctrlKey){mods.push('Ctrl');}if(e.altKey){mods.push('Alt');}if(e.metaKey){mods.push('Meta');}value=mods.join('+');}else{value=e.key;}const filter=(el.dataset.keyFilter||'').split(',').map(s=>s.trim()).filter(Boolean);if(filter.length>0 && value!=='' && !filter.includes(value)){return;}state[bind]=value;render();if(window.__vistaAllowDynamicEval&&el.dataset.keyAction){try{eval(el.dataset.keyAction);}catch(e){}}if(window.vistaPushState){vistaPushState();}};document.querySelectorAll('[data-key-bind]').forEach(el=>{el.addEventListener('keydown',e=>handleKey(el,e));el.addEventListener('keyup',e=>handleKey(el,e));});autoSize();}setTimeout(()=>{render();bindInputs();const aiCfg={apiBaseKey:'api_base',providerKey:'provider',modelKey:'model',temperatureKey:'temperature',topPKey:'top_p',maxTokensKey:'max_tokens',statusKey:'status'};_vistaAiLoadProviders(aiCfg).then(()=>_vistaAiLoadSettings(aiCfg));},0);window.vistaShow=function(id,html){const el=document.querySelector('[data-face-id="'+id+'"]');if(!el){return false;}el.outerHTML=html;render();bindInputs();return true;};document.addEventListener('DOMContentLoaded', ()=>{render();bindInputs();});
document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('[data-tabs]').forEach(container=>{const buttons=[...container.querySelectorAll('.vista-tab-btn')];const panels=[...container.querySelectorAll('.vista-tab-panel')];const activate=id=>{buttons.forEach(btn=>{btn.classList.toggle('is-active',btn.dataset.tab===id);});panels.forEach(panel=>{panel.classList.toggle('is-active',panel.dataset.tab===id);});};let selectedIndex=parseInt(container.dataset.tabsSelected||'0',10);if(isNaN(selectedIndex)){selectedIndex=0;}if(buttons.length>0){const idx=Math.max(0,Math.min(selectedIndex,buttons.length-1));activate(buttons[idx].dataset.tab);}buttons.forEach((btn,idx)=>{btn.addEventListener('click',()=>activate(btn.dataset.tab));btn.addEventListener('keydown',e=>{if(e.key==='ArrowRight'){e.preventDefault();const next=(idx+1)%buttons.length;buttons[next].click();buttons[next].focus();}else if(e.key==='ArrowLeft'){e.preventDefault();const prev=(idx-1+buttons.length)%buttons.length;buttons[prev].click();buttons[prev].focus();}else if(e.key==='Home'){e.preventDefault();buttons[0].click();buttons[0].focus();}else if(e.key==='End'){e.preventDefault();buttons[buttons.length-1].click();buttons[buttons.length-1].focus();}});});});});
document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.vista-menubar').forEach(bar=>{const buttons=[...bar.querySelectorAll('[data-menu]')];const panels=[...bar.querySelectorAll('[data-menu-panel]')];let openKey=null;const closeAll=()=>{panels.forEach(p=>p.classList.remove('is-open'));buttons.forEach(b=>b.classList.remove('is-active'));openKey=null;};const openMenu=(key,btn)=>{const panel=panels.find(p=>p.dataset.menuPanel===key);if(!panel){return;}panels.forEach(p=>p.classList.toggle('is-open',p===panel));buttons.forEach(b=>b.classList.toggle('is-active',b===btn));const barRect=bar.getBoundingClientRect();const btnRect=btn.getBoundingClientRect();panel.style.left=(btnRect.left-barRect.left)+'px';panel.style.top=(barRect.height+4)+'px';openKey=key;};buttons.forEach(btn=>{btn.addEventListener('click',e=>{e.stopPropagation();const key=btn.dataset.menu;if(openKey===key){closeAll();}else{openMenu(key,btn);}});btn.addEventListener('mouseenter',()=>{if(openKey){openMenu(btn.dataset.menu,btn);}});});document.addEventListener('click',()=>{if(openKey){closeAll();}});document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeAll();}});panels.forEach(panel=>{panel.addEventListener('click',e=>e.stopPropagation());});});});
document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('table[data-row-select]').forEach(table=>{table.querySelectorAll('tbody tr').forEach(row=>{row.addEventListener('click',()=>{table.querySelectorAll('tbody tr').forEach(r=>r.classList.remove('is-selected'));row.classList.add('is-selected');table.dataset.selectedText=row.textContent.trim();});});});});
document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('[data-rate]').forEach(el=>{const ms=parseInt(el.getAttribute('data-rate')||'0',10);if(!(ms>0)){return;}const tickCode=el.getAttribute('data-rate-on-tick')||'';setInterval(()=>{try{if(window.__vistaAllowDynamicEval&&tickCode){(new Function('event','value',tickCode)).call(el,null,('value' in el)?el.value:el.textContent);}}catch(_e){}try{el.dispatchEvent(new CustomEvent('vista-rate-tick'));}catch(_e2){}},ms);});document.querySelectorAll('[data-feel-drag]').forEach(el=>{let down=false,sx=0,sy=0;const code=el.getAttribute('data-feel-drag')||'';let fn=null;try{if(window.__vistaAllowDynamicEval&&code){fn=new Function('dx','dy','event',code);}}catch(_e){}const start=(x,y,e)=>{down=true;sx=x;sy=y;};const move=(x,y,e)=>{if(!down||!fn){return;}try{fn.call(el,x-sx,y-sy,e);}catch(_e3){}};const end=()=>{down=false;};if(window.PointerEvent){el.addEventListener('pointerdown',e=>{if(e.pointerType==='mouse'&&e.button!==0){return;}start(e.clientX,e.clientY,e);});window.addEventListener('pointermove',e=>{move(e.clientX,e.clientY,e);});window.addEventListener('pointerup',end);window.addEventListener('pointercancel',end);}else{el.addEventListener('mousedown',e=>{start(e.clientX,e.clientY,e);});window.addEventListener('mousemove',e=>{move(e.clientX,e.clientY,e);});window.addEventListener('mouseup',end);el.addEventListener('touchstart',e=>{if(!e.touches||e.touches.length===0){return;}const t=e.touches[0];start(t.clientX,t.clientY,e);},{passive:true});window.addEventListener('touchmove',e=>{if(!e.touches||e.touches.length===0){return;}const t=e.touches[0];move(t.clientX,t.clientY,e);if(down){e.preventDefault();}},{passive:false});window.addEventListener('touchend',end);window.addEventListener('touchcancel',end);}});});


