; Vista UI Framework for Arturo - Modeling Rebol View
; Generates HTML5 UI from declarative blocks, rendered via WebView/HTML5

import "vista-graphics.art"!

; Face types: functions that generate HTML for UI elements
button: function [text action attrs] [
        attrsVal: attrs
        if equal? attrsVal null [
            attrsVal: #[]
        ]
        textStr: ""
        if notEqual? text null [
            textStr: to :string text
        ]
        actionStr: ""
        if [action notEqual? null] [
            actionStr: to :string action
        ]
        attrStr: attrs_to_html attrsVal
        html: "<button" ++ attrStr
        switch equal? actionStr "" [
            html: html ++ ">"
        ][
            html: html ++ " onclick=\""
            html: html ++ actionStr
            html: html ++ "\">"
        ]
        html ++ textStr ++ "</button>"
]

key_button: function [text bindName attrs] [
        attrsVal: attrs
        if attrsVal equal? null [
            attrsVal: #[]
        ]
        textStr: ""
        if notEqual? text null [
            textStr: to :string text
        ]
        bindStr: ""
        if bindName notEqual? null [
            bindStr: to :string bindName
        ]
        merged: merge_class_attr attrsVal "vista-key"
        attrs: merged\attrs
        if key? merged "class" [
            attrs\class: merged\class
        ]
        if bindStr notEqual? "" [
            attrs\["data-key-bind"]: bindStr
        ]
        if not? key? attrs "tabindex" [
            attrs\tabindex: 0
        ]
        attrStr: attrs_to_html attrs
        "<button" ++ attrStr ++ ">" ++ textStr ++ "</button>"
]

text: function [content] [
        contentStr: html_text content
        "<span>" ++ contentStr ++ "</span>"
]

title: function [content attrs] [
        merged: merge_class_attr attrs "vista-title"
        attrStr: attrs_to_html merged\attrs
        contentStr: html_text content
        "<h1 class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ contentStr ++ "</h1>"
]

subtitle: function [content attrs] [
        merged: merge_class_attr attrs "vista-subtitle"
        attrStr: attrs_to_html merged\attrs
        contentStr: html_text content
        "<h2 class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ contentStr ++ "</h2>"
]

field: function [value] [
        "<input type='text' value='" ++ to :string value ++ "'>"
]

label: function [content] [
        contentStr: html_text content
        "<label>" ++ contentStr ++ "</label>"
]

box: function [content attrs] [
        merged: merge_class_attr attrs "vista-box"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

panel_face: function [titleHtml bodyHtml attrs] [
        merged: merge_class_attr attrs "vista-panel"
        attrStr: attrs_to_html merged\attrs
        html: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        if titleHtml notEqual? "" [
            html: html ++ "<div class='vista-panel-title'>" ++ titleHtml ++ "</div>"
        ]
        html: html ++ "<div class='vista-panel-body'>" ++ bodyHtml ++ "</div></div>"
        html
]

grid_face: function [content attrs cols] [
        merged: merge_class_attr attrs "vista-grid"
        attrStr: attrs_to_html merged\attrs
        html: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ " style='display: grid; grid-template-columns: repeat("
        html: html ++ to :string cols
        html: html ++ ", 1fr);'>"
        html: html ++ content ++ "</div>"
        html
]

spacer_face: function [attrs] [
        attrStr: attrs_to_html attrs
        "<div class='vista-spacer'" ++ attrStr ++ "></div>"
]

table_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table"
        attrStr: attrs_to_html merged\attrs
        "<table class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</table>"
]

table_row_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-row"
        attrStr: attrs_to_html merged\attrs
        contentStr: ""
        if notEqual? content null [
            contentStr: to :string content
        ]
        "<tr class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ contentStr ++ "</tr>"
]

table_cell_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-cell"
        attrStr: attrs_to_html merged\attrs
        contentStr: ""
        if notEqual? content null [
            contentStr: to :string content
        ]
        "<td class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ contentStr ++ "</td>"
]

table_head_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-head"
        attrStr: attrs_to_html merged\attrs
        "<thead class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</thead>"
]

table_body_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-body"
        attrStr: attrs_to_html merged\attrs
        "<tbody class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</tbody>"
]

table_foot_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-foot"
        attrStr: attrs_to_html merged\attrs
        "<tfoot class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</tfoot>"
]

table_header_cell_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-table-header"
        attrStr: attrs_to_html merged\attrs
        "<th class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</th>"
]

toolbar_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-toolbar"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

menubar_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-menubar"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

tool_group_face: function [content attrs] [
        merged: merge_class_attr attrs "vista-tool-group"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

canvas_face: function [attrs] [
        merged: merge_class_attr attrs "vista-canvas"
        attrStr: attrs_to_html merged\attrs
        "<canvas class='" ++ merged\class ++ "'" ++ attrStr ++ "></canvas>"
]

canvas_draw_script: function [face] [
        if not? key? face "meta" [
                return ""
        ]
        if not? key? face\meta "draw" [
                return ""
        ]
        drawBlock: face\meta\draw
        if not? key? face\attrs "id" [
                return ""
        ]
        canvasId: face\attrs\id
        draw_script canvasId drawBlock
]

divider_face: function [attrs] [
        merged: merge_class_attr attrs "vista-divider"
        attrStr: attrs_to_html merged\attrs
        "<hr class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
]

split_face: function [leftHtml rightHtml attrs ratio] [
        merged: merge_class_attr attrs "vista-split"
        attrStr: attrs_to_html merged\attrs
        leftStyle: ""
        rightStyle: ""
        if ratio notEqual? null [
            ratioNum: ratio
            if ratioNum less? 1 [
                ratioNum: ratioNum * 100
            ]
            leftStr: to :string ratioNum
            rightStr: to :string (100 - ratioNum)
            leftStyle: " style='flex-basis: " ++ leftStr ++ "%;'"
            rightStyle: " style='flex-basis: " ++ rightStr ++ "%;'"
        ]
        html: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        html: html ++ "<div class='vista-split-pane'" ++ leftStyle ++ ">" ++ leftHtml ++ "</div>"
        html: html ++ "<div class='vista-split-pane'" ++ rightStyle ++ ">" ++ rightHtml ++ "</div>"
        html ++ "</div>"
]

text_list: function [items attrs] [
        merged: merge_class_attr attrs "vista-text-list"
        attrStr: attrs_to_html merged\attrs
        html: "<ul class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        i: 0
        items_len: size items
        while [less? i items_len][
            val: get items i
            val_type: type val
            switch equal? val_type :word [
                lit: to :literal val
                if set? lit [
                    val: do to :string val
                ]
            ][
                val: val
            ]
            html: html ++ "<li>"
            html: html ++ html_text val
            html: html ++ "</li>"
            i: i + 1
        ]
        html: html ++ "</ul>"
        html
]

text_list_bind: function [items bindings attrs] [
        merged: merge_class_attr attrs "vista-text-list"
        attrStr: attrs_to_html merged\attrs
        html: "<ul class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        i: 0
        items_len: size items
        while [less? i items_len][
            val: get items i
            val_type: type val
            switch equal? val_type :word [
                add_binding bindings val
                val_str: to :string val
                html: html ++ "<li data-bind='"
                html: html ++ val_str
                html: html ++ "'></li>"
            ][
                html: html ++ "<li>"
                html: html ++ html_text val
                html: html ++ "</li>"
            ]
            i: i + 1
        ]
        html: html ++ "</ul>"
        html
]

list_face_bind: function [items bindName multi bindings attrs] [
        merged: merge_class_attr attrs "vista-list"
        merged\attrs\["data-list-bind"]: bindName
        merged\attrs\["data-multi"]: to :string multi
        if not? key? merged\attrs "tabindex" [
            merged\attrs\tabindex: 0
        ]
        attrStr: attrs_to_html merged\attrs
        html: "<ul class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        i: 0
        items_len: size items
        while [less? i items_len][
            val: get items i
            val_type: type val
            switch equal? val_type :word [
                lit: to :literal val
                if set? lit [
                    val: do to :string val
                ]
            ][
                val: val
            ]
            valStr: to :string val
            valAttr: html_escape_attr valStr
            html: html ++ "<li data-value='" ++ valAttr ++ "'>"
            html: html ++ html_text val
            html: html ++ "</li>"
            i: i + 1
        ]
        html: html ++ "</ul>"
        html
]

row: function [content attrs] [
        merged: merge_class_attr attrs "vista-row"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

col: function [content attrs] [
        merged: merge_class_attr attrs "vista-col"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

group: function [content attrs] [
        attrStr: attrs_to_html attrs
        "<div" ++ attrStr ++ ">" ++ content ++ "</div>"
]

sensor_face: function [content attrs] [
        if key? attrs "onclick" [
                if not? key? attrs "tabindex" [
                        attrs\tabindex: 0
                ]
                if not? key? attrs "role" [
                        attrs\role: "button"
                ]
                if not? key? attrs "onkeydown" [
                        attrs\onkeydown: "if(event.key==='Enter'||event.key===' '){event.preventDefault();" ++ to :string attrs\onclick ++ ";}"
                ]
                switch key? attrs "class" [
                        attrs\class: to :string attrs\class ++ " vista-clickable"
                ][
                        attrs\class: "vista-clickable"
                ]
        ]
        merged: merge_class_attr attrs "vista-sensor"
        attrStr: attrs_to_html merged\attrs
        "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ content ++ "</div>"
]

form: function [content attrs action] [
        attrStr: attrs_to_html attrs
        html: "<form" ++ attrStr
        switch equal? action "" [
            html: html ++ ">"
        ][
            html: html ++ " onsubmit=\""
            html: html ++ action
            html: html ++ "; return false;\">"
        ]
        html ++ content ++ "</form>"
]

checkbox: function [labelHtml bindName attrs] [
        merged: merge_class_attr attrs "vista-checkbox"
        disabledAttr: ""
        if key? attrs "disabled" [
            if attrs\disabled [
                disabledAttr: " disabled"
            ]
            attrs: attrs_without attrs "disabled"
        ]
        attrStr: attrs_to_html merged\attrs
        html: "<label class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        html: html ++ "<input type='checkbox' data-bind='" ++ bindName ++ "'" ++ disabledAttr ++ ">"
        switch equal? labelHtml "" [
            html: html ++ "</label>"
        ][
            html: html ++ "<span>" ++ labelHtml ++ "</span></label>"
        ]
        html
]

toggle: function [labelHtml bindName attrs] [
        merged: merge_class_attr attrs "vista-toggle"
        disabledAttr: ""
        if key? attrs "disabled" [
            if attrs\disabled [
                disabledAttr: " disabled"
            ]
            attrs: attrs_without attrs "disabled"
        ]
        attrStr: attrs_to_html merged\attrs
        html: "<label class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        html: html ++ "<input type='checkbox' data-bind='" ++ bindName ++ "'" ++ disabledAttr ++ ">"
        html: html ++ "<span class='vista-toggle-slider'></span>"
        switch equal? labelHtml "" [
            html: html ++ "</label>"
        ][
            html: html ++ "<span class='vista-toggle-label'>" ++ labelHtml ++ "</span></label>"
        ]
        html
]

input_field: function [bindName attrs] [
        inputType: "text"
        if key? attrs "type" [
            inputType: to :string attrs\type
        ]
        attrStr: attrs_to_html (attrs_without attrs "type")
        "<input type='" ++ inputType ++ "' data-bind='" ++ bindName ++ "'" ++ attrStr ++ ">"
]

slider_field: function [bindName attrs] [
        attrsVal: attrs
        if [notEqual? (type attrsVal) :dictionary [
            attrsVal: #[]
        ]
        merged: merge_class_attr attrsVal "vista-slider"
        mergedAttrs: merged\attrs
        unless key? mergedAttrs "type" [
            mergedAttrs\type: "range"
        ]
        input_field bindName mergedAttrs
]

rotary_field: function [bindName attrs] [
        attrsVal: attrs
        if [notEqual? (type attrsVal) :dictionary [
            attrsVal: #[]
        ]
        merged: merge_class_attr attrsVal "vista-rotary"
        mergedAttrs: merged\attrs
        unless key? mergedAttrs "type" [
            mergedAttrs\type: "range"
        ]
        input_field bindName mergedAttrs
]

textarea_field: function [bindName attrs value] [
        attrStr: attrs_to_html attrs
        html: "<textarea data-bind='" ++ bindName ++ "'" ++ attrStr ++ ">"
        if value notEqual? null [
            html: html ++ html_escape_attr (to :string value)
        ]
        html ++ "</textarea>"
]

select_field: function [bindName attrs options] [
        attrStr: attrs_to_html attrs
        html: "<select data-bind='" ++ bindName ++ "'" ++ attrStr ++ ">"
        opt_len: size options
        i: 0
        while [less? i opt_len][
            opt: get options i
            opt_type: type opt
            switch equal? opt_type :block [
                if (size opt) equal? 2 [
                    val: get opt 0
                    lbl: get opt 1
                    html: html ++ "<option value='"
                    html: html ++ html_escape_attr (to :string val)
                    html: html ++ "'>"
                    html: html ++ html_text lbl
                    html: html ++ "</option>"
                ]
            ][
                html: html ++ "<option value='"
                html: html ++ html_escape_attr (to :string opt)
                html: html ++ "'>"
                html: html ++ html_text opt
                html: html ++ "</option>"
            ]
            i: i + 1
        ]
        html ++ "</select>"
]

radio_group: function [bindName attrs options bindings] [
        merged: merge_class_attr attrs "vista-radio-group"
        attrStr: attrs_to_html merged\attrs
        html: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
        opt_len: size options
        i: 0
        while [less? i opt_len][
            opt: get options i
            opt_type: type opt
            opt_value: ""
            opt_label: ""
            label_block: false
            opt_attrs: #[]
            switch equal? opt_type :block [
                switch equal? (size opt) 2 [
                    opt_value: to :string (get opt 0)
                    label_part: get opt 1
                    switch equal? (type label_part) :block [
                        inner: layout_state label_part
                        merge_bindings bindings inner\bindings
                        opt_label: inner\html
                        label_block: true
                    ][
                        opt_label: html_text label_part
                    ]
                ][
                    switch equal? (size opt) 3 [
                        opt_value: to :string (get opt 0)
                        label_part: get opt 1
                        opt_attrs: get opt 2
                        switch equal? (type label_part) :block [
                            inner: layout_state label_part
                            merge_bindings bindings inner\bindings
                            opt_label: inner\html
                            label_block: true
                        ][
                            opt_label: html_text label_part
                        ]
                    ][
                        opt_value: to :string opt
                        opt_label: html_text opt
                    ]
                ][
                    opt_value: to :string opt
                    opt_label: html_text opt
                ]
            ][
                opt_value: to :string opt
                opt_label: html_text opt
            ]
            optAttrStr: ""
            if [equal? (type opt_attrs) :dictionary [
                optAttrStr: attrs_to_html opt_attrs
            ]
            html: html ++ "<label class='vista-radio-item'>"
            html: html ++ "<input type='radio' data-bind='"
            html: html ++ bindName
            html: html ++ "' name='"
            html: html ++ bindName
            html: html ++ "' value='"
            html: html ++ html_escape_attr opt_value
            html: html ++ "'" ++ optAttrStr ++ ">"
            switch label_block [
                html: html ++ opt_label ++ "</label>"
            ][
                html: html ++ "<span>" ++ opt_label ++ "</span></label>"
            ]
            i: i + 1
        ]
        html ++ "</div>"
]

image_face: function [src attrs] [
        attrStr: attrs_to_html attrs
        srcStr: html_escape_attr (to :string src)
        "<img src='" ++ srcStr ++ "'" ++ attrStr ++ ">"
]

progress_face: function [value attrs] [
        attrStr: attrs_to_html attrs
        valueStr: html_escape_attr (to :string value)
        "<progress value='" ++ valueStr ++ "'" ++ attrStr ++ "></progress>"
]

webview_title: "ARTURO/VISTA"
webview_width: 900
webview_height: 600
webview_debug: false
webview_enabled: true
webview_auto_reload: false
webview_reload_ms: 1000
webview_sync_updates: false
webview_sync_state_updates: false
webview_state_sync_ms: 0
webview_state_sync_from_ui: false
webview_state_push_ms: 150
vista_app_header: #[]
vista_app_logo_path: "arturo-vista.png"
vista_css: "*{box-sizing:border-box;}" ++
    ":root{--arturo-primary:#f2c230;--arturo-ink:#141414;--arturo-muted:#4b4b4b;--arturo-bg:#f7f6f1;--arturo-panel:#ffffff;--arturo-border:#ded6c2;--arturo-focus:#1f1f1f;}" ++
    "body{font-family:'IBM Plex Sans','Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif;margin:0;background:var(--arturo-bg);color:var(--arturo-ink);}" ++
    "button,input,select,textarea{font:inherit;}" ++
    "button{cursor:pointer;}" ++
    "a{color:inherit;}" ++
    ".vista-app-header{position:sticky;top:0;z-index:1000;background:var(--arturo-primary);color:var(--arturo-ink);border-bottom:2px solid var(--arturo-ink);}" ++
    ".vista-app-header-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;}" ++
    ".vista-app-logo{height:28px;width:auto;display:block;}" ++
    ".vista-app-mark{font-weight:800;letter-spacing:0.2em;text-transform:uppercase;}" ++
    ".vista-app-title{font-size:18px;font-weight:700;}" ++
    ".vista-app-body{max-width:1100px;margin:0 auto;padding:16px;}" ++
    ".vista-row,.vista-layout-across{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}" ++
    ".vista-col,.vista-layout-below{display:flex;flex-direction:column;gap:8px;}" ++
    ".vista-layout-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}" ++
    ".vista-box{border:1px solid var(--arturo-border);background:var(--arturo-panel);border-radius:10px;padding:12px;}" ++
    ".vista-panel{border:1px solid var(--arturo-border);background:var(--arturo-panel);border-radius:12px;overflow:hidden;}" ++
    ".vista-panel-title{padding:8px 10px;font-weight:700;background:var(--arturo-primary);border-bottom:1px solid var(--arturo-ink);}" ++
    ".vista-panel-body{padding:12px;}" ++
    ".vista-grid{gap:8px;}" ++
    ".vista-spacer{min-height:8px;min-width:8px;}" ++
    ".vista-table{width:100%;border-collapse:collapse;background:var(--arturo-panel);}" ++
    ".vista-table th,.vista-table td{border:1px solid var(--arturo-border);padding:8px 10px;text-align:left;}" ++
    ".vista-table tbody tr:hover{background:#fbf0c2;}" ++
    ".vista-table tr.is-selected{background:#f7e199;}" ++
    ".vista-toolbar,.vista-menubar{display:flex;gap:6px;align-items:center;padding:6px 8px;background:var(--arturo-primary);border:1px solid var(--arturo-ink);border-radius:10px;}" ++
    ".vista-menubar{position:relative;}" ++
    ".vista-menu-panel{position:absolute;top:calc(100% + 4px);min-width:160px;background:var(--arturo-panel);border:1px solid var(--arturo-border);border-radius:8px;padding:6px;box-shadow:0 8px 20px rgba(0,0,0,0.12);display:none;z-index:1000;}" ++
    ".vista-menu-panel.is-open{display:block;}" ++
    ".vista-menu-item{display:block;width:100%;text-align:left;}" ++
    ".vista-tool-group{display:flex;gap:6px;align-items:center;}" ++
    ".vista-divider{border:none;border-top:1px solid var(--arturo-border);margin:8px 0;}" ++
    ".vista-canvas{border:1px solid var(--arturo-border);border-radius:8px;}" ++
    ".vista-split{display:flex;gap:8px;}" ++
    ".vista-split-pane{flex:1;}" ++
    ".vista-text-list{padding-left:18px;margin:0;}" ++
    ".vista-list{list-style:none;padding:0;margin:0;border:1px solid var(--arturo-border);border-radius:10px;background:var(--arturo-panel);max-height:220px;overflow:auto;}" ++
    ".vista-list li{padding:6px 8px;border-bottom:1px solid var(--arturo-border);cursor:pointer;}" ++
    ".vista-list li:last-child{border-bottom:none;}" ++
    ".vista-list li.is-selected{background:#f7e199;}" ++
    ".vista-list li.is-active{outline:2px solid var(--arturo-ink);}" ++
    ".vista-tabs{display:flex;flex-direction:column;gap:6px;}" ++
    ".vista-tabs-header{display:flex;gap:6px;flex-wrap:wrap;}" ++
    ".vista-tab-btn{padding:6px 10px;border:1px solid var(--arturo-border);border-radius:8px;background:var(--arturo-panel);}" ++
    ".vista-tab-btn.is-active{background:var(--arturo-primary);border-color:var(--arturo-ink);}" ++
    ".vista-tab-panel{display:none;padding:10px;border:1px solid var(--arturo-border);border-radius:10px;background:var(--arturo-panel);}" ++
    ".vista-tab-panel.is-active{display:block;}" ++
    ".vista-key{min-width:120px;}" ++
    ".vista-radio-group{display:flex;flex-direction:column;gap:6px;}" ++
    ".vista-radio-item{display:flex;align-items:center;gap:6px;}"
vista_vid_css: "body.vista-vid{background:#e5e5e5;}" ++
    "body.vista-vid .vista-panel{border-radius:6px;border-color:#a9a9a9;}" ++
    "body.vista-vid .vista-panel-title{background:#d6d6d6;}" ++
    "body.vista-vid .vista-toolbar,body.vista-vid .vista-menubar{background:#dcdcdc;border-color:#b7b7b7;}" ++
    "body.vista-vid .vista-box{border-radius:4px;border-color:#a9a9a9;}" ++
    "body.vista-vid .vista-tab-btn{background:#efefef;}" ++
    "body.vista-vid .vista-tab-btn.is-active{background:#cfe0ff;}"

; Helpers for JS generation
js_escape_single: function [s] [
        s: replace s "\\" "\\\\"
        s: replace s "'" "\\'"
        s: replace s "\r" "\\r"
        s: replace s "\n" "\\n"
        s
]

html_escape_attr: function [s] [
        s: replace s "&" "&amp;"
        s: replace s "<" "&lt;"
        s: replace s ">" "&gt;"
        s: replace s "'" "&#39;"
        s: replace s "\"" "&quot;"
        s
]

html_escape_text: function [s] [
        s: replace s "&" "&amp;"
        s: replace s "<" "&lt;"
        s: replace s ">" "&gt;"
        s
]

logo_data_url: function [pathStr] [
        if any? @[equal? pathStr null equal? pathStr ""] [
                return ""
        ]
        if any? @[prefix? pathStr "data:" prefix? pathStr "http://" prefix? pathStr "https://"] [
                return pathStr
        ]
        if exists? pathStr [
                encoded: encode (read pathStr)
                return "data:image/png;base64," ++ encoded
        ]
        pathStr
]

is_raw_html: function [value] [
        if [equal? (type value) :dictionary [
                if key? value "raw" [
                        return value\raw
                ]
        ]
        false
]

raw: function [content] [
        #[
                raw: true
                value: to :string content
        ]
]

html_text: function [value] [
        if is_raw_html value [
                return value\value
        ]
        html_escape_text (to :string value)
]

normalize_block: function [block] [
        if [notEqual? (type block) :block [
                return block
        ]
        out: []
        i: 0
        blen: size block
        while [less? i blen][
                tok: get block i
                tok_type: type tok
                did_combine: false
                if any? @[equal? tok_type :word equal? tok_type :attributeLabel equal? tok_type :attribute] [
                        combinedStr: to :string tok
                        joinStr: "-"
                        if equal? tok_type :word [
                                joinStr: "_"
                        ]
                        j: i
                        saw_label: equal? tok_type :attributeLabel
                        while [less? (j + 2) blen][
                                mid: get block (j + 1)
                                tail: get block (j + 2)
                                tail_type: type tail
                                if not? all? @[equal? (type mid) :symbol equal? (to :string mid) "-" any? @[equal? tail_type :word equal? tail_type :label]] [
                                        break
                                ]
                                combinedStr: combinedStr ++ joinStr ++ (to :string tail)
                                if equal? tail_type :label [
                                        saw_label: true
                                ]
                                j: j + 2
                        ]
                        if greater? j i [
                                combined: null
                                switch equal? tok_type :attribute [
                                        switch saw_label [
                                                combined: to :attributeLabel combinedStr
                                        ][
                                                combined: to :attribute combinedStr
                                        ]
                                ][
                                        switch equal? tok_type :attributeLabel [
                                                combined: to :attributeLabel combinedStr
                                        ][
                                                combined: to :word combinedStr
                                        ]
                                ]
                                out: out ++ @[combined]
                                i: j + 1
                                did_combine: true
                        ]
                ]
                if not? did_combine [
                        out: out ++ @[tok]
                        i: i + 1
                ]
        ]
        out
]

strip_root_div: function [html] [
        if all? @[prefix? html "<div>" suffix? html "</div>"] [
                len: size html
                endIdx: len - 7
                if greaterOrEqual? endIdx 5 [
                        return slice html 5 endIdx
                ]
                return ""
        ]
        html
]

vista_styles: #[]
vista_state: #[
    face_counter: 0
    last_faces: #[]
    last_root: null
    face_names: #[]
    last_bindings: #[]
    layout_pending_attrs: #[]
    layout_scope_stack: @[]
    tabs_id_counter: 0
]
vista_vid_mode: false
vista_layout_vid_mode: false

next_face_id: function [] [
        vista_state\face_counter: vista_state\face_counter + 1
        "face-" ++ to :string vista_state\face_counter
]

register_face: function [faces parentId type attrs html] [
        id: next_face_id
        face: #[
                id: id
                type: type
                attrs: attrs
                html: html
                children: []
        ]
        faces\[id]: face
        if notEqual? parentId null [
                parent: faces\[parentId]
                if not? key? parent "children" [
                        parent\children: []
                ]
                parent\children: parent\children ++ @[id]
                faces\[parentId]: parent
        ]
        id
]

current_parent_id: function [stack] [
        len: size stack
        if equal? len 0 [
                return null
        ]
        get stack (len - 1)
]

register_face_name: function [face] [
        if key? face\attrs "id" [
                nameStr: to :string face\attrs\id
                vista_state\face_names\[nameStr]: face\id
        ]
]

set_face_attrs: function [faces id attrs] [
        if key? faces id [
                face: faces\[id]
                face\attrs: attrs
                faces\[id]: face
        ]
]

set_face_attrs_and_name: function [faces id attrs] [
        set_face_attrs faces id attrs
        if key? faces id [
                face: faces\[id]
                register_face_name face
        ]
]

set_face_html: function [faces id html] [
        if key? faces id [
                face: faces\[id]
                face\html: html
                faces\[id]: face
        ]
]

set_face_meta: function [faces id meta] [
        if key? faces id [
                face: faces\[id]
                face\meta: meta
                faces\[id]: face
        ]
]

with_face_id: function [attrs id] [
        attrs\["data-face-id"]: id
        attrs
]

merge_faces: function [dest src] [
        keysList: keys src
        i: 0
        keys_len: size keysList
        while [less? i keys_len][
                k: get keysList i
                dest\[k]: src\[k]
                i: i + 1
        ]
]

append_children_from_root: function [faces parentId rootId] [
        if any? @[equal? parentId null equal? rootId null] [
                return
        ]
        rootFace: faces\[rootId]
        if key? rootFace "children" [
                kids: rootFace\children
                klen: size kids
                i: 0
                while [less? i klen][
                        parent: faces\[parentId]
                        if not? key? parent "children" [
                                parent\children: []
                        ]
                        parent\children: parent\children ++ @[get kids i]
                        faces\[parentId]: parent
                        i: i + 1
                ]
        ]
]

style: function [name block] [
        nameStr: to :string name
        vista_styles\[nameStr]: block
]

; Rebol/View style aliases (core set)
style "h1" [title .class:"vista-h1" arg0]
style "h2" [title .class:"vista-h2" arg0]
style "h3" [title .class:"vista-h3" arg0]
style "h4" [title .class:"vista-h4" arg0]
style "h5" [title .class:"vista-h5" arg0]
style "vh1" [title .class:"vista-vh1" arg0]
style "vh2" [title .class:"vista-vh2" arg0]
style "vh3" [title .class:"vista-vh3" arg0]
style "banner" [title .class:"vista-banner" arg0]
style "info" [text .class:"vista-info" arg0]
style "tt" [text .class:"vista-tt" arg0]
style "code" [text .class:"vista-code" arg0]
style "vtext" [text .class:"vista-vtext" arg0]
style "area" [textarea .class:"vista-area" arg0]
style "choice" [select .class:"vista-choice" arg0 arg1]
style "check" [checkbox .class:"vista-check" arg0]
style "icon" [image .class:"vista-icon" arg0]
style "anim" [image .class:"vista-anim" arg0]
style "arrow" [button .class:"vista-arrow" arg0]
style "rotary" [slider .class:"vista-rotary" arg0]
style "led" [text .class:"vista-led" arg0]
style "sensor" [box .class:"vista-sensor" arg0]
style "backdrop" [box .class:"vista-backdrop" arg0]
style "backtile" [box .class:"vista-backtile" arg0]

apply_style_args: function [blk args attrs] [
        out: []
        blen: size blk
        i: 0
        while [less? i blen][
                item: get blk i
                item_type: type item
                switch equal? item_type :block [
                        out: out ++ @[apply_style_args item args attrs]
                ][
                        switch equal? item_type :word [
                                name: to :string item
                                switch equal? name "args" [
                                        out: out ++ @[args]
                                ][
                                        switch equal? name "attrs" [
                                                out: out ++ @[attrs]
                                        ][
                                                replaced: false
                                                j: 0
                                                alen: size args
                                                while [less? j alen][
                                                        if equal? name ("arg" ++ to :string j) [
                                                                out: out ++ @[get args j]
                                                                replaced: true
                                                                break
                                                        ]
                                                        j: j + 1
                                                ]
                                                if not? replaced [
                                                        out: out ++ @[item]
                                                ]
                                        ]
                                ]
                        ][
                                out: out ++ @[item]
                        ]
                ]
                i: i + 1
        ]
        out
]

get_face_path: function [path] [
    if [equal? (type path) :string [
        return get_face path
    ]
    if [equal? (type path) :word [
        return get_face path
    ]
    if [notEqual? (type path) :block [
        return null
    ]
    if [equal? (size path) 0 [
        return null
    ]
    idx: 0
    current: null
    first: get path 0
    first_type: type first
    switch any? @[equal? first_type :string equal? first_type :word] [
        current: get_face first
        switch equal? current null [
            current: get_face vista_state\last_root
            idx: 0
        ][
            idx: 1
        ]
    ][
        current: get_face vista_state\last_root
        idx: 0
    ]
    while [all? @[notEqual? current null less? idx (size path)]] [
        tok: get path idx
        tok_type: type tok
        if any? @[equal? tok_type :string equal? tok_type :word] [
            tname: to :string tok
            if all? @[equal? (slice tname 0 4) ".id:" greater? (size tname) 4] [
                nameStr: slice tname 4 (size tname)
                if key? vista_state\face_names nameStr [
                    current: get_face nameStr
                    idx: idx + 1
                    continue
                ]
            ]
            index: 0
            if less? idx + 1 (size path) [
                nextTok: get path (idx + 1)
                if [equal? (type nextTok) :integer [
                    index: nextTok
                    idx: idx + 1
                ]
            ]
            children: current\children
            found: null
            count: 0
            clen: size children
            c: 0
            while [less? c clen][
                cid: get children c
                child: vista_state\last_faces\[cid]
                if equal? child\type tname [
                    if equal? count index [
                        found: child
                        break
                    ]
                    count: count + 1
                ]
                c: c + 1
            ]
            current: found
        ]
        idx: idx + 1
    ]
    current
]

face_children_html: function [face] [
    if not? key? face "children" [
        return ""
    ]
    kids: face\children
    out: ""
    klen: size kids
    i: 0
    while [less? i klen][
        cid: get kids i
        if key? vista_state\last_faces cid [
            out: out ++ vista_state\last_faces\[cid]\html
        ]
        i: i + 1
    ]
    out
]

face_child_html: function [face index] [
    if not? key? face "children" [
        return ""
    ]
    kids: face\children
    if less? index (size kids) [
        cid: get kids index
        if key? vista_state\last_faces cid [
            return vista_state\last_faces\[cid]\html
        ]
    ]
    ""
]

update_panel_body: function [panelId newBlock] [
    panelFace: get_face panelId
    if equal? panelFace null [
        return null
    ]
    inner: layout_state newBlock
    merge_faces vista_state\last_faces inner\faces
    append_children_from_root vista_state\last_faces panelFace\id inner\root
    titleHtml: ""
    if key? panelFace "meta" [
        if key? panelFace\meta "titleHtml" [
            titleHtml: panelFace\meta\titleHtml
        ]
    ]
    faceHtml: panel_face titleHtml inner\html panelFace\attrs
    update_face panelFace\id #[html: faceHtml]
]

update_split_pane: function [splitId paneIndex newBlock] [
    splitFace: get_face splitId
    if equal? splitFace null [
        return null
    ]
    inner: layout_state newBlock
    merge_faces vista_state\last_faces inner\faces
    paneId: face_child_id splitFace paneIndex
    if equal? paneId null [
        return null
    ]
    append_children_from_root vista_state\last_faces paneId inner\root
    update_face splitFace\id #[html: render_face splitFace]
]

update_table_body: function [tableId newBlock] [
    tableFace: get_face tableId
    if equal? tableFace null [
        return null
    ]
    inner: layout_state newBlock
    merge_faces vista_state\last_faces inner\faces
    append_children_from_root vista_state\last_faces tableFace\id inner\root
    update_face tableFace\id #[html: render_face tableFace]
]

face_child_id: function [face index] [
    if not? key? face "children" [
        return null
    ]
    kids: face\children
    if less? index (size kids) [
        return get kids index
    ]
    null
]

tab_panel_id: function [tabsFace index] [
    if not? key? tabsFace "children" [
        return null
    ]
    kids: tabsFace\children
    count: 0
    i: 0
    klen: size kids
    while [less? i klen][
        cid: get kids i
        child: vista_state\last_faces\[cid]
        if equal? child\type "tab-panel" [
            if equal? count index [
                return cid
            ]
            count: count + 1
        ]
        i: i + 1
    ]
    null
]

update_face_path: function [path updates] [
    face: get_face_path path
    if equal? face null [
        return null
    ]
    update_face face\id updates
]

update_tab_panel: function [tabsId index newBlock] [
    tabsFace: get_face tabsId
    if equal? tabsFace null [
        return null
    ]
    panelId: tab_panel_id tabsFace index
    if equal? panelId null [
        return null
    ]
    inner: layout_state newBlock
    merge_faces vista_state\last_faces inner\faces
    append_children_from_root vista_state\last_faces panelId inner\root
    indexStr: to :string index
    panelAttrs: vista_state\last_faces\[panelId]\attrs
    attrStr: attrs_to_html panelAttrs
    panelHtml: "<div class='vista-tab-panel' data-tab='panel-" ++ indexStr ++ "'" ++ attrStr ++ ">" ++ inner\html ++ "</div>"
    update_face panelId #[html: panelHtml]
]

show_path: function [path] [
    face: get_face_path path
    if equal? face null [
        return null
    ]
    show face
]

set_state: function [key value] [
    keyStr: to :string key
    vista_state\last_bindings\[keyStr]: value
    if webview_sync_state_updates [
        valueStr: js_literal value
        js: "state['" ++ keyStr ++ "']=" ++ valueStr ++ "; render();"
        if webview_enabled [
            env_vars: env
            if not? any? @[key? env_vars "VISTA_NO_WEBVIEW" key? env_vars "NO_WEBVIEW"] [
                webview .inject: js ""
            ]
        ]
    ]
]

apply_state_from_ui: function [data] [
    if [equal? (type data) :dictionary [
        keysList: keys data
        i: 0
        klen: size keysList
        while [less? i klen][
            k: get keysList i
            v: data\[k]
            vista_state\last_bindings\[k]: v
            lit: to :literal k
            if set? lit [
                set lit v
            ]
            i: i + 1
        ]
    ]
]

sync_state: function [] [
    keysList: keys vista_state\last_bindings
    i: 0
    keys_len: size keysList
    while [less? i keys_len][
        k: get keysList i
        lit: to :literal k
        if set? lit [
            val: do k
            if notEqual? val vista_state\last_bindings\[k] [
                set_state k val
            ]
        ]
        i: i + 1
    ]
]

print_face_tree: function [] [
    root: get_face vista_state\last_root
    if equal? root null [
        print "No face tree"
        return
    ]
    walk_face_tree root 0
]

walk_face_tree: function [face depth] [
    indent: ""
    i: 0
    while [less? i depth][
        indent: indent ++ "  "
        i: i + 1
    ]
    nameStr: ""
    if key? face\attrs "id" [
        nameStr: " #" ++ to :string face\attrs\id
    ]
    print (indent ++ face\id ++ " (" ++ face\type ++ ")" ++ nameStr)
    if key? face "children" [
        kids: face\children
        klen: size kids
        j: 0
        while [less? j klen][
            cid: get kids j
            if key? vista_state\last_faces cid [
                walk_face_tree vista_state\last_faces\[cid] (depth + 1)
            ]
            j: j + 1
        ]
    ]
]

find_faces: function [criteria] [
    if [notEqual? (type criteria) :dictionary [
        return []
    ]
    results: []
    keysList: keys vista_state\last_faces
    klen: size keysList
    i: 0
    while [less? i klen][
        fid: get keysList i
        face: vista_state\last_faces\[fid]
        match: true
        if key? criteria "type" [
            if notEqual? face\type criteria\type [
                match: false
            ]
        ]
        if key? criteria "id" [
            idVal: criteria\["id"]
            hasId: key? face\attrs "id"
            if not? hasId [
                match: false
            ]
            if hasId [
                if notEqual? face\attrs\["id"] idVal [
                    match: false
                ]
            ]
        ]
        if key? criteria "attr" [
            attrName: criteria\attr
            if not? key? face\attrs attrName [
                match: false
            ]
        ]
        if match [
            results: results ++ @[face]
        ]
        i: i + 1
    ]
    results
]

find_face: function [criteria] [
    results: find_faces criteria
    if greater? (size results) 0 [
        return get results 0
    ]
    null
]

face_info: function [face] [
    if equal? face null [
        return "null"
    ]
    nameStr: ""
    if key? face\attrs "id" [
        nameStr: " #" ++ to :string face\attrs\id
    ]
    face\id ++ " (" ++ face\type ++ ")" ++ nameStr
]

face_tree: function [] [
    root: get_face vista_state\last_root
    if equal? root null [
        return []
    ]
    build_face_json root
]

json_escape: function [value] [
    out: ""
    s: to :string value
    i: 0
    len: size s
    while [less? i len][
        ch: get s i
        escaped: false
        if equal? ch "\\" [
            out: out ++ "\\\\"
            escaped: true
        ]
        if equal? ch "\"" [
            out: out ++ "\\\""
            escaped: true
        ]
        if equal? ch "\n" [
            out: out ++ "\\n"
            escaped: true
        ]
        if equal? ch "\r" [
            out: out ++ "\\r"
            escaped: true
        ]
        if equal? ch "\t" [
            out: out ++ "\\t"
            escaped: true
        ]
        if not? escaped [
            out: out ++ ch
        ]
        i: i + 1
    ]
    out
]

json_encode: function [value] [
    t: type value
    switch equal? t :string [
        "\"" ++ json_escape value ++ "\""
    ][
        switch equal? t :integer [
            to :string value
        ][
            switch equal? t :floating [
                to :string value
            ][
                switch equal? t :logical [
                    switch value [
                        "true"
                    ][
                        "false"
                    ]
                ][
                    switch equal? t :null [
                        "null"
                    ][
                        switch equal? t :dictionary [
                            keysList: keys value
                            i: 0
                            klen: size keysList
                            out: "{"
                            first: true
                            while [less? i klen][
                                k: get keysList i
                                v: value\[k]
                                if not? first [
                                    out: out ++ ","
                                ]
                                out: out ++ "\"" ++ json_escape k ++ "\":" ++ json_encode v
                                first: false
                                i: i + 1
                            ]
                            out ++ "}"
                        ][
                            switch equal? t :block [
                                i: 0
                                blen: size value
                                out: "["
                                first: true
                                while [less? i blen][
                                    item: get value i
                                    if not? first [
                                        out: out ++ ","
                                    ]
                                    out: out ++ json_encode item
                                    first: false
                                    i: i + 1
                                ]
                                out ++ "]"
                            ][
                                "\"" ++ json_escape (to :string value) ++ "\""
                            ]
                        ]
                    ]
                ]
            ]
        ]
    ]
]

face_tree_json: function [] [
    json_encode face_tree
]

json_pretty: function [json] [
    indent: 0
    inString: false
    escapeNext: false
    out: ""
    len: size json
    i: 0
    while [less? i len][
        ch: get json i
        if escapeNext [
            out: out ++ ch
            escapeNext: false
            i: i + 1
            continue
        ]
        if equal? ch "\\" [
            out: out ++ ch
            if inString [ escapeNext: true ]
            i: i + 1
            continue
        ]
        if equal? ch "\"" [
            inString: not inString
            out: out ++ ch
            i: i + 1
            continue
        ]
        if inString [
            out: out ++ ch
            i: i + 1
            continue
        ]
        if any? @[equal? ch "{" equal? ch "["] [
            indent: indent + 1
            out: out ++ ch ++ "\n" ++ repeat "  " indent
            i: i + 1
            continue
        ]
        if any? @[equal? ch "}" equal? ch "]"] [
            indent: indent - 1
            out: out ++ "\n" ++ repeat "  " indent ++ ch
            i: i + 1
            continue
        ]
        if equal? ch "," [
            out: out ++ ch ++ "\n" ++ repeat "  " indent
            i: i + 1
            continue
        ]
        if equal? ch ":" [
            out: out ++ ": "
            i: i + 1
            continue
        ]
        out: out ++ ch
        i: i + 1
    ]
    out
]

face_tree_pretty: function [] [
    json_pretty face_tree_json
]

face_tree_by_id: function [criteria] [
    crit: criteria
    if [equal? (type criteria) :string [
        crit: #[id: criteria]
    ]
    face: find_face crit
    if equal? face null [
        return []
    ]
    build_face_json face
]

face_tree_by_id_json: function [criteria] [
    json_encode (face_tree_by_id criteria)
]

face_tree_overlay: function [] [
    json: face_tree_json
    raw (
        "<div id='vista-face-overlay' style='position:fixed;right:8px;bottom:8px;max-width:42%;max-height:55%;overflow:auto;background:#111;color:#e6e6e6;border:1px solid #333;padding:8px 10px;font:12px/1.4 monospace;z-index:99999;'>" ++
        "<div style='font-weight:bold;margin-bottom:6px;'>Vista Inspector</div>" ++
        "<input id='vista-face-search' placeholder='Search faces...' style='width:100%;box-sizing:border-box;margin-bottom:6px;background:#1a1a1a;color:#e6e6e6;border:1px solid #333;padding:4px 6px;'>" ++
        "<div id='vista-face-results' style='max-height:180px;overflow:auto;border:1px solid #333;padding:4px;'></div>" ++
        "<div style='margin-top:6px;display:flex;gap:6px;align-items:center;'>" ++
        "<button id='vista-face-refresh' style='background:#222;color:#e6e6e6;border:1px solid #333;padding:2px 6px;cursor:pointer;'>Refresh</button>" ++
        "<span style='opacity:0.7;'>Click a face to highlight</span>" ++
        "</div>" ++
        "<div style='margin-top:6px;opacity:0.7;'>State</div>" ++
        "<pre id='vista-state-pre' style='margin:4px 0 0 0;white-space:pre-wrap;max-height:140px;overflow:auto;background:#0f0f0f;border:1px solid #333;padding:4px;'></pre>" ++
        "</div>" ++
        "<script>" ++
        "const vistaFaceTree=" ++ json ++ ";" ++
        "const flatten=(node,arr)=>{if(!node){return;}arr.push(node);(node.children||[]).forEach(c=>flatten(c,arr));};" ++
        "const list=[];flatten(vistaFaceTree,list);" ++
        "const renderList=(q)=>{const wrap=document.getElementById('vista-face-results');if(!wrap){return;}const term=(q||'').toLowerCase();const items=list.filter(n=>{const name=(n.name||'');return (n.id||'').toLowerCase().includes(term)||name.toLowerCase().includes(term)||(n.type||'').toLowerCase().includes(term);});wrap.innerHTML=items.map(n=>`<div style='padding:2px 0;'><button data-id='${n.id}' style='background:#1b1b1b;color:#e6e6e6;border:1px solid #333;padding:1px 4px;cursor:pointer;'>${n.id}</buttongreater? <span style='opacity:0.7'>(${n.type}${n.name?(' #' + n.name):''})</span></div>`).join('');wrap.querySelectorAll('button[data-id]').forEach(btn=>{btn.addEventListener('click',()=>highlight(btn.dataset.id));});};" ++
        "const highlight=(id)=>{document.querySelectorAll('[data-vista-highlight]').forEach(el=>{el.style.outline='';el.removeAttribute('data-vista-highlight');});const el=document.querySelector(`[data-face-id=\"${id}\"]`);if(!el){return;}el.setAttribute('data-vista-highlight','true');el.style.outline='2px solid #ffb347';el.scrollIntoView({block:'center',behavior:'smooth'});};" ++
        "const renderState=()=>{const pre=document.getElementById('vista-state-pre');if(!pre){return;}if(window.state){pre.textContent=JSON.stringify(window.state,null,2);}else{pre.textContent='(state not ready)';}};" ++
        "document.addEventListener('DOMContentLoaded',()=>{const input=document.getElementById('vista-face-search');if(input){input.addEventListener('input',e=>renderList(e.target.value));}const refresh=document.getElementById('vista-face-refresh');if(refresh){refresh.addEventListener('click',()=>renderState());}renderList('');setTimeout(renderState,50);});" ++
        "</script>"
    )
]

build_face_json: function [face] [
    obj: #[
        id: face\id
        type: face\type
    ]
    if key? face\attrs "id" [
        obj\name: to :string face\attrs\id
    ]
    kids: []
    if key? face "children" [
        clen: size face\children
        i: 0
        while [less? i clen][
            cid: get face\children i
            if key? vista_state\last_faces cid [
                kids: kids ++ @[build_face_json vista_state\last_faces\[cid]]
            ]
            i: i + 1
        ]
    ]
    obj\children: kids
    obj
]

path_first: function [path] [
    if [equal? (type path) :block [
        return get_face_path (path ++ [0])
    ]
    null
]

path_last: function [path] [
    face: get_face_path path
    if equal? face null [
        return null
    ]
    if not? key? face "children" [
        return null
    ]
    count: size face\children
    if equal? count 0 [
        return null
    ]
    get_face_path (path ++ [count - 1])
]

path_nth: function [path index] [
    if [equal? (type path) :block [
        return get_face_path (path ++ [index])
    ]
    null
]

is_keyword: function [item block] [
        item_type: type item
        switch equal? item_type :word [
            name: to :string item
            if key? vista_styles name [
                if set? name [
                    return false
                ]
                return true
            ]
            in? name ["across" "below" "return" "end" "pad" "space" "align" "valign" "size" "origin" "offset" "indent" "guide" "do" "scope" "raw" "text" "title" "subtitle" "field" "info" "button" "key" "label" "box" "panel" "text-list" "text_list" "list" "row" "col" "grid" "spacer" "group" "form" "checkbox" "toggle" "input" "slider" "rotary" "textarea" "select" "drop-list" "drop_list" "radio" "radio-group" "radio_group" "tabs" "tab" "image" "icon" "anim" "progress" "table" "table-row" "table_row" "table-cell" "table_cell" "table-header" "table_header" "table-head" "table_head" "table-body" "table_body" "table-foot" "table_foot" "toolbar" "menubar" "tool-group" "tool_group" "canvas" "divider" "split" "sensor" "pen" "fill-pen" "line-width" "line-cap" "line-join" "line" "box" "circle" "ellipse" "polygon" "text" "font" "image" "push" "pop" "translate" "rotate" "scale" "skew" "smooth" "coord-system" "text-baseline" "text-align" "linear-gradient" "radial-gradient"]
        ][
            ; Also check for compound keywords like "-width" from "line-width" tokenized as "line - width"
            switch equal? item_type :symbol [
                if not? block [
                    return false
                ]
                name: to :string item
                if not? equal? name "-" [
                    return false
                ]
                ; This is a "-" symbol, check if next token is part of a compound keyword
                blen: size block
                found_idx: -1
                j: 0
                while [less? j blen] [
                    if [equal? (get block j) item [
                        found_idx: j
                        break
                    ]
                    j: j + 1
                ]
                if equal? found_idx -1 [
                    return false
                ]
                if less? (found_idx + 2) blen [
                    tail: get block (found_idx + 2)
                    tail_type: type tail
                    if any? @[equal? tail_type :word equal? tail_type :label] [
                        tailName: to :string tail
                        ; Check if "-" + tailName forms a known compound keyword suffix
                        compoundSuf: "-" ++ tailName
                        suffixes: ["-width" "-pen" "-cap" "-join" "-system" "-baseline" "-align" "-gradient"]
                        in? compoundSuf suffixes
                    ] [
                        false
                    ]
                ] [
                    false
                ]
            ][
                false
            ]
        ]
]

append_value: function [lst val] [
        lst ++ @[val]
]

parse_attrs: function [args] [
        attrs: #[]
        rest: []
        i: 0
        args_len: size args
        while [less? i args_len][
            tok: get args i
            tok_type: type tok
            switch equal? tok_type :attributeLabel [
                name: to :string tok
                advance: 1
                if less? i + 2 args_len [
                    mid: get args (i + 1)
                    tail: get args (i + 2)
                    if all? @[equal? (type mid) :symbol equal? (to :string mid) "-" equal? (type tail) :word] [
                        name: name ++ "-" ++ to :string tail
                        advance: 3
                    ]
                ]
                switch less? i + advance args_len [
                    val: get args (i + advance)
                    handled: false
                    if [equal? (type val) :symbol [
                        if [equal? (to :string val) "#" [
                            if less? (i + advance + 1) args_len [
                                nextVal: get args (i + advance + 1)
                                if [equal? (type nextVal) :block [
                                    attrs\[name]: header_from_block nextVal
                                    i: i + advance + 2
                                    handled: true
                                ]
                            ]
                        ]
                    ]
                    if not? handled [
                        attrs\[name]: val
                        i: i + advance + 1
                    ]
                ][
                    i: i + 1
                ]
            ][
                switch equal? tok_type :attribute [
                    name: to :string tok
                    if less? i + 2 args_len [
                        mid: get args (i + 1)
                        tail: get args (i + 2)
                        if all? @[equal? (type mid) :symbol equal? (to :string mid) "-" equal? (type tail) :word] [
                            name: name ++ "-" ++ to :string tail
                            i: i + 3
                            attrs\[name]: true
                            continue
                        ]
                    ]
                    attrs\[name]: true
                    i: i + 1
                ][
                    rest: append_value rest tok
                    i: i + 1
                ]
            ]
        ]
        #[
            attrs: attrs
            args: rest
        ]
]

attrs_to_html: function [attrs] [
        keysList: keys attrs
        keys_len: size keysList
        if equal? keys_len 0 [
            return ""
        ]
        html: ""
        i: 0
        while [less? i keys_len][
            k: get keysList i
            v: attrs\[k]
            v_type: type v
            switch equal? v_type :logical [
                if v [
                    html: html ++ " " ++ k
                ]
            ][
                html: html ++ " " ++ k ++ "='"
                html: html ++ html_escape_attr (to :string v)
                html: html ++ "'"
            ]
            i: i + 1
        ]
        html
]

attrs_without: function [attrs key] [
        filtered: #[]
        keysList: keys attrs
        i: 0
        keys_len: size keysList
        while [less? i keys_len][
            k: get keysList i
            if notEqual? k key [
                filtered\[k]: attrs\[k]
            ]
            i: i + 1
        ]
        filtered
]

take_attr: function [attrs key] [
        val: null
        if key? attrs key [
            val: attrs\[key]
            attrs: attrs_without attrs key
        ]
        #[
            value: val
            attrs: attrs
        ]
]

append_style: function [style fragment] [
        switch equal? style "" [
            fragment
        ][
            style ++ " " ++ fragment
        ]
]

has_style_dim: function [attrs] [
        if key? attrs "style" [
            s: to :string attrs\style
            if [notEqual? (find s "width:") null [
                return true
            ]
            if [notEqual? (find s "height:") null [
                return true
            ]
        ]
        false
]

maybe_autosize_text_attrs: function [attrs] [
        if key? attrs "data-auto-size" [
            return attrs
        ]
        if has_style_dim attrs [
            return attrs
        ]
        attrs\["data-auto-size"]: "text"
        attrs
]

style_value: function [val] [
        t: type val
        switch equal? t :integer [
            valStr: to :string val
            valStr ++ "px"
        ][
            switch equal? t :floating [
                valStr: to :string val
                valStr ++ "px"
            ][
                to :string val
            ]
        ]
]

merge_pending_attrs: function [attrs pending] [
        res: attrs
        keysList: keys pending
        klen: size keysList
        i: 0
        while [less? i klen][
            k: get keysList i
            switch key? res k [
                if equal? k "class" [
                    res\class: to :string res\class ++ " " ++ to :string pending\class
                ]
                if equal? k "style" [
                    res\style: append_style (to :string res\style) (to :string pending\style)
                ]
            ][
                res\[k]: pending\[k]
            ]
            i: i + 1
        ]
        res
]

merge_layout_scopes: function [attrs] [
        res: attrs
        stackLen: size vista_state\layout_scope_stack
        i: 0
        while [less? i stackLen][
            res: merge_pending_attrs res (get vista_state\layout_scope_stack i)
            i: i + 1
        ]
        res
]

apply_font_attrs: function [style fontVal] [
        t: type fontVal
        switch equal? t :dictionary [
            if key? fontVal "family" [
                style: append_style style ("font-family: " ++ to :string fontVal\family ++ ";")
            ]
            if key? fontVal "size" [
                fontSize: style_value fontVal\size
                style: append_style style ("font-size: " ++ fontSize ++ ";")
            ]
            if key? fontVal "color" [
                style: append_style style ("color: " ++ to :string fontVal\color ++ ";")
            ]
            if key? fontVal "weight" [
                style: append_style style ("font-weight: " ++ to :string fontVal\weight ++ ";")
            ]
            if key? fontVal "style" [
                style: append_style style ("font-style: " ++ to :string fontVal\style ++ ";")
            ]
            if key? fontVal "bold" [
                if fontVal\bold [
                    style: append_style style "font-weight: 700;"
                ]
            ]
            if key? fontVal "italic" [
                if fontVal\italic [
                    style: append_style style "font-style: italic;"
                ]
            ]
            style
        ][
            style: append_style style ("font-family: " ++ to :string fontVal ++ ";")
        ]
]

apply_para_attrs: function [style paraVal] [
        t: type paraVal
        switch equal? t :dictionary [
            if key? paraVal "align" [
                style: append_style style ("text-align: " ++ to :string paraVal\align ++ ";")
            ]
            if key? paraVal "wrap" [
                if not? paraVal\wrap [
                    style: append_style style "white-space: nowrap;"
                ]
            ]
            if key? paraVal "spacing" [
                spacingVal: style_value paraVal\spacing
                style: append_style style ("letter-spacing: " ++ spacingVal ++ ";")
            ]
            if key? paraVal "leading" [
                leadingVal: style_value paraVal\leading
                style: append_style style ("line-height: " ++ leadingVal ++ ";")
            ]
            style
        ][
            style: append_style style ("text-align: " ++ to :string paraVal ++ ";")
        ]
]

apply_edge_attrs: function [baseStyle edgeVal] [
        out: ""
        if notEqual? baseStyle null [
            out: to :string baseStyle
        ]
        t: type edgeVal
        switch equal? t :dictionary [
            sizeVal: 1
            colorVal: "#888"
            styleVal: "solid"
            if key? edgeVal "size" [ sizeVal: edgeVal\size ]
            if key? edgeVal "color" [ colorVal: edgeVal\color ]
            if key? edgeVal "style" [ styleVal: edgeVal\style ]
            sizeStr: style_value sizeVal
            switch any? @[equal? styleVal "bevel" equal? styleVal "raised" equal? styleVal "inset"] [
                out: append_style out ("border: " ++ sizeStr ++ " solid " ++ to :string colorVal ++ ";")
                if equal? styleVal "bevel" [
                    out: append_style out "box-shadow: inset 1px 1px 0 rgba(255,255,255,0.7), inset -1px -1px 0 rgba(0,0,0,0.3);"
                ]
                if equal? styleVal "raised" [
                    out: append_style out "box-shadow: inset 0 1px 0 rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.25);"
                ]
                if equal? styleVal "inset" [
                    out: append_style out "box-shadow: inset 0 1px 3px rgba(0,0,0,0.35);"
                ]
            ][
                out: append_style out ("border: " ++ sizeStr ++ " " ++ to :string styleVal ++ " " ++ to :string colorVal ++ ";")
            ]
            if key? edgeVal "radius" [
                radiusStr: style_value edgeVal\radius
                out: append_style out ("border-radius: " ++ radiusStr ++ ";")
            ]
        ][
            out: append_style out ("border: 1px solid " ++ to :string edgeVal ++ ";")
        ]
        out
]

apply_effect_attrs: function [style effectVal] [
        t: type effectVal
        switch equal? t :dictionary [
            if key? effectVal "shadow" [
                return append_style style ("box-shadow: " ++ to :string effectVal\shadow ++ ";")
            ]
            if key? effectVal "filter" [
                return append_style style ("filter: " ++ to :string effectVal\filter ++ ";")
            ]
            if key? effectVal "type" [
                effectVal: effectVal\type
            ]
        ][
            effectVal: effectVal
        ]
        valStr: to :string effectVal
        switch equal? valStr "shadow" [
            append_style style "box-shadow: 0 2px 8px rgba(0,0,0,0.18);"
        ][
            switch equal? valStr "inset" [
                append_style style "box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);"
            ][
                switch equal? valStr "raised" [
                    append_style style "box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 2px 4px rgba(0,0,0,0.25);"
                ][
                    switch equal? valStr "emboss" [
                        append_style style "box-shadow: inset 0 1px 0 rgba(255,255,255,0.7), inset 0 -1px 0 rgba(0,0,0,0.3);"
                    ][
                        switch equal? valStr "bevel" [
                            append_style style "box-shadow: inset 1px 1px 0 rgba(255,255,255,0.7), inset -1px -1px 0 rgba(0,0,0,0.3);"
                        ][
                            append_style style ("filter: " ++ valStr ++ ";")
                        ]
                    ]
                ]
            ]
        ]
]

apply_facet_attrs: function [attrs] [
        style: ""
        if key? attrs "style" [
            style: to :string attrs\style
            attrs: attrs_without attrs "style"
        ]
        if key? attrs "color" [
            style: append_style style ("background-color: " ++ to :string attrs\color ++ ";")
            attrs: attrs_without attrs "color"
        ]
        if key? attrs "font" [
            style: apply_font_attrs style attrs\font
            attrs: attrs_without attrs "font"
        ]
        if key? attrs "para" [
            style: apply_para_attrs style attrs\para
            attrs: attrs_without attrs "para"
        ]
        if key? attrs "valign" [
            style: append_style style ("justify-content: " ++ to :string attrs\valign ++ ";")
            style: append_style style ("vertical-align: " ++ to :string attrs\valign ++ ";")
            attrs: attrs_without attrs "valign"
        ]
        if key? attrs "edge" [
            style: apply_edge_attrs style attrs\edge
            attrs: attrs_without attrs "edge"
        ]
        if key? attrs "effect" [
            style: apply_effect_attrs style attrs\effect
            attrs: attrs_without attrs "effect"
        ]
        if notEqual? style "" [
            attrs\style: style
        ]
        attrs
]

header_value: function [hdr key] [
        keyStr: to :string key
        if key? hdr keyStr [
            return hdr\[keyStr]
        ]
        lowerKey: lower keyStr
        if key? hdr lowerKey [
            return hdr\[lowerKey]
        ]
        null
]

header_from_block: function [blk] [
        hdr: #[]
        if [notEqual? (type blk) :block [
            return hdr
        ]
        blen: size blk
        i: 0
        while [less? i blen][
            k: get blk i
            ktype: type k
            handled: false
            if equal? ktype :label [
                keyStr: to :string k
                if less? (i + 1) blen [
                    hdr\[keyStr]: get blk (i + 1)
                    i: i + 2
                    handled: true
                ]
            ]
            if not? handled [
                i: i + 1
            ]
        ]
        hdr
]

apply_header_values: function [hdr] [
        titleVal: header_value hdr "Title"
        if notEqual? titleVal null [
            webview_title: to :string titleVal
        ]
        widthVal: header_value hdr "Width"
        if notEqual? widthVal null [
            webview_width: widthVal
        ]
        heightVal: header_value hdr "Height"
        if notEqual? heightVal null [
            webview_height: heightVal
        ]
        logoVal: header_value hdr "Logo"
        if notEqual? logoVal null [
            vista_app_logo_path: to :string logoVal
        ]
        hdr
]

ARTURO: function [hdrBlock] [
        hdr: header_from_block hdrBlock
        if greater? (size keys hdr) 0 [
            vista_app_header: hdr
            apply_header_values hdr
        ]
        hdr
]

apply_arturo_header: function [] [
        if greater? (size keys vista_app_header) 0 [
            return apply_header_values vista_app_header
        ]
        null
]

run_app: function [layoutBlock] [
    apply_arturo_header
    view layoutBlock
]

apply_layout_attrs: function [attrs] [
        style: ""
        if key? attrs "style" [
            style: to :string attrs\style
            attrs: attrs_without attrs "style"
        ]
        if key? attrs "pad" [
            padVal: style_value attrs\pad
            style: append_style style ("padding: " ++ padVal ++ ";")
            attrs: attrs_without attrs "pad"
        ]
        if key? attrs "space" [
            spaceVal: style_value attrs\space
            style: append_style style ("gap: " ++ spaceVal ++ ";")
            attrs: attrs_without attrs "space"
        ]
        if key? attrs "align" [
            style: append_style style ("align-items: " ++ to :string attrs\align ++ ";")
            attrs: attrs_without attrs "align"
        ]
        if key? attrs "indent" [
            indentVal: style_value attrs\indent
            style: append_style style ("margin-left: " ++ indentVal ++ ";")
            attrs: attrs_without attrs "indent"
        ]
        if key? attrs "size" [
            sizeVal: attrs\size
            sizeType: type sizeVal
            switch equal? sizeType :block [
                if [equal? (size sizeVal) 2 [
                    w: get sizeVal 0
                    h: get sizeVal 1
                    widthVal: style_value w
                    heightVal: style_value h
                    style: append_style style ("width: " ++ widthVal ++ ";")
                    style: append_style style ("height: " ++ heightVal ++ ";")
                ]
            ][
                sizeStr: to :string sizeVal
                parts: split sizeStr "x"
                switch equal? (size parts) 2 [
                    widthVal: style_value (get parts 0)
                    heightVal: style_value (get parts 1)
                    style: append_style style ("width: " ++ widthVal ++ ";")
                    style: append_style style ("height: " ++ heightVal ++ ";")
                ][
                    widthVal: style_value sizeStr
                    style: append_style style ("width: " ++ widthVal ++ ";")
                ]
            ]
            attrs: attrs_without attrs "size"
        ]
        if key? attrs "origin" [
            pos: attrs\origin
            if [equal? (type pos) :block [
                if [equal? (size pos) 2 [
                    leftVal: style_value (get pos 0)
                    topVal: style_value (get pos 1)
                    style: append_style style ("padding-left: " ++ leftVal ++ ";")
                    style: append_style style ("padding-top: " ++ topVal ++ ";")
                ]
            ]
            attrs: attrs_without attrs "origin"
        ]
        if key? attrs "offset" [
            pos: attrs\offset
            if [equal? (type pos) :block [
                if [equal? (size pos) 2 [
                    style: append_style style "position: relative;"
                    leftVal: style_value (get pos 0)
                    topVal: style_value (get pos 1)
                    style: append_style style ("left: " ++ leftVal ++ ";")
                    style: append_style style ("top: " ++ topVal ++ ";")
                ]
            ]
            attrs: attrs_without attrs "offset"
        ]
        if key? attrs "at" [
            pos: attrs\at
            if [equal? (type pos) :block [
                if [equal? (size pos) 2 [
                    style: append_style style "position: absolute;"
                    leftVal: style_value (get pos 0)
                    topVal: style_value (get pos 1)
                    style: append_style style ("left: " ++ leftVal ++ ";")
                    style: append_style style ("top: " ++ topVal ++ ";")
                ]
            ]
            attrs: attrs_without attrs "at"
        ]
        if notEqual? style "" [
            attrs\style: style
        ]
        attrs
]

apply_event_attrs: function [attrs bindings] [
        res: attrs
        if key? res "on-click" [
            val: res\["on-click"]
            res: attrs_without res "on-click"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onclick: compile_action val bindings
            ][
                res\onclick: to :string val
            ]
        ]
        if key? res "on-over" [
            val: res\["on-over"]
            res: attrs_without res "on-over"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onmouseover: compile_action val bindings
            ][
                res\onmouseover: to :string val
            ]
        ]
        if key? res "on-out" [
            val: res\["on-out"]
            res: attrs_without res "on-out"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onmouseout: compile_action val bindings
            ][
                res\onmouseout: to :string val
            ]
        ]
        if key? res "on-down" [
            val: res\["on-down"]
            res: attrs_without res "on-down"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onmousedown: compile_action val bindings
            ][
                res\onmousedown: to :string val
            ]
        ]
        if key? res "on-up" [
            val: res\["on-up"]
            res: attrs_without res "on-up"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onmouseup: compile_action val bindings
            ][
                res\onmouseup: to :string val
            ]
        ]
        if key? res "on-change" [
            val: res\["on-change"]
            res: attrs_without res "on-change"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onchange: compile_action val bindings
            ][
                res\onchange: to :string val
            ]
        ]
        if key? res "on-key" [
            val: res\["on-key"]
            res: attrs_without res "on-key"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onkeydown: compile_action val bindings
            ][
                res\onkeydown: to :string val
            ]
        ]
        if key? res "on-focus" [
            val: res\["on-focus"]
            res: attrs_without res "on-focus"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onfocus: compile_action val bindings
            ][
                res\onfocus: to :string val
            ]
        ]
        if key? res "on-blur" [
            val: res\["on-blur"]
            res: attrs_without res "on-blur"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\onblur: compile_action val bindings
            ][
                res\onblur: to :string val
            ]
        ]
        if key? res "on-input" [
            val: res\["on-input"]
            res: attrs_without res "on-input"
            vType: type val
            switch any? @[equal? vType :block equal? vType :dictionary] [
                if equal? vType :dictionary [
                    val: dict_to_block val
                ]
                res\oninput: compile_action val bindings
            ][
                res\oninput: to :string val
            ]
        ]
        res
]

prepare_attrs: function [attrs bindings] [
        attrs: merge_layout_scopes attrs
        attrs: apply_layout_attrs attrs
        attrs: apply_facet_attrs attrs
        attrs: apply_event_attrs attrs bindings
        if greater? (size keys vista_state\layout_pending_attrs) 0 [
            attrs: merge_pending_attrs attrs vista_state\layout_pending_attrs
            vista_state\layout_pending_attrs: #[]
        ]
        attrs
]

merge_class_attr: function [attrs baseClass] [
        if [notEqual? (type attrs) :dictionary [
            attrs: #[]
        ]
        classVal: baseClass
        if key? attrs "class" [
            classVal: baseClass ++ " " ++ to :string attrs\class
        ]
        rest: attrs_without attrs "class"
        #[
            class: classVal
            attrs: rest
        ]
]

js_literal: function [value] [
        t: type value
        switch equal? t :string [
            escaped: js_escape_single value
            out: "'"
            out: out ++ escaped
            out: out ++ "'"
            out
        ][
            switch equal? t :integer [
                to :string value
            ][
                switch equal? t :floating [
                    to :string value
                ][
                    switch equal? t :logical [
                        to :string value
                    ][
                        switch equal? t :null [
                            "null"
                        ][
                            escaped: js_escape_single (to :string value)
                            out: "'"
                            out: out ++ escaped
                            out: out ++ "'"
                            out
                        ]
                    ]
                ]
            ]
        ]
]

add_binding: function [bindings word] [
        unless key? bindings word [
            keyName: to :string word
            val: ""
            sym: symbols
            has_value: key? sym keyName
            switch has_value [
                valCandidate: sym\[keyName]
                switch equal? (type valCandidate) :function [
                    val: ""
                ][
                    val: valCandidate
                ]
            ][
                val: ""
            ]
            bindings\[word]: val
        ]
]

js_token: function [token bindings] [
        t: type token
        switch equal? t :word [
            add_binding bindings token
            "state." ++ to :string token
        ][
            switch equal? t :symbol [
                to :string token
            ][
                switch equal? t :string [
                    escaped: js_escape_single token
                    out: "'"
                    out: out ++ escaped
                    out: out ++ "'"
                    out
                ][
                    switch equal? t :integer [
                        to :string token
                    ][
                        switch equal? t :floating [
                            to :string token
                        ][
                            switch equal? t :logical [
                                to :string token
                            ][
                                switch equal? t :null [
                                    "null"
                                ][
                                    escaped: js_escape_single (to :string token)
                                    out: "'"
                                    out: out ++ escaped
                                    out: out ++ "'"
                                    out
                                ]
                            ]
                        ]
                    ]
                ]
            ]
        ]
]

compile_expr: function [tokens bindings] [
        expr: ""
        tokens_len: size tokens
        if equal? tokens_len 0 [
            return "null"
        ]
        i: 0
        while [less? i tokens_len][
            part: js_token (get tokens i) bindings
            switch equal? expr "" [
                expr: part
            ][
                expr: expr ++ " " ++ part
            ]
            i: i + 1
        ]
        expr
]

dict_to_block: function [d] [
        out: []
        if [notEqual? (type d) :dictionary [
                return out
        ]
        keysList: keys d
        i: 0
        klen: size keysList
        while [less? i klen][
                k: get keysList i
                out: out ++ @[to :label (to :string k)]
                out: out ++ @[d\[k]]
                i: i + 1
        ]
        out
]

compile_action: function [blk bindings] [
        if [equal? (type blk) :dictionary [
                blk: dict_to_block blk
        ]
        js: ""
        blk_len: size blk
        i: 0
        while [less? i blk_len][
            tok: get blk i
            tok_type: type tok
            switch equal? tok_type :label [
                nameStr: to :string tok
                nameWord: to :word nameStr
                add_binding bindings nameWord
                i: i + 1
                exprTokens: []
                while [less? i blk_len][
                    next_type: type (get blk i)
                    if equal? next_type :label [
                        break
                    ]
                    exprTokens: append_value exprTokens (get blk i)
                    i: i + 1
                ]
                expr: compile_expr exprTokens bindings
                js: js ++ "state." ++ nameStr ++ " = " ++ expr ++ "; render();"
            ][
                i: i + 1
            ]
        ]
        js
]

render_script: function [bindings] [
        keysList: keys bindings
        keys_len: size keysList
        if equal? keys_len 0 [
            return ""
        ]
        statePairs: ""
        i: 0
        while [less? i keys_len][
            k: get keysList i
            v: bindings\[k]
            vStr: js_literal v
            pair: to :string k ++ ": " ++ vStr
            switch equal? statePairs "" [
                statePairs: pair
            ][
                statePairs: statePairs ++ ", " ++ pair
            ]
            i: i + 1
        ]
        script: "<script>"
        script: script ++ "const state = {" ++ statePairs ++ "};"
        script: script ++ "function _vistaParsePx(v){const n=parseFloat(v);return isNaN(n)?0:n;}"
        script: script ++ "function _vistaMeasureText(text,font){const c=_vistaMeasureText._c||(_vistaMeasureText._c=document.createElement('canvas'));const ctx=c.getContext('2d');ctx.font=font||'16px sans-serif';const lines=String(text||'').split('\\n');let maxW=0;lines.forEach(line=>{const w=ctx.measureText(line).width;if(w>maxW){maxW=w;}});let lineHeight=0;const m=ctx.measureText('M');if((m.actualBoundingBoxAscent||0)+(m.actualBoundingBoxDescent||0)>0){lineHeight=m.actualBoundingBoxAscent+m.actualBoundingBoxDescent;}if(!lineHeight){const fontSize=_vistaParsePx((font||'').match(/\\d+px/)?(font.match(/\\d+px/)[0]):'16px');lineHeight=fontSize*1.2;}let height=lineHeight*lines.length;return {width:maxW,height:height};}"
        script: script ++ "function autoSize(){document.querySelectorAll('[data-auto-size]').forEach(el=>{const hasInlineWidth=!!el.style.width;const hasInlineHeight=!!el.style.height;const managed=el.dataset.autoSizeManaged==='1';if((hasInlineWidth||hasInlineHeight) && !managed){return;}const style=getComputedStyle(el);const text=el.textContent||'';const m=_vistaMeasureText(text,style.font);const padX=_vistaParsePx(style.paddingLeft)+_vistaParsePx(style.paddingRight);const padY=_vistaParsePx(style.paddingTop)+_vistaParsePx(style.paddingBottom);const borderX=_vistaParsePx(style.borderLeftWidth)+_vistaParsePx(style.borderRightWidth);const borderY=_vistaParsePx(style.borderTopWidth)+_vistaParsePx(style.borderBottomWidth);const lineHeight=(style.lineHeight&&style.lineHeight!=='normal')?_vistaParsePx(style.lineHeight):0;const lines=Math.max(1,String(text||'').split('\\n').length);if(lineHeight>0){m.height=Math.max(m.height,lineHeight*lines);}const w=Math.ceil(m.width+padX+borderX);const h=Math.ceil(m.height+padY+borderY);if(w>0){el.style.width=w+'px';}if(h>0){el.style.height=h+'px';}el.dataset.autoSizeManaged='1';});}"
        script: script ++ "function bindInputs(){document.querySelectorAll('[data-bind]').forEach(el=>{if(el.dataset.vistaBound==='1'){return;}el.dataset.vistaBound='1';const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.addEventListener('change',()=>{state[key]=el.checked;render();if(window.vistaPushState){vistaPushState();}});}else if(el.type==='radio'){el.addEventListener('change',()=>{if(el.checked){state[key]=el.value;}render();if(window.vistaPushState){vistaPushState();}});}else{el.addEventListener('input',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}}else if(el.tagName==='TEXTAREA'){el.addEventListener('input',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}else if(el.tagName==='SELECT'){el.addEventListener('change',()=>{state[key]=el.value;render();if(window.vistaPushState){vistaPushState();}});}});}"
        script: script ++ "function render(){document.querySelectorAll('[data-bind]').forEach(el=>{const key=el.getAttribute('data-bind');if(el.tagName==='INPUT'){if(el.type==='checkbox'){el.checked=!!state[key];}else if(el.type==='radio'){el.checked=(state[key]==null?'':state[key])==el.value;}else{el.value=(state[key]==null?'':state[key]);}}else if(el.tagName==='TEXTAREA'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='SELECT'){el.value=(state[key]==null?'':state[key]);}else if(el.tagName==='PROGRESS'){el.value=(state[key]==null?0:state[key]);}else if(el.tagName==='IMG'){if(state[key]!=null){el.src=state[key];}}else{el.textContent=(state[key]==null?'':state[key]);}});document.querySelectorAll('[data-show-bind]').forEach(el=>{const key=el.dataset.showBind;const expected=el.dataset.showValue;const cur=state[key];let show=false;if(expected==null||expected===''){show=!!cur;}else{show=String(cur)===expected;}el.style.display=show?'':'none';});document.querySelectorAll('ul[data-list-bind]').forEach(ul=>{const key=ul.dataset.listBind;const multi=ul.dataset.multi==='true';const items=[...ul.querySelectorAll('li[data-value]')];const setActive=(idx)=>{if(idx<0||idx>=items.length){return;}ul.dataset.activeIndex=String(idx);items.forEach((li,i)=>{li.classList.toggle('is-active',i===idx);});};const applyRange=(a,b,additive)=>{let start=Math.min(a,b);let end=Math.max(a,b);let values=items.slice(start,end+1).map(li=>li.dataset.value);let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(!additive){cur=[];}values.forEach(v=>{if(!cur.includes(v)){cur.push(v);}});state[key]=cur;};const toggleValue=(v)=>{let cur=state[key];if(!Array.isArray(cur)){cur=[];}if(cur.includes(v)){cur=cur.filter(x=>x!==v);}else{cur=[...cur,v];}state[key]=cur;};const selectIndex=(idx,evt)=>{if(idx<0||idx>=items.length){return;}setActive(idx);const v=items[idx].dataset.value;if(!multi){state[key]=v;render();if(window.vistaPushState){vistaPushState();}return;}const shift=evt&&evt.shiftKey;const additive=evt&&(evt.ctrlKey||evt.metaKey);if(shift){const anchor=parseInt(ul.dataset.anchorIndex||String(idx),10);applyRange(anchor,idx,additive);}else if(additive){toggleValue(v);}else{state[key]=[v];}if(!shift){ul.dataset.anchorIndex=String(idx);}render();if(window.vistaPushState){vistaPushState();}};items.forEach((li,idx)=>{li.addEventListener('click',e=>{selectIndex(idx,e);});});ul.addEventListener('keydown',e=>{if(!items.length){return;}const selectedIndex=items.findIndex(li=>li.classList.contains('is-selected'));let idx=selectedIndex>=0?selectedIndex:0;if(e.key==='ArrowDown'){e.preventDefault();idx=Math.min(items.length-1,idx+1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='ArrowUp'){e.preventDefault();idx=Math.max(0,idx-1);if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(idx);return;}selectIndex(idx,e);}else if(e.key==='Home'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(0);return;}selectIndex(0,e);}else if(e.key==='End'){e.preventDefault();if(multi&&(e.ctrlKey||e.metaKey)&&!e.shiftKey){setActive(items.length-1);return;}selectIndex(items.length-1,e);}else if(e.key===' '||e.key==='Enter'){e.preventDefault();selectIndex(idx,e);}else if(e.key.length===1 && !e.ctrlKey && !e.metaKey){const ch=e.key.toLowerCase();const buf=(ul._vistaTypeBuf||'')+ch;ul._vistaTypeBuf=buf;clearTimeout(ul._vistaTypeTimer);ul._vistaTypeTimer=setTimeout(()=>{ul._vistaTypeBuf='';},500);const found=items.findIndex(li=>li.textContent.trim().toLowerCase().startsWith(buf));if(found>=0){selectIndex(found,e);}} });});const handleKey=(el,e)=>{const bind=el.dataset.keyBind;const mode=el.dataset.keyMode||'keydown';if((mode==='keyup'&&e.type!=='keyup')||(mode!=='keyup'&&e.type!=='keydown')){return;}let value='';const modifiersOnly=el.dataset.keyModifiers==='true';if(modifiersOnly){const mods=[];if(e.shiftKey){mods.push('Shift');}if(e.ctrlKey){mods.push('Ctrl');}if(e.altKey){mods.push('Alt');}if(e.metaKey){mods.push('Meta');}value=mods.join('+');}else{value=e.key;}const filter=(el.dataset.keyFilter||'').split(',').map(s=>s.trim()).filter(Boolean);if(filter.length>0 && value!=='' && !filter.includes(value)){return;}state[bind]=value;render();if(el.dataset.keyAction){try{eval(el.dataset.keyAction);}catch(e){}}if(window.vistaPushState){vistaPushState();}};document.querySelectorAll('[data-key-bind]').forEach(el=>{el.addEventListener('keydown',e=>handleKey(el,e));el.addEventListener('keyup',e=>handleKey(el,e));});autoSize();}"
        script: script ++ "setTimeout(()=>{render();bindInputs();},0);"
        script: script ++ "window.vistaShow=function(id,html){const el=document.querySelector('[data-face-id=\"'+id+'\"]');if(!el){return false;}el.outerHTML=html;render();bindInputs();return true;};"
        switch webview_state_sync_from_ui [
            script: script ++ "window.vistaPushState=function(){if(window.__vistaPushTimer){clearTimeout(window.__vistaPushTimer);}window.__vistaPushTimer=setTimeout(()=>{fetch('/vista-state',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(state)}).catch(()=>{});},"
            script: script ++ to :string webview_state_push_ms
            script: script ++ ");};"
        ][
            ""
        ]
        switch greater? webview_state_sync_ms 0 [
            script: script ++ "document.addEventListener('DOMContentLoaded', ()=>{render();bindInputs();setInterval(()=>{fetch('/vista-sync').then(r=>r.json()).then(data=>{Object.keys(data||{}).forEach(k=>{state[k]=data[k];});render();});},"
            script: script ++ to :string webview_state_sync_ms
            script: script ++ ");});"
        ][
            script: script ++ "document.addEventListener('DOMContentLoaded', ()=>{render();bindInputs();});"
        ]
        script: script ++ "</script>"
        script
]

tabs_script: function [] [
        "<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('[data-tabs]').forEach(container=>{const buttons=[...container.querySelectorAll('.vista-tab-btn')];const panels=[...container.querySelectorAll('.vista-tab-panel')];const activate=id=>{buttons.forEach(btn=>{btn.classList.toggle('is-active',btn.dataset.tab===id);});panels.forEach(panel=>{panel.classList.toggle('is-active',panel.dataset.tab===id);});};let selectedIndex=parseInt(container.dataset.tabsSelected||'0',10);if(isNaN(selectedIndex)){selectedIndex=0;}if(buttons.length>0){const idx=Math.max(0,Math.min(selectedIndex,buttons.length-1));activate(buttons[idx].dataset.tab);}buttons.forEach((btn,idx)=>{btn.addEventListener('click',()=>activate(btn.dataset.tab));btn.addEventListener('keydown',e=>{if(e.key==='ArrowRight'){e.preventDefault();const next=(idx+1)%buttons.length;buttons[next].click();buttons[next].focus();}else if(e.key==='ArrowLeft'){e.preventDefault();const prev=(idx-1+buttons.length)%buttons.length;buttons[prev].click();buttons[prev].focus();}else if(e.key==='Home'){e.preventDefault();buttons[0].click();buttons[0].focus();}else if(e.key==='End'){e.preventDefault();buttons[buttons.length-1].click();buttons[buttons.length-1].focus();}});});});});</script>"
]

menubar_script: function [] [
        "<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.vista-menubar').forEach(bar=>{const buttons=[...bar.querySelectorAll('[data-menu]')];const panels=[...bar.querySelectorAll('[data-menu-panel]')];let openKey=null;const closeAll=()=>{panels.forEach(p=>p.classList.remove('is-open'));buttons.forEach(b=>b.classList.remove('is-active'));openKey=null;};const openMenu=(key,btn)=>{const panel=panels.find(p=>p.dataset.menuPanel===key);if(!panel){return;}panels.forEach(p=>p.classList.toggle('is-open',p===panel));buttons.forEach(b=>b.classList.toggle('is-active',b===btn));const barRect=bar.getBoundingClientRect();const btnRect=btn.getBoundingClientRect();panel.style.left=(btnRect.left-barRect.left)+'px';panel.style.top=(barRect.height+4)+'px';openKey=key;};buttons.forEach(btn=>{btn.addEventListener('click',e=>{e.stopPropagation();const key=btn.dataset.menu;if(openKey===key){closeAll();}else{openMenu(key,btn);}});btn.addEventListener('mouseenter',()=>{if(openKey){openMenu(btn.dataset.menu,btn);}});});document.addEventListener('click',()=>{if(openKey){closeAll();}});document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeAll();}});panels.forEach(panel=>{panel.addEventListener('click',e=>e.stopPropagation());});});});</script>"
]

table_script: function [] [
        "<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('table[data-row-select]').forEach(table=>{table.querySelectorAll('tbody tr').forEach(row=>{row.addEventListener('click',()=>{table.querySelectorAll('tbody tr').forEach(r=>r.classList.remove('is-selected'));row.classList.add('is-selected');table.dataset.selectedText=row.textContent.trim();});});});});</script>"
]

auto_reload_script: function [] [
        if webview_auto_reload [
            return "<script>setInterval(()=>{location.reload();}," ++ to :string webview_reload_ms ++ ");</script>"
        ]
        ""
]

merge_bindings: function [dest src] [
        keysList: keys src
        i: 0
        keys_len: size keysList
        while [less? i keys_len][
            k: get keysList i
            dest\[k]: src\[k]
            i: i + 1
        ]
]

; Helpers for layout parsing
collect_args: function [block start] [
        args: []
        block_len: size block
        i: start
        while [less? i block_len][
                tok: get block i
                tok_type: type tok
                if equal? tok_type :word [
                        if less? (i + 2) block_len [
                                mid: get block (i + 1)
                                tail: get block (i + 2)
                                if all? @[equal? (type mid) :symbol equal? (to :string mid) "-" equal? (type tail) :word] [
                                        compound: to :string tok ++ "-" ++ to :string tail
                                        if is_keyword compound block [
                                                break
                                        ]
                                ]
                        ]
                ]
                if is_keyword tok block [
                        break
                ]
                args: append_value args tok
                i: i + 1
        ]
        #[
                args: args
                next: i
        ]
]

parse_args_from: function [block start] [
        info: collect_args block start
        parsed: parse_attrs info\args
        #[
                args: parsed\args
                attrs: parsed\attrs
                next: info\next
        ]
]

render_block_or_string: function [value bindings faces parentId] [
        switch equal? (type value) :block [
                inner: layout_state value
                merge_bindings bindings inner\bindings
                merge_faces faces inner\faces
                append_children_from_root faces parentId inner\root
                inner\html
        ][
                html_text value
        ]
]

render_block_inner: function [value bindings faces parentId] [
        switch equal? (type value) :block [
                inner: layout_state value
                merge_bindings bindings inner\bindings
                merge_faces faces inner\faces
                append_children_from_root faces parentId inner\root
                strip_root_div inner\html
        ][
                html_text value
        ]
]

; Layout function: parse block into HTML + bindings
layout_state: function [block] [
        block: normalize_block block
        prev_pending: vista_state\layout_pending_attrs
        vista_state\layout_pending_attrs: #[]
        prev_scope_stack: vista_state\layout_scope_stack
        vista_state\layout_scope_stack: prev_scope_stack
        bindings: #[]
        faces: #[]
        root_id: next_face_id
        faces\[root_id]: #[
                id: root_id
                type: "root"
                attrs: #[]
                html: ""
                children: []
        ]
        html: "<div>" ; root container
        open_divs: 0
        face_stack: @[root_id]
        block_len: size block
        i: 0
        while [less? i block_len][
                item: get block i
                item_type: type item
                switch equal? item_type :word [
                        item_name: to :string item
                        isStyle: key? vista_styles item_name
                        if isStyle [
                                info: parse_args_from block (i + 1)
                                i: info\next
                                styleBlock: vista_styles\[item_name]
                                styledBlock: apply_style_args styleBlock info\args info\attrs
                                inner: layout_state styledBlock
                                merge_bindings bindings inner\bindings
                                merge_faces faces inner\faces
                                parentId: current_parent_id face_stack
                                append_children_from_root faces parentId inner\root
                                html: html ++ inner\html
                        ]
                        if not? isStyle [
                                do case item_name [
                                "pad" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\pad: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "space" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\space: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "align" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\align: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "valign" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\valign: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "size" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\size: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "origin" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\origin: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "offset" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\offset: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "indent" -> [
                                        switch less? (i + 1) block_len [
                                                v: get block (i + 1)
                                                vista_state\layout_pending_attrs\indent: v
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "guide" -> [
                                        switch key? vista_state\layout_pending_attrs "class" [
                                                vista_state\layout_pending_attrs\class: to :string vista_state\layout_pending_attrs\class ++ " vista-guide"
                                        ][
                                                vista_state\layout_pending_attrs\class: "vista-guide"
                                        ]
                                        i: i + 1
                                ]
                                "do" -> [
                                        switch less? (i + 1) block_len [
                                                val: get block (i + 1)
                                                do val
                                                i: i + 2
                                        ][
                                                i: i + 1
                                        ]
                                ]
                                "raw" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        if greater? (size info\args) 0 [
                                                rawVal: get info\args 0
                                                switch is_raw_html rawVal [
                                                        html: html ++ rawVal\value
                                                ][
                                                        html: html ++ to :string rawVal
                                                ]
                                        ]
                                ]
                                "scope" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        scopeAttrs: vista_state\layout_pending_attrs
                                        if greater? (size keys info\attrs) 0 [
                                                scopeAttrs: merge_pending_attrs info\attrs scopeAttrs
                                        ]
                                        vista_state\layout_pending_attrs: #[]
                                        bodyVal: null
                                        if greater? (size info\args) 0 [
                                                bodyVal: get info\args 0
                                        ]
                                        if [equal? (type bodyVal) :block [
                                                prevStack: vista_state\layout_scope_stack
                                                vista_state\layout_scope_stack: vista_state\layout_scope_stack ++ @[scopeAttrs]
                                                inner: layout_state bodyVal
                                                vista_state\layout_scope_stack: prevStack
                                                merge_bindings bindings inner\bindings
                                                merge_faces faces inner\faces
                                                parentId: current_parent_id face_stack
                                                append_children_from_root faces parentId inner\root
                                                html: html ++ inner\html
                                        ]
                                ]
                                "across" -> [
                                        attrs: #[]
                                        if greater? (size keys vista_state\layout_pending_attrs) 0 [
                                                attrs: prepare_attrs #[] bindings
                                        ]
                                        switch vista_layout_vid_mode [
                                                merged: merge_class_attr attrs "vista-layout-across"
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html merged\attrs
                                                openHtml: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
                                                html: htmlStr ++ openHtml
                                        ][
                                                baseStyle: "display: flex;"
                                                if key? attrs "style" [
                                                        baseStyle: append_style baseStyle (to :string attrs\style)
                                                        attrs: attrs_without attrs "style"
                                                ]
                                                attrs\style: baseStyle
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html attrs
                                                html: htmlStr ++ "<div" ++ attrStr ++ ">"
                                        ]
                                        open_divs: open_divs + 1
                                        i: i + 1
                                ]
                                "below" -> [
                                        attrs: #[]
                                        if greater? (size keys vista_state\layout_pending_attrs) 0 [
                                                attrs: prepare_attrs #[] bindings
                                        ]
                                        switch vista_layout_vid_mode [
                                                merged: merge_class_attr attrs "vista-layout-below"
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html merged\attrs
                                                openHtml: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
                                                html: htmlStr ++ openHtml
                                        ][
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html attrs
                                                html: htmlStr ++ "<div" ++ attrStr ++ ">"
                                        ]
                                        open_divs: open_divs + 1
                                        i: i + 1
                                ]
                                "return" -> [
                                        switch greater? open_divs 0 [
                                                htmlStr: to :string html
                                                html: htmlStr ++ "</div>"
                                        ][
                                                open_divs: open_divs + 1
                                        ]
                                        attrs: #[]
                                        if greater? (size keys vista_state\layout_pending_attrs) 0 [
                                                attrs: prepare_attrs #[] bindings
                                        ]
                                        switch vista_layout_vid_mode [
                                                merged: merge_class_attr attrs "vista-layout-row"
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html merged\attrs
                                                openHtml: "<div class='" ++ merged\class ++ "'" ++ attrStr ++ ">"
                                                html: htmlStr ++ openHtml
                                        ][
                                                htmlStr: to :string html
                                                attrStr: attrs_to_html attrs
                                                html: htmlStr ++ "<div" ++ attrStr ++ ">"
                                        ]
                                        i: i + 1
                                ]
                                "end" -> [
                                        if greater? open_divs 0 [
                                                html: html ++ "</div>"
                                                open_divs: open_divs - 1
                                        ]
                                        i: i + 1
                                ]
                                "text" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "text" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                attrStr: attrs_to_html attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        faceHtml: "<span data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ "></span>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        textVal: html_text arg0
                                                        faceHtml: "<span" ++ attrStr ++ ">" ++ textVal ++ "</span>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "title" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "title" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        merged: merge_class_attr attrs "vista-title"
                                                        attrStr: attrs_to_html merged\attrs
                                                        faceHtml: "<h1 class='" ++ merged\class ++ "' data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ "></h1>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: title arg0 attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "subtitle" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "subtitle" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        merged: merge_class_attr attrs "vista-subtitle"
                                                        attrStr: attrs_to_html merged\attrs
                                                        faceHtml: "<h2 class='" ++ merged\class ++ "' data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ "></h2>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: subtitle arg0 attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "field" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if equal? args_len 0 [
                                                args: args ++ [""]
                                        ]
                                        arg0: get args 0
                                        arg0_type: type arg0
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "field" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        switch equal? arg0_type :word [
                                                add_binding bindings arg0
                                                arg0_str: to :string arg0
                                                set_face_meta faces faceId #[bindName: arg0_str]
                                                faceHtml: input_field arg0_str attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ][
                                                inputType: "text"
                                                if key? attrs "type" [
                                                        inputType: to :string attrs\type
                                                ]
                                                set_face_meta faces faceId #[value: arg0]
                                                attrStr: attrs_to_html (attrs_without attrs "type")
                                                faceHtml: "<input type='" ++ inputType ++ "' value='" ++ html_escape_attr (to :string arg0) ++ "'" ++ attrStr ++ ">"
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "info" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        switch key? attrs "class" [
                                                attrs\class: "vista-info " ++ to :string attrs\class
                                        ][
                                                attrs\class: "vista-info"
                                        ]
                                        attrs\readonly: true
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "info" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[bindName: arg0_str]
                                                        faceHtml: input_field arg0_str attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        set_face_meta faces faceId #[value: arg0]
                                                        attrStr: attrs_to_html (attrs_without attrs "type")
                                                        faceHtml: "<input type='text' value='" ++ html_escape_attr (to :string arg0) ++ "'" ++ attrStr ++ ">"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "button" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if equal? args_len 1 [
                                                args: args ++ [""]
                                        ]
                                        labelHtml: ""
                                        labelClass: ""
                                        if key? attrs "label-class" [
                                                labelClass: to :string attrs["label-class"]
                                                attrs: attrs_without attrs "label-class"
                                        ]
                                        arg0: get args 0
                                        arg0_type: type arg0
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "button" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        switch equal? arg0_type :word [
                                                add_binding bindings arg0
                                                arg0_str: to :string arg0
                                                labelHtml: "<span data-bind='" ++ arg0_str
                                                switch notEqual? labelClass "" [
                                                        labelHtml: labelHtml ++ "' class='" ++ labelClass ++ "'></span>"
                                                ][
                                                        labelHtml: labelHtml ++ "'></span>"
                                                ]
                                        ][
                                                labelHtml: html_text arg0
                                        ]
                                        jsAction: ""
                                        arg1: get args 1
                                        arg1_type: type arg1
                                        switch equal? arg1_type :block [
                                                jsAction: compile_action arg1 bindings
                                        ][
                                                jsAction: to :string arg1
                                        ]
                                        set_face_meta faces faceId #[
                                                labelHtml: labelHtml
                                                action: jsAction
                                        ]
                                        faceHtml: button labelHtml jsAction attrs
                                        html: html ++ faceHtml
                                        set_face_html faces faceId faceHtml
                                ]
                                "key" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        jsAction: ""
                                        if key? attrs "onchange" [
                                                jsAction: attrs\onchange
                                                attrs: attrs_without attrs "onchange"
                                        ]
                                        modeVal: "keydown"
                                        if key? attrs "mode" [
                                                modeVal: to :string attrs\mode
                                                attrs: attrs_without attrs "mode"
                                        ]
                                        modifiersOnly: false
                                        if key? attrs "modifiers" [
                                                modifiersOnly: attrs\modifiers
                                                attrs: attrs_without attrs "modifiers"
                                        ]
                                        filterStr: ""
                                        if key? attrs "filter" [
                                                fval: attrs\filter
                                                ftype: type fval
                                                switch equal? ftype :block [
                                                        flen: size fval
                                                        fi: 0
                                                        while [less? fi flen][
                                                                frag: to :string (get fval fi)
                                                                switch equal? filterStr "" [
                                                                        filterStr: frag
                                                                ][
                                                                        filterStr: filterStr ++ "," ++ frag
                                                                ]
                                                                fi: fi + 1
                                                        ]
                                                ][
                                                        filterStr: to :string fval
                                                ]
                                                attrs: attrs_without attrs "filter"
                                        ]
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                bindName: ""
                                                labelVal: ""
                                                switch equal? (type (get args 0)) :word [
                                                        bindName: to :string (get args 0)
                                                        add_binding bindings (get args 0)
                                                        if greater? args_len 1 [
                                                                labelVal: get args 1
                                                        ]
                                                ][
                                                        labelVal: get args 0
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "key" attrs ""
                                                attrs: with_face_id attrs faceId
                                                attrs\["data-key-mode"]: modeVal
                                                attrs\["data-key-modifiers"]: to :string modifiersOnly
                                                if notEqual? filterStr "" [
                                                        attrs\["data-key-filter"]: filterStr
                                                ]
                                                if notEqual? jsAction "" [
                                                        attrs\["data-key-action"]: jsAction
                                                ]
                                                set_face_attrs_and_name faces faceId attrs
                                                labelHtml: html_text labelVal
                                                set_face_meta faces faceId #[
                                                        labelHtml: labelHtml
                                                        bindName: bindName
                                                ]
                                                faceHtml: key_button labelHtml bindName attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "label" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "label" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                attrStr: attrs_to_html attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        faceHtml: "<label data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ "></label>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        labelVal: html_text arg0
                                                        faceHtml: "<label" ++ attrStr ++ ">" ++ labelVal ++ "</label>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "box" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "box" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: box bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "panel" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                titleHtml: ""
                                                bodyVal: null
                                                if greater? args_len 1 [
                                                        bodyVal: get args 1
                                                ]
                                                switch equal? arg0_type :block [
                                                        bodyVal: arg0
                                                ][
                                                        switch equal? arg0_type :word [
                                                                add_binding bindings arg0
                                                                titleHtml: "<span data-bind='" ++ to :string arg0 ++ "'></span>"
                                                        ][
                                                                titleHtml: html_text arg0
                                                        ]
                                                ]
                                                bodyHtml: ""
                                                inner_root: null
                                                switch equal? (type bodyVal) :block [
                                                        inner: layout_state bodyVal
                                                        merge_bindings bindings inner\bindings
                                                        merge_faces faces inner\faces
                                                        bodyHtml: inner\html
                                                        inner_root: inner\root
                                                ][
                                                        bodyHtml: html_text bodyVal
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "panel" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                append_children_from_root faces faceId inner_root
                                                set_face_meta faces faceId #[titleHtml: titleHtml]
                                                faceHtml: panel_face titleHtml bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "grid" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        cols: 2
                                        bodyVal: null
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                switch equal? (type arg0) :integer [
                                                        cols: arg0
                                                        if greater? args_len 1 [
                                                                bodyVal: get args 1
                                                        ]
                                                ][
                                                        bodyVal: arg0
                                                ]
                                        ]
                                        if key? attrs "cols" [
                                                cols: attrs\cols
                                                attrs: attrs_without attrs "cols"
                                        ]
                                        if equal? bodyVal null [
                                                bodyVal: []
                                        ]
                                        bodyHtml: ""
                                        inner_root: null
                                        switch equal? (type bodyVal) :block [
                                                inner: layout_state bodyVal
                                                merge_bindings bindings inner\bindings
                                                merge_faces faces inner\faces
                                                bodyHtml: inner\html
                                                inner_root: inner\root
                                        ][
                                                bodyHtml: html_text bodyVal
                                        ]
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "grid" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        append_children_from_root faces faceId inner_root
                                        set_face_meta faces faceId #[cols: cols]
                                        faceHtml: grid_face bodyHtml attrs cols
                                        set_face_html faces faceId faceHtml
                                        html: html ++ faceHtml
                                ]
                                "spacer" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                sizeVal: get args 0
                                                sizeType: type sizeVal
                                                switch equal? sizeType :block [
                                                        if [equal? (size sizeVal) 2 [
                                                                widthVal: style_value (get sizeVal 0)
                                                                heightVal: style_value (get sizeVal 1)
                                                                attrs\style: "width: " ++ widthVal ++ "; height: " ++ heightVal ++ ";"
                                                        ]
                                                ][
                                                        heightVal: style_value sizeVal
                                                        attrs\style: "height: " ++ heightVal ++ ";"
                                                ]
                                        ]
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "spacer" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        faceHtml: spacer_face attrs
                                        html: html ++ faceHtml
                                        set_face_html faces faceId faceHtml
                                ]
                                "row" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "row" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: row bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "col" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "col" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: col bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "group" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "group" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: group bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "sensor" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "sensor" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        bodyHtml: ""
                                        if greater? (size args) 0 [
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                        ]
                                        faceHtml: sensor_face bodyHtml attrs
                                        set_face_html faces faceId faceHtml
                                        html: html ++ faceHtml
                                ]
                                "form" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: info\attrs
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                bodyBlock: get args 0
                                                bodyType: type bodyBlock
                                                action: ""
                                                if key? attrs "on-submit" [
                                                        onVal: attrs["on-submit"]
                                                        attrs: attrs_without attrs "on-submit"
                                                        onType: type onVal
                                                        switch equal? onType :block [
                                                                action: compile_action onVal bindings
                                                        ][
                                                                action: to :string onVal
                                                        ]
                                                ][
                                                        if greater? args_len 1 [
                                                                maybeAct: get args 1
                                                                maybeType: type maybeAct
                                                                if equal? maybeType :block [
                                                                        action: compile_action maybeAct bindings
                                                                ]
                                                        ]
                                                ]
                                                attrs: prepare_attrs attrs bindings
                                                parentId: current_parent_id face_stack
                                                switch equal? bodyType :block [
                                                        inner: layout_state bodyBlock
                                                        merge_bindings bindings inner\bindings
                                                        merge_faces faces inner\faces
                                                        faceId: register_face faces parentId "form" attrs ""
                                                        attrs: with_face_id attrs faceId
                                                        set_face_attrs_and_name faces faceId attrs
                                                        append_children_from_root faces faceId inner\root
                                                        faceHtml: form inner\html attrs action
                                                        set_face_html faces faceId faceHtml
                                                        html: html ++ faceHtml
                                                ][
                                                        faceId: register_face faces parentId "form" attrs ""
                                                        attrs: with_face_id attrs faceId
                                                        set_face_attrs_and_name faces faceId attrs
                                                        faceHtml: form (html_text bodyBlock) attrs action
                                                        set_face_html faces faceId faceHtml
                                                        html: html ++ faceHtml
                                                ]
                                        ]
                                ]
                                "checkbox" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        bindName: to :string arg0
                                                        labelHtml: ""
                                                        labelClass: ""
                                                        parentId: current_parent_id face_stack
                                                        faceId: register_face faces parentId "checkbox" attrs ""
                                                        attrs: with_face_id attrs faceId
                                                        set_face_attrs_and_name faces faceId attrs
                                                        if key? attrs "label-class" [
                                                                labelClass: to :string attrs["label-class"]
                                                                attrs: attrs_without attrs "label-class"
                                                        ]
                                                        if greater? args_len 1 [
                                                                arg1: get args 1
                                                                arg1_type: type arg1
                                                                switch equal? arg1_type :word [
                                                                        add_binding bindings arg1
                                                                        arg1_str: to :string arg1
                                                                        labelHtml: "<span data-bind='" ++ arg1_str
                                                                        switch notEqual? labelClass "" [
                                                                                labelHtml: labelHtml ++ "' class='" ++ labelClass ++ "'></span>"
                                                                        ][
                                                                                labelHtml: labelHtml ++ "'></span>"
                                                                        ]
                                                                ][
                                                                        switch equal? arg1_type :block [
                                                                                inner: layout_state arg1
                                                                                merge_bindings bindings inner\bindings
                                                                                merge_faces faces inner\faces
                                                                                append_children_from_root faces faceId inner\root
                                                                                labelHtml: inner\html
                                                                        ][
                                                                                labelHtml: html_text arg1
                                                                        ]
                                                                ]
                                                        ]
                                                        set_face_meta faces faceId #[
                                                                labelHtml: labelHtml
                                                                bindName: bindName
                                                        ]
                                                        faceHtml: checkbox labelHtml bindName attrs
                                                        set_face_html faces faceId faceHtml
                                                        html: html ++ faceHtml
                                                ][
                                                        i: i + 1
                                                ]
                                        ]
                                ]
                                "toggle" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        bindName: to :string arg0
                                                        labelHtml: ""
                                                        labelClass: ""
                                                        parentId: current_parent_id face_stack
                                                        faceId: register_face faces parentId "toggle" attrs ""
                                                        attrs: with_face_id attrs faceId
                                                        set_face_attrs_and_name faces faceId attrs
                                                        if key? attrs "label-class" [
                                                                labelClass: to :string attrs["label-class"]
                                                                attrs: attrs_without attrs "label-class"
                                                        ]
                                                        if greater? args_len 1 [
                                                                arg1: get args 1
                                                                arg1_type: type arg1
                                                                switch equal? arg1_type :word [
                                                                        add_binding bindings arg1
                                                                        arg1_str: to :string arg1
                                                                        labelHtml: "<span data-bind='" ++ arg1_str
                                                                        switch notEqual? labelClass "" [
                                                                                labelHtml: labelHtml ++ "' class='" ++ labelClass ++ "'></span>"
                                                                        ][
                                                                                labelHtml: labelHtml ++ "'></span>"
                                                                        ]
                                                                ][
                                                                        switch equal? arg1_type :block [
                                                                                inner: layout_state arg1
                                                                                merge_bindings bindings inner\bindings
                                                                                merge_faces faces inner\faces
                                                                                append_children_from_root faces faceId inner\root
                                                                                labelHtml: inner\html
                                                                        ][
                                                                                labelHtml: html_text arg1
                                                                        ]
                                                                ]
                                                        ]
                                                        set_face_meta faces faceId #[
                                                                labelHtml: labelHtml
                                                                bindName: bindName
                                                        ]
                                                        faceHtml: toggle labelHtml bindName attrs
                                                        set_face_html faces faceId faceHtml
                                                        html: html ++ faceHtml
                                                ][
                                                        i: i + 1
                                                ]
                                        ]
                                ]
                                "input" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if equal? args_len 0 [
                                                args: args ++ [""]
                                        ]
                                        arg0: get args 0
                                        arg0_type: type arg0
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "input" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        switch equal? arg0_type :word [
                                                add_binding bindings arg0
                                                arg0_str: to :string arg0
                                                set_face_meta faces faceId #[bindName: arg0_str]
                                                faceHtml: input_field arg0_str attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ][
                                                inputType: "text"
                                                if key? attrs "type" [
                                                        inputType: to :string attrs\type
                                                ]
                                                set_face_meta faces faceId #[value: arg0]
                                                attrStr: attrs_to_html (attrs_without attrs "type")
                                                faceHtml: "<input type='" ++ inputType ++ "' value='" ++ html_escape_attr (to :string arg0) ++ "'" ++ attrStr ++ ">"
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "slider" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if equal? args_len 0 [
                                                args: args ++ [0]
                                        ]
                                        arg0: get args 0
                                        arg0_type: type arg0
                                        labelMin: null
                                        labelMax: null
                                        if key? attrs "labels" [
                                                labelsVal: attrs\labels
                                                if [equal? (type labelsVal) :block [
                                                        if [equal? (size labelsVal) 2 [
                                                                labelMin: get labelsVal 0
                                                                labelMax: get labelsVal 1
                                                        ]
                                                ]
                                                attrs: attrs_without attrs "labels"
                                        ]
                                        if key? attrs "label-min" [
                                                labelMin: attrs["label-min"]
                                                attrs: attrs_without attrs "label-min"
                                        ]
                                        if key? attrs "label-max" [
                                                labelMax: attrs["label-max"]
                                                attrs: attrs_without attrs "label-max"
                                        ]
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "slider" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        bindName: "value"
                                        switch equal? arg0_type :word [
                                                bindName: to :string arg0
                                        ][
                                                bindName: "value"
                                        ]
                                        set_face_meta faces faceId #[
                                                bindName: bindName
                                                labelMin: labelMin
                                                labelMax: labelMax
                                        ]
                                        switch equal? arg0_type :word [
                                                add_binding bindings arg0
                                                arg0_str: to :string arg0
                                                sliderHtml: slider_field arg0_str attrs
                                                switch any? @[notEqual? labelMin null notEqual? labelMax null] [
                                                        wrapHtml: "<div class='vista-slider-wrap'>"
                                                        if notEqual? labelMin null [
                                                                labelMinStr: html_text labelMin
                                                                wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ labelMinStr ++ "</span>"
                                                        ]
                                                        wrapHtml: wrapHtml ++ sliderHtml
                                                        if notEqual? labelMax null [
                                                                labelMaxStr: html_text labelMax
                                                                wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ labelMaxStr ++ "</span>"
                                                        ]
                                                        wrapHtml: wrapHtml ++ "</div>"
                                                        html: html ++ wrapHtml
                                                        set_face_html faces faceId wrapHtml
                                                ][
                                                        html: html ++ sliderHtml
                                                        set_face_html faces faceId sliderHtml
                                                ]
                                        ][
                                                inputType: "range"
                                                if key? attrs "type" [
                                                        inputType: to :string attrs\type
                                                ]
                                                attrStr: attrs_to_html (attrs_without attrs "type")
                                                sliderHtml: "<input type='" ++ inputType ++ "' value='" ++ html_escape_attr (to :string arg0) ++ "'" ++ attrStr ++ ">"
                                                switch any? @[notEqual? labelMin null notEqual? labelMax null] [
                                                        wrapHtml: "<div class='vista-slider-wrap'>"
                                                        if notEqual? labelMin null [
                                                                labelMinStr: html_text labelMin
                                                                wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ labelMinStr ++ "</span>"
                                                        ]
                                                        wrapHtml: wrapHtml ++ sliderHtml
                                                        if notEqual? labelMax null [
                                                                labelMaxStr: html_text labelMax
                                                                wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ labelMaxStr ++ "</span>"
                                                        ]
                                                        wrapHtml: wrapHtml ++ "</div>"
                                                        html: html ++ wrapHtml
                                                        set_face_html faces faceId wrapHtml
                                                ][
                                                        html: html ++ sliderHtml
                                                        set_face_html faces faceId sliderHtml
                                                ]
                                        ]
                                ]
                                "rotary" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "rotary" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[bindName: arg0_str]
                                                        faceHtml: rotary_field arg0_str attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        set_face_meta faces faceId #[value: arg0]
                                                        faceHtml: rotary_field "value" attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "radio" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        switch equal? (type arg1) :block [
                                                                opts: arg1
                                                        ][
                                                                opts: [arg1]
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "radio" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: radio_group arg0_str attrs opts bindings
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: radio_group "value" attrs arg0 bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: radio_group "value" attrs [arg0] bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "radio-group" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        switch equal? (type arg1) :block [
                                                                opts: arg1
                                                        ][
                                                                opts: [arg1]
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "radio-group" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: radio_group arg0_str attrs opts bindings
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: radio_group "value" attrs arg0 bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: radio_group "value" attrs [arg0] bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "radio_group" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        switch equal? (type arg1) :block [
                                                                opts: arg1
                                                        ][
                                                                opts: [arg1]
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "radio-group" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: radio_group arg0_str attrs opts bindings
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: radio_group "value" attrs arg0 bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: radio_group "value" attrs [arg0] bindings
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "textarea" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if equal? args_len 0 [
                                                args: args ++ [""]
                                        ]
                                        arg0: get args 0
                                        arg0_type: type arg0
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "textarea" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        switch equal? arg0_type :word [
                                                add_binding bindings arg0
                                                arg0_str: to :string arg0
                                                set_face_meta faces faceId #[bindName: arg0_str]
                                                faceHtml: textarea_field arg0_str attrs null
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ][
                                                set_face_meta faces faceId #[value: arg0]
                                                faceHtml: textarea_field "value" attrs arg0
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "select" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        if [equal? (type arg1) :block [
                                                                opts: arg1
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "select" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: select_field arg0_str attrs opts
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: select_field "value" attrs arg0
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: select_field "value" attrs [arg0]
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "drop-list" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        if [equal? (type arg1) :block [
                                                                opts: arg1
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "drop-list" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: select_field arg0_str attrs opts
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: select_field "value" attrs arg0
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: select_field "value" attrs [arg0]
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "drop_list" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                opts: []
                                                if greater? args_len 1 [
                                                        arg1: get args 1
                                                        if [equal? (type arg1) :block [
                                                                opts: arg1
                                                        ]
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "drop-list" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        set_face_meta faces faceId #[
                                                                bindName: arg0_str
                                                                options: opts
                                                        ]
                                                        faceHtml: select_field arg0_str attrs opts
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        switch equal? arg0_type :block [
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: arg0
                                                                ]
                                                                faceHtml: select_field "value" attrs arg0
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ][
                                                                set_face_meta faces faceId #[
                                                                        bindName: "value"
                                                                        options: [arg0]
                                                                ]
                                                                faceHtml: select_field "value" attrs [arg0]
                                                                html: html ++ faceHtml
                                                                set_face_html faces faceId faceHtml
                                                        ]
                                                ]
                                        ]
                                ]
                                "image" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "image" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        attrStr: attrs_to_html attrs
                                                        faceHtml: "<img data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ ">"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: image_face arg0 attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "icon" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "icon" attrs ""
                                                attrs: with_face_id attrs faceId
                                                switch key? attrs "class" [
                                                        attrs\class: "vista-icon " ++ to :string attrs\class
                                                ][
                                                        attrs\class: "vista-icon"
                                                ]
                                                set_face_attrs_and_name faces faceId attrs
                                                faceHtml: image_face arg0 attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "anim" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "anim" attrs ""
                                                attrs: with_face_id attrs faceId
                                                switch key? attrs "class" [
                                                        attrs\class: "vista-anim " ++ to :string attrs\class
                                                ][
                                                        attrs\class: "vista-anim"
                                                ]
                                                set_face_attrs_and_name faces faceId attrs
                                                faceHtml: image_face arg0 attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "progress" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "progress" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :word [
                                                        add_binding bindings arg0
                                                        arg0_str: to :string arg0
                                                        attrStr: attrs_to_html attrs
                                                        faceHtml: "<progress data-bind='" ++ arg0_str ++ "'" ++ attrStr ++ "></progress>"
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: progress_face arg0 attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "tabs" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        selectedIndex: 0
                                        if key? attrs "selected" [
                                                selectedIndex: attrs\selected
                                                attrs: attrs_without attrs "selected"
                                        ]
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                tabsBlock: get args 0
                                                if [equal? (type tabsBlock) :block [
                                                        vista_state\tabs_id_counter: vista_state\tabs_id_counter + 1
                                                        tabIdBase: "tabs-" ++ to :string vista_state\tabs_id_counter
                                                        merged: merge_class_attr attrs "vista-tabs"
                                                        attrStr: attrs_to_html merged\attrs
                                                        selectedStr: to :string selectedIndex
                                                        htmlTabs: "<div class='" ++ merged\class ++ "' data-tabs='" ++ tabIdBase ++ "' data-tabs-selected='" ++ selectedStr ++ "'" ++ attrStr ++ ">"
                                                        htmlTabs: htmlTabs ++ "<div class='vista-tabs-bar'>"
                                                        htmlPanels: "<div class='vista-tabs-panels'>"
                                                        tlen: size tabsBlock
                                                        t: 0
                                                        tabIndex: 0
                                                        parentId: current_parent_id face_stack
                                                        faceId: register_face faces parentId "tabs" attrs ""
                                                        attrs: with_face_id attrs faceId
                                                        set_face_attrs_and_name faces faceId attrs
                                                        merged: merge_class_attr attrs "vista-tabs"
                                                        attrStr: attrs_to_html merged\attrs
                                                        selectedStr: to :string selectedIndex
                                                        htmlTabs: "<div class='" ++ merged\class ++ "' data-tabs='" ++ tabIdBase ++ "' data-tabs-selected='" ++ selectedStr ++ "'" ++ attrStr ++ ">"
                                                        while [less? t tlen][
                                                                tok: get tabsBlock t
                                                                if [equal? (type tok) :word [
                                                                        if [equal? (to :string tok) "tab" [
                                                                                t: t + 1
                                                                                if less? t tlen [
                                                                                        titleVal: get tabsBlock t
                                                                                        t: t + 1
                                                                                        bodyVal: null
                                                                                        if less? t tlen [
                                                                                                bodyVal: get tabsBlock t
                                                                                                t: t + 1
                                                                                        ]
                                                                                        tabKey: tabIdBase ++ "-" ++ to :string tabIndex
                                                                                        tabIndex: tabIndex + 1
                                                                                        titleHtml: ""
                                                                                        titleType: type titleVal
                                                                                        switch equal? titleType :word [
                                                                                                add_binding bindings titleVal
                                                                                                titleHtml: "<span data-bind='" ++ to :string titleVal ++ "'></span>"
                                                                                        ][
                                                                                                titleHtml: html_text titleVal
                                                                                        ]
                                                                                        btnFaceId: register_face faces faceId "tab-button" #[ ] ""
                                                                                        btnAttrs: with_face_id #[] btnFaceId
                                                                                        set_face_attrs_and_name faces btnFaceId btnAttrs
                                                                                        btnAttrStr: attrs_to_html btnAttrs
                                                                                        btnHtml: "<button class='vista-tab-btn' data-tab='" ++ tabKey ++ "'" ++ btnAttrStr ++ ">" ++ titleHtml ++ "</button>"
                                                                                        set_face_html faces btnFaceId btnHtml
                                                                                        htmlTabs: htmlTabs ++ btnHtml
                                                                                        panelHtml: ""
                                                                                        switch equal? (type bodyVal) :block [
                                                                                                inner: layout_state bodyVal
                                                                                                merge_bindings bindings inner\bindings
                                                                                                merge_faces faces inner\faces
                                                                                                append_children_from_root faces faceId inner\root
                                                                                                panelHtml: inner\html
                                                                                        ][
                                                                                                panelHtml: html_text bodyVal
                                                                                        ]
                                                                                        panelFaceId: register_face faces faceId "tab-panel" #[] ""
                                                                                        panelAttrs: with_face_id #[] panelFaceId
                                                                                        set_face_attrs_and_name faces panelFaceId panelAttrs
                                                                                        panelAttrStr: attrs_to_html panelAttrs
                                                                                        panelHtmlOut: "<div class='vista-tab-panel' data-tab='" ++ tabKey ++ "'" ++ panelAttrStr ++ ">" ++ panelHtml ++ "</div>"
                                                                                        set_face_html faces panelFaceId panelHtmlOut
                                                                                        htmlPanels: htmlPanels ++ panelHtmlOut
                                                                                ]
                                                                        ][
                                                                                t: t + 1
                                                                        ]
                                                                ][
                                                                        t: t + 1
                                                                ]
                                                        ]
                                                        htmlTabs: htmlTabs ++ "</div>" ++ htmlPanels ++ "</div></div>"
                                                        set_face_html faces faceId htmlTabs
                                                        html: html ++ htmlTabs
                                                ]
                                        ]
                                ]
                                "text-list" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "text-list" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :block [
                                                        faceHtml: text_list_bind arg0 bindings attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: text_list_bind [arg0] bindings attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "text_list" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                arg0: get args 0
                                                arg0_type: type arg0
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "text-list" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                switch equal? arg0_type :block [
                                                        faceHtml: text_list_bind arg0 bindings attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ][
                                                        faceHtml: text_list_bind [arg0] bindings attrs
                                                        html: html ++ faceHtml
                                                        set_face_html faces faceId faceHtml
                                                ]
                                        ]
                                ]
                                "list" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                bindName: "value"
                                                items: []
                                                switch equal? (type (get args 0)) :word [
                                                        bindName: to :string (get args 0)
                                                        add_binding bindings (get args 0)
                                                        if greater? args_len 1 [
                                                                if [equal? (type (get args 1)) :block [
                                                                        items: get args 1
                                                                ]
                                                        ]
                                                ][
                                                        switch equal? (type (get args 0)) :block [
                                                                items: get args 0
                                                        ][
                                                                items: [get args 0]
                                                        ]
                                                ]
                                                multi: false
                                                if key? attrs "multi" [
                                                        multi: attrs\multi
                                                        attrs: attrs_without attrs "multi"
                                                ]
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "list" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                set_face_meta faces faceId #[
                                                        bindName: bindName
                                                        options: items
                                                        multi: multi
                                                ]
                                                faceHtml: list_face_bind items bindName multi bindings attrs
                                                html: html ++ faceHtml
                                                set_face_html faces faceId faceHtml
                                        ]
                                ]
                                "table" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-row" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-row" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_row_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_row" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-row" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_row_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-header" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-header" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_header_cell_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_header" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-header" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_header_cell_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-cell" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-cell" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_cell_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_cell" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-cell" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_cell_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-head" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-head" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_head_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_head" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-head" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_head_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-body" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-body" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_body_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_body" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-body" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_body_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table-foot" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-foot" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_foot_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "table_foot" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "table-foot" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_inner (get args 0) bindings faces faceId
                                                faceHtml: table_foot_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "toolbar" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "toolbar" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: toolbar_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "menubar" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "menubar" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: menubar_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "tool-group" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "tool-group" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: tool_group_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "tool_group" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        if greater? args_len 0 [
                                                parentId: current_parent_id face_stack
                                                faceId: register_face faces parentId "tool-group" attrs ""
                                                attrs: with_face_id attrs faceId
                                                set_face_attrs_and_name faces faceId attrs
                                                bodyHtml: render_block_or_string (get args 0) bindings faces faceId
                                                faceHtml: tool_group_face bodyHtml attrs
                                                set_face_html faces faceId faceHtml
                                                html: html ++ faceHtml
                                        ]
                                ]
                                "canvas" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        drawBlock: null
                                        if greater? (size args) 0 [
                                                if [equal? (type (get args 0)) :block [
                                                        drawBlock: normalize_block (get args 0)
                                                ]
                                        ]
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "canvas" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        if notEqual? drawBlock null [
                                                set_face_meta faces faceId #[draw: drawBlock]
                                        ]
                                        faceHtml: canvas_face attrs
                                        html: html ++ faceHtml
                                        set_face_html faces faceId faceHtml
                                ]
                                "divider" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "divider" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        faceHtml: divider_face attrs
                                        html: html ++ faceHtml
                                        set_face_html faces faceId faceHtml
                                ]
                                "split" -> [
                                        info: parse_args_from block (i + 1)
                                        i: info\next
                                        attrs: prepare_attrs info\attrs bindings
                                        args: info\args
                                        args_len: size args
                                        ratio: null
                                        orientation: "horizontal"
                                        if key? attrs "ratio" [
                                                ratio: attrs\ratio
                                                attrs: attrs_without attrs "ratio"
                                        ]
                                        if key? attrs "orientation" [
                                                orientation: to :string attrs\orientation
                                                attrs: attrs_without attrs "orientation"
                                        ]
                                        leftHtml: ""
                                        rightHtml: ""
                                        parentId: current_parent_id face_stack
                                        faceId: register_face faces parentId "split" attrs ""
                                        attrs: with_face_id attrs faceId
                                        set_face_attrs_and_name faces faceId attrs
                                        if greater? args_len 0 [
                                                leftVal: get args 0
                                                leftHtml: render_block_or_string leftVal bindings faces faceId
                                        ]
                                        if greater? args_len 1 [
                                                rightVal: get args 1
                                                rightHtml: render_block_or_string rightVal bindings faces faceId
                                        ]
                                        set_face_meta faces faceId #[
                                                ratio: ratio
                                                orientation: orientation
                                        ]
                                        if equal? orientation "vertical" [
                                                switch key? attrs "class" [
                                                        attrs\class: "vista-split-vertical " ++ to :string attrs\class
                                                ][
                                                        attrs\class: "vista-split-vertical"
                                                ]
                                        ]
                                        faceHtml: split_face leftHtml rightHtml attrs ratio
                                        set_face_html faces faceId faceHtml
                                        html: html ++ faceHtml
                                ]
                                any -> [
                                        i: i + 1
                                ]
                        ]
                ]
                ][
                        i: i + 1
                ]
        ]
        while [greater? open_divs 0][
                html: html ++ "</div>"
                open_divs: open_divs - 1
        ]
        html: html ++ "</div>" ; close root
        set_face_html faces root_id html
        vista_state\layout_pending_attrs: prev_pending
        vista_state\layout_scope_stack: prev_scope_stack
        #[
                html: html
                bindings: bindings
                faces: faces
                root: root_id
        ]
]
; Layout function: parse block into HTML
layout: function [block] [
        result: layout_state block
        result\html
]

build_full_html: function [layoutBlock] [
    vista_state\face_counter: 0
    vista_state\face_names: #[]
    result: layout_state layoutBlock
    vista_state\last_faces: result\faces
    vista_state\last_root: result\root
    vista_state\last_bindings: result\bindings
    htmlContent: result\html
    script: render_script result\bindings
    tabsScript: tabs_script
    menuScript: menubar_script
    tableScript: table_script
    reloadScript: auto_reload_script
    bodyOpen: "<body>"
    if vista_vid_mode [
        bodyOpen: "<body class='vista-vid'>"
    ]
    css: vista_css
    if vista_vid_mode [
        css: css ++ vista_vid_css
    ]
    html: "<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>"
    html: html ++ "<title>" ++ webview_title ++ "</title><style>" ++ css ++ "</style></head>"
    appTitle: html_escape_text webview_title
    titleHtml: ""
    if not? equal? appTitle "ARTURO/VISTA" [
        titleHtml: "<div class='vista-app-title'>" ++ appTitle ++ "</div>"
    ]
    logoHtml: ""
    if not? any? @[equal? vista_app_logo_path null equal? vista_app_logo_path ""] [
        logoSrc: html_escape_attr (logo_data_url (to :string vista_app_logo_path))
        logoHtml: "<img class='vista-app-logo' src='" ++ logoSrc ++ "' alt='ARTURO'>"
    ]
    appHeader: "<header class='vista-app-header'><div class='vista-app-header-inner'>" ++ logoHtml ++ "<div class='vista-app-mark'>ARTURO/VISTA</div>" ++ titleHtml ++ "</div></header>"
    html: html ++ bodyOpen
    html: html ++ appHeader
    canvasScript: ""
    facesKeys: keys vista_state\last_faces
    fk_len: size facesKeys
    fi: 0
    while [less? fi fk_len] [
        fid: get facesKeys fi
        face: vista_state\last_faces\[fid]
        if equal? face\type "canvas" [
            canvasScript: canvasScript ++ canvas_draw_script face
        ]
        fi: fi + 1
    ]
    html: html ++ "<main class='vista-app-body'>" ++ htmlContent ++ "</main>"
    html: html ++ script
    html: html ++ tabsScript
    html: html ++ menuScript
    html: html ++ tableScript
    html: html ++ canvasScript
    html: html ++ reloadScript
    html: html ++ "</body></html>"
    html
]

show: function [face] [
    ftype: type face
    switch equal? ftype :dictionary [
        if key? face "html" [
            if webview_sync_updates [
                js: "window.vistaShow('" ++ face\id ++ "','" ++ js_escape_single face\html ++ "');"
                webview .inject: js ""
            ]
            return face\html
        ]
    ][
        switch equal? ftype :word [
            name: to :string face
            f: get_face name
            if notEqual? f null [
                if webview_sync_updates [
                    js: "window.vistaShow('" ++ f\id ++ "','" ++ js_escape_single f\html ++ "');"
                    webview .inject: js ""
                ]
                return f\html
            ]
        ][
            switch equal? ftype :string [
                f: get_face face
                if notEqual? f null [
                    if webview_sync_updates [
                        js: "window.vistaShow('" ++ f\id ++ "','" ++ js_escape_single f\html ++ "');"
                        webview .inject: js ""
                    ]
                    return f\html
                ]
            ][
                null
            ]
        ]
    ]
    null
]

get_face: function [id] [
    idType: type id
    idStr: ""
    switch equal? idType :word [
        idStr: to :string id
    ][
        switch equal? idType :string [
            idStr: id
        ][
            switch equal? idType :dictionary [
                if key? id "id" [
                    idStr: id\id
                ]
            ][
                idStr: ""
            ]
        ]
    ]
    if notEqual? idStr "" [
        if key? vista_state\face_names idStr [
            idStr: vista_state\face_names\[idStr]
        ]
        if key? vista_state\last_faces idStr [
            return vista_state\last_faces\[idStr]
        ]
    ]
    null
]

render_face_text: function [face] [
    textVal: html_text face\text
    attrs: face\attrs
    attrs: maybe_autosize_text_attrs attrs
    attrStr: attrs_to_html attrs
    do case face\type [
        "text" -> ["<span" ++ attrStr ++ ">" ++ textVal ++ "</span>"]
        "label" -> ["<label" ++ attrStr ++ ">" ++ textVal ++ "</label>"]
        "title" -> [
            merged: merge_class_attr attrs "vista-title"
            attrStr: attrs_to_html merged\attrs
            "<h1 class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ textVal ++ "</h1>"
        ]
        "subtitle" -> [
            merged: merge_class_attr attrs "vista-subtitle"
            attrStr: attrs_to_html merged\attrs
            "<h2 class='" ++ merged\class ++ "'" ++ attrStr ++ ">" ++ textVal ++ "</h2>"
        ]
        any -> [face\html]
    ]
]

render_face: function [face] [
    meta: #[]
    if key? face "meta" [
        meta: face\meta
    ]
    do case face\type [
        "text" -> [render_face_text face]
        "label" -> [render_face_text face]
        "title" -> [render_face_text face]
        "subtitle" -> [render_face_text face]
        "field" -> [
            inputType: "text"
            if key? face\attrs "type" [
                inputType: to :string face\attrs\type
            ]
            attrStr: attrs_to_html (attrs_without face\attrs "type")
            valueStr: ""
            if key? meta "value" [
                valueStr: " value='" ++ html_escape_attr (to :string meta\value) ++ "'"
            ]
            "<input type='" ++ inputType ++ "'" ++ valueStr ++ attrStr ++ ">"
        ]
        "info" -> [
            attrStr: attrs_to_html face\attrs
            valueStr: ""
            if key? meta "value" [
                valueStr: " value='" ++ html_escape_attr (to :string meta\value) ++ "'"
            ]
            "<input type='text' readonly" ++ valueStr ++ attrStr ++ ">"
        ]
        "input" -> [
            inputType: "text"
            if key? face\attrs "type" [
                inputType: to :string face\attrs\type
            ]
            attrStr: attrs_to_html (attrs_without face\attrs "type")
            valueStr: ""
            if key? meta "value" [
                valueStr: " value='" ++ html_escape_attr (to :string meta\value) ++ "'"
            ]
            "<input type='" ++ inputType ++ "'" ++ valueStr ++ attrStr ++ ">"
        ]
        "textarea" -> [
            attrStr: attrs_to_html face\attrs
            switch key? meta "value" [
                "<textarea" ++ attrStr ++ ">" ++ html_escape_attr (to :string meta\value) ++ "</textarea>"
            ][
                "<textarea" ++ attrStr ++ "></textarea>"
            ]
        ]
        "image" -> [
            attrStr: attrs_to_html face\attrs
            "<img" ++ attrStr ++ ">"
        ]
        "icon" -> [
            attrStr: attrs_to_html face\attrs
            "<img" ++ attrStr ++ ">"
        ]
        "anim" -> [
            attrStr: attrs_to_html face\attrs
            "<img" ++ attrStr ++ ">"
        ]
        "progress" -> [
            attrStr: attrs_to_html face\attrs
            "<progress" ++ attrStr ++ "></progress>"
        ]
        "button" -> [
            labelHtml: ""
            action: ""
            if key? meta "labelHtml" [
                labelHtml: meta\labelHtml
            ]
            if key? meta "action" [
                action: meta\action
            ]
            attrs: maybe_autosize_text_attrs face\attrs
            button labelHtml action attrs
        ]
        "key" -> [
            labelHtml: ""
            bindName: ""
            if key? meta "labelHtml" [ labelHtml: meta\labelHtml ]
            if key? meta "bindName" [ bindName: meta\bindName ]
            key_button labelHtml bindName face\attrs
        ]
        "checkbox" -> [
            labelHtml: ""
            bindName: ""
            if key? meta "labelHtml" [ labelHtml: meta\labelHtml ]
            if key? meta "bindName" [ bindName: meta\bindName ]
            checkbox labelHtml bindName face\attrs
        ]
        "toggle" -> [
            labelHtml: ""
            bindName: ""
            if key? meta "labelHtml" [ labelHtml: meta\labelHtml ]
            if key? meta "bindName" [ bindName: meta\bindName ]
            toggle labelHtml bindName face\attrs
        ]
        "select" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            opts: []
            if key? meta "options" [ opts: meta\options ]
            select_field bindName face\attrs opts
        ]
        "drop-list" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            opts: []
            if key? meta "options" [ opts: meta\options ]
            select_field bindName face\attrs opts
        ]
        "radio" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            opts: []
            if key? meta "options" [ opts: meta\options ]
            radio_group bindName face\attrs opts #[]
        ]
        "radio-group" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            opts: []
            if key? meta "options" [ opts: meta\options ]
            radio_group bindName face\attrs opts #[]
        ]
        "list" -> [
            bindName: "value"
            opts: []
            multi: false
            if key? meta "bindName" [ bindName: meta\bindName ]
            if key? meta "options" [ opts: meta\options ]
            if key? meta "multi" [ multi: meta\multi ]
            list_face_bind opts bindName multi #[ ] face\attrs
        ]
        "slider" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            labelMin: null
            labelMax: null
            if key? meta "labelMin" [ labelMin: meta\labelMin ]
            if key? meta "labelMax" [ labelMax: meta\labelMax ]
            sliderHtml: slider_field bindName face\attrs
            switch any? @[notEqual? labelMin null notEqual? labelMax null] [
                wrapHtml: "<div class='vista-slider-wrap'>"
                if notEqual? labelMin null [
                    wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ html_text labelMin ++ "</span>"
                ]
                wrapHtml: wrapHtml ++ sliderHtml
                if notEqual? labelMax null [
                    wrapHtml: wrapHtml ++ "<span class='vista-slider-label'>" ++ html_text labelMax ++ "</span>"
                ]
                wrapHtml ++ "</div>"
            ][
                sliderHtml
            ]
        ]
        "rotary" -> [
            bindName: "value"
            if key? meta "bindName" [ bindName: meta\bindName ]
            rotary_field bindName face\attrs
        ]
        "box" -> [box (face_children_html face) face\attrs]
        "panel" -> [
            titleHtml: ""
            if key? meta "titleHtml" [ titleHtml: meta\titleHtml ]
            panel_face titleHtml (face_children_html face) face\attrs
        ]
        "grid" -> [
            cols: 2
            if key? meta "cols" [ cols: meta\cols ]
            grid_face (face_children_html face) face\attrs cols
        ]
        "row" -> [row (face_children_html face) face\attrs]
        "col" -> [col (face_children_html face) face\attrs]
        "group" -> [group (face_children_html face) face\attrs]
        "sensor" -> [sensor_face (face_children_html face) face\attrs]
        "table" -> [table_face (face_children_html face) face\attrs]
        "table-row" -> [table_row_face (face_children_html face) face\attrs]
        "table-cell" -> [table_cell_face (face_children_html face) face\attrs]
        "table-head" -> [table_head_face (face_children_html face) face\attrs]
        "table-body" -> [table_body_face (face_children_html face) face\attrs]
        "table-foot" -> [table_foot_face (face_children_html face) face\attrs]
        "table-header" -> [table_header_cell_face (face_children_html face) face\attrs]
        "toolbar" -> [toolbar_face (face_children_html face) face\attrs]
        "menubar" -> [menubar_face (face_children_html face) face\attrs]
        "tool-group" -> [tool_group_face (face_children_html face) face\attrs]
        "split" -> [
            ratio: null
            if key? meta "ratio" [ ratio: meta\ratio ]
            leftHtml: face_child_html face 0
            rightHtml: face_child_html face 1
            split_face leftHtml rightHtml face\attrs ratio
        ]
        "canvas" -> [canvas_face face\attrs]
        "divider" -> [divider_face face\attrs]
        any -> [face\html]
    ]
]

update_face: function [id updates] [
    face: get_face id
    if equal? face null [
        return null
    ]
    if key? updates "attrs" [
        face\attrs: updates\attrs
        if not? key? face\attrs "data-face-id" [
            face\attrs\["data-face-id"]: face\id
        ]
        if key? face\attrs "id" [
            nameStr: to :string face\attrs\id
            vista_state\face_names\[nameStr]: face\id
        ]
    ]
    if key? updates "text" [
        face\text: updates\text
        if any? @[equal? face\type "button" equal? face\type "checkbox" equal? face\type "toggle"] [
            if not? key? face "meta" [
                face\meta: #[]
            ]
            face\meta\labelHtml: html_text updates\text
        ]
        face\html: render_face face
    ]
    if key? updates "html" [
        face\html: updates\html
    ]
    if key? updates "attrs" [
        face\html: render_face face
    ]
    vista_state\last_faces\[face\id]: face
    if webview_sync_updates [
        js: "window.vistaShow('" ++ face\id ++ "','" ++ js_escape_single face\html ++ "');"
        if webview_enabled [
            env_vars: env
            if not? any? @[key? env_vars "VISTA_NO_WEBVIEW" key? env_vars "NO_WEBVIEW"] [
                webview .inject: js ""
            ]
        ]
    ]
    face
]

; View function: generate full HTML and serve
view: function [layoutBlock] [
    apply_arturo_header
    fullHtml: build_full_html layoutBlock
    if attr? "returnHtml" [
        return fullHtml
    ]
    noWebview: false
    if attr? "noWebview" [
        noWebview: true
    ]
    env_vars: env
    if key? env_vars "VISTA_NO_WEBVIEW" [
        noWebview: true
    ]
    if key? env_vars "NO_WEBVIEW" [
        noWebview: true
    ]
    if not? webview_enabled [
        noWebview: true
    ]
    filePath: attr "file"
    if any? @[greater? webview_state_sync_ms 0 webview_state_sync_from_ui] [
        if not? noWebview [
            serve.port: 18967 [
                GET "/vista-sync" [ write.json vista_state\last_bindings "" ]
                POST "/vista-state" [
                    data: read.json body
                    apply_state_from_ui data
                    ""
                ]
            ]
        ]
    ]
    switch notEqual? filePath null [
        pathStr: to :string filePath
        absPath: relative pathStr
        write fullHtml absPath
        if noWebview [
            return fullHtml
        ]
        webview fullHtml
    ][
        write fullHtml "ui.html"
        if noWebview [
            return fullHtml
        ]
        webview fullHtml
    ]
]

vid: function [layoutBlock] [
    prev: vista_vid_mode
    vista_vid_mode: true
    result: null
    switch attr? "returnHtml" [
        result: view .returnHtml layoutBlock
    ][
        switch attr? "file" [
            path: attr "file"
            switch attr? "noWebview" [
                result: view .file:path .noWebview layoutBlock
            ][
                result: view .file:path layoutBlock
            ]
        ][
            switch attr? "noWebview" [
                result: view .noWebview layoutBlock
            ][
                result: view layoutBlock
            ]
        ]
    ]
    vista_vid_mode: prev
    result
]
