; Security smoke checks for v2 auth/security framework.
; Usage: arturo tests/security-smoke.art

base_url: "http://localhost:18969"

http_request: function [method path] [
    url: base_url ++ path
    cmd: "curl -sS -X " ++ method ++ " \"" ++ url ++ "\" -w \"\\n__STATUS__:%{http_code}\""
    res: execute.code cmd
    if not? equal? res\code 0 [
        return #[ok:false status:0 body:to :string res\output error:"curl_failed"]
    ]
    raw: to :string res\output
    marker: "\n__STATUS__:"
    pos: index raw marker
    if equal? pos null [
        return #[ok:false status:0 body:raw error:"missing_status_marker"]
    ]
    #[
        ok: true
        status: to :integer strip slice raw (pos + size marker) (size raw)
        body: slice raw 0 pos
        error: ""
    ]
]

request_json: function [method path] [
    r: http_request method path
    parsed: null
    if error? err: <= try [parsed: read.json r\body] [parsed: null]
    #[ok:r\ok status:r\status body:r\body json:parsed]
]

assert_true: function [cond msg] [
    if not? cond [
        print ["FAIL" msg]
        do "securitysmokefailed"
    ]
    print ["PASS" msg]
]

b64url_json: function [jsonText] [
    t: encode.base64 jsonText
    t: replace t "+" "-"
    t: replace t "/" "_"
    replace t "=" ""
]

stamp: strip execute "date +%s"
client: "sec-client-" ++ stamp
email: "sec" ++ stamp ++ "@example.com"
pass: "Password123abc"

csrf_resp: request_json "GET" ("/api/v2/security/csrf/" ++ client)
assert_true (equal? csrf_resp\status 200) "csrf token status"
csrf: to :string csrf_resp\json\data\token
assert_true (not? equal? csrf "") "csrf token present"

payload: b64url_json ("{\"email\":\"" ++ email ++ "\",\"password\":\"" ++ pass ++ "\"}")

signup: request_json "POST" ("/api/v2/auth/signup/" ++ client ++ "/" ++ csrf ++ "/" ++ payload)
assert_true (equal? signup\status 200) "v2 signup status"

login: request_json "POST" ("/api/v2/auth/login/" ++ client ++ "/" ++ csrf ++ "/" ++ payload)
assert_true (equal? login\status 200) "v2 login status"

token: to :string login\json\data\token
assert_true (not? equal? token "") "v2 login token present"

; CSRF mismatch should fail
bad_csrf: request_json "POST" ("/api/v2/auth/login/" ++ client ++ "/badcsrf/" ++ payload)
assert_true (equal? bad_csrf\json\error\code "invalid_csrf") "csrf mismatch rejected"

; Trigger v2 login rate limit (limit configured 40/min)
i: 0
limited: false
while [less? i 45] [
    r: request_json "POST" ("/api/v2/auth/login/" ++ client ++ "/" ++ csrf ++ "/" ++ payload)
    if not? equal? r\json null [
        if not? r\json\ok [
            if all? @[key? r\json "error" key? r\json\error "code" equal? r\json\error\code "rate_limited"] [
                limited: true
                i: 99
            ]
        ]
    ]
    i: i + 1
]
assert_true limited "v2 login rate limit enforced"

print "Security smoke completed"
